<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VibeClaw Forge — Build Your OpenClaw Server | vibeclaw</title>
  <meta name="description" content="Visual server builder for OpenClaw. Configure agents, skills, and personality — then preview it live in your browser. Export, deploy, or download your custom AI agent server." />
  <meta name="keywords" content="openclaw, server builder, ai agent, configuration, no-code, visual builder, vibeclaw">
  <meta name="author" content="vibeclaw">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://vibeclaw.dev/forge.html">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://vibeclaw.dev/forge.html">
  <meta property="og:title" content="VibeClaw Forge — Build Your OpenClaw Server">
  <meta property="og:description" content="Visual server builder for OpenClaw. Configure agents, skills, and personality — preview live in your browser.">
  <meta property="og:image" content="https://vibeclaw.dev/og-image.png">
  <meta property="og:site_name" content="vibeclaw.dev">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@vibeclaw">
  <meta name="twitter:creator" content="@jasonkneen">
  <meta name="twitter:title" content="VibeClaw Forge — Build Your OpenClaw Server">
  <meta name="twitter:description" content="Visual server builder for OpenClaw. Configure, preview, and deploy custom AI agent servers.">
  <meta name="twitter:image" content="https://vibeclaw.dev/og-image.png">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff5c5c' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><path d='M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z'/></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap&font-display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #0a0a0a;
      --surface: #141414;
      --surface-2: #1a1a1a;
      --border: #2a2a2a;
      --border-active: #3a3a3a;
      --text: #999;
      --text-dim: #666;
      --text-bright: #e0e0e0;
      --accent: #ff5c5c;
      --accent-bg: rgba(255,92,92,0.06);
      --accent-glow: rgba(255,92,92,0.15);
      --green: #4ade80;
      --blue: #60a5fa;
      --sans: 'DM Sans', system-ui, sans-serif; --code: 'JetBrains Mono', 'SF Mono', 'Menlo', monospace;
      --mono: 'Fragment Mono', 'JetBrains Mono', 'Menlo', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: var(--black);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ── Nav ── */
    .nav {
      position: sticky; top: 0; z-index: 100;
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 32px;
      background: rgba(10,10,10,0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .nav-brand {
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-bright);
    }
    .nav-links { display: flex; gap: 32px; align-items: center; }
    .nav-links a {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--text);
      text-decoration: none;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .nav-links a:hover { color: var(--text-bright); }
    @media (max-width: 600px) {
      .nav { padding: 10px 12px; }
      .nav-brand img { height: 28px !important; }
      .nav-links { gap: 10px; }
      .nav-links a { font-size: 0.6rem; }
      #auth-container, #upgrade-container { margin-left: 2px !important; }
      .auth-login-btn { padding: 3px 6px !important; font-size: 0.55rem !important; }
      .auth-login-btn svg { width: 9px !important; height: 9px !important; }
      .auth-user { gap: 4px !important; }
      .auth-avatar { width: 18px !important; height: 18px !important; }
      .auth-name { max-width: 50px !important; font-size: 0.55rem !important; }
      .auth-logout-btn { padding: 2px 4px !important; font-size: 0.5rem !important; }
    }

    @media (max-width: 380px) {
      .auth-text { display: none; }
      .auth-login-btn { padding: 3px 5px !important; }
      .auth-name { display: none; }
      .auth-logout-btn { font-size: 0.45rem !important; padding: 2px 3px !important; }
    }

    /* ── Layout ── */
    .forge-layout {
      display: grid;
      grid-template-columns: 1fr 340px;
      max-width: 1400px;
      margin: 0 auto;
      gap: 0;
      min-height: calc(100vh - 60px);
    }

    /* ── Main configurator ── */
    .forge-main {
      padding: 48px 48px 120px;
      overflow-y: auto;
    }
    .forge-title {
      font-family: var(--sans);
      font-size: 2.6rem;
      font-weight: 700;
      color: var(--text-bright);
      margin-bottom: 10px;
    }
    .forge-subtitle {
      font-size: 1.15rem;
      color: var(--text);
      margin-bottom: 48px;
    }

    /* ── Steps ── */
    .step {
      margin-bottom: 56px;
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .step-num {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    .step-title {
      font-family: var(--sans);
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-bright);
    }
    .step-desc {
      font-size: 0.95rem;
      color: var(--text-dim);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    /* ── Option cards (radio-style) ── */
    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .option-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .option-card:hover {
      border-color: var(--border-active);
      background: var(--surface-2);
    }
    .option-card.selected {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    .option-card .option-icon {
      margin-bottom: 10px;
    }
    .option-card .option-icon svg {
      width: 28px;
      height: 28px;
      color: var(--text-dim);
      transition: color 0.2s;
    }
    .option-card.selected .option-icon svg {
      color: var(--accent);
    }
    .option-card .option-name {
      font-family: var(--sans);
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-bright);
      margin-bottom: 4px;
    }
    .option-card .option-desc {
      font-size: 0.8rem;
      color: var(--text-dim);
      line-height: 1.5;
    }

    /* ── Agent builder ── */
    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .agent-row {
      display: grid;
      grid-template-columns: 40px 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
    }
    .agent-row.active {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    .agent-emoji-input {
      width: 36px;
      height: 36px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-align: center;
      font-size: 1.2rem;
      color: var(--text-bright);
      outline: none;
    }
    .agent-emoji-input:focus { border-color: var(--accent); }
    .agent-text-input {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--text-bright);
      outline: none;
    }
    .agent-text-input:focus { border-color: var(--accent); }
    .agent-text-input::placeholder { color: var(--text-dim); }

    .btn-small {
      font-family: var(--mono);
      font-size: 0.7rem;
      padding: 8px 14px;
      min-height: 44px;
      min-width: 44px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-small:hover { border-color: var(--accent); color: var(--accent); }
    .btn-small.danger:hover { border-color: #f44; color: #f44; }

    .btn-add {
      font-family: var(--mono);
      font-size: 0.75rem;
      padding: 10px 16px;
      border-radius: 8px;
      border: 2px dashed var(--border);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      width: 100%;
      text-align: center;
      transition: all 0.15s;
      margin-top: 8px;
    }
    .btn-add:hover { border-color: var(--accent); color: var(--accent); }

    /* ── Skill toggles ── */
    .skill-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }
    .skill-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      user-select: none;
    }
    .skill-card:hover { border-color: var(--border-active); }
    .skill-card.enabled { border-color: var(--accent); background: var(--accent-bg); }
    .skill-card .skill-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .skill-card .skill-icon svg {
      width: 20px;
      height: 20px;
      color: var(--text-dim);
      transition: color 0.2s;
    }
    .skill-card.enabled .skill-icon svg {
      color: var(--accent);
    }
    .skill-card .skill-name {
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-bright);
    }
    .skill-card .skill-desc {
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    .skill-toggle {
      margin-left: auto;
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--border);
      background: transparent;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .skill-card.enabled .skill-toggle {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* ── Textarea ── */
    .forge-textarea {
      width: 100%;
      min-height: 120px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--text-bright);
      outline: none;
      resize: vertical;
      line-height: 1.6;
    }
    .forge-textarea:focus { border-color: var(--accent); }
    .forge-textarea::placeholder { color: var(--text-dim); }

    /* ── Model select ── */
    .model-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 10px;
    }
    .model-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .model-card:hover { border-color: var(--border-active); }
    .model-card.selected { border-color: var(--accent); background: var(--accent-bg); }
    .model-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }
    .model-icon {
      width: 20px;
      height: 20px;
      color: var(--text-dim);
      flex-shrink: 0;
      transition: color 0.2s;
    }
    .model-card.selected .model-icon {
      color: var(--accent);
    }
    .model-name {
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-bright);
    }
    .model-provider {
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .model-badge {
      display: inline-block;
      font-family: var(--mono);
      font-size: 0.6rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--green);
      color: #000;
      font-weight: 700;
      margin-top: 6px;
    }

    /* ── Sidebar ── */
    .forge-sidebar {
      position: sticky;
      top: 60px;
      height: calc(100vh - 60px);
      border-left: 1px solid var(--border);
      background: var(--surface);
      padding: 32px 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .sidebar-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      margin-bottom: 16px;
    }
    .sidebar-server-name {
      font-family: var(--sans);
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-bright);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar-section {
      margin-bottom: 20px;
    }
    .sidebar-label {
      font-family: var(--mono);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    .sidebar-value {
      font-size: 0.85rem;
      color: var(--text-bright);
    }
    .sidebar-list {
      list-style: none;
    }
    .sidebar-list li {
      font-size: 0.8rem;
      color: var(--text);
      padding: 3px 0;
    }
    .sidebar-actions {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    .btn-forge {
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 700;
      padding: 14px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .btn-preview {
      background: var(--accent);
      color: #000;
    }
    .btn-preview:hover { background: #ff7070; }
    .btn-deploy {
      background: var(--surface-2);
      color: var(--text-bright);
      border: 1px solid var(--border);
    }
    .btn-deploy:hover { border-color: var(--accent); color: var(--accent); }
    .btn-save {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-save:hover { border-color: var(--text-dim); color: var(--text-bright); }

    /* ── Workspace files ── */
    .file-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
      overflow-x: auto;
    }
    .file-tab {
      font-family: var(--mono);
      font-size: 0.72rem;
      padding: 10px 16px;
      color: var(--text-dim);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
      white-space: nowrap;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .file-tab:hover { color: var(--text-bright); }
    .file-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* ── Template picker ── */
    .template-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .template-bar label {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }
    .template-select {
      flex: 1;
      min-width: 0;
      max-width: 100%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--text-bright);
      outline: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .template-select:focus { border-color: var(--accent); }

    /* ── Server name input ── */
    .server-name-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 32px;
    }
    .server-name-row input {
      flex: 1;
    }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      padding: 32px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .modal-title {
      font-family: var(--sans);
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-bright);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: color 0.15s;
    }
    .modal-close:hover { color: var(--text-bright); }
    .modal-desc {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 24px;
    }

    .deploy-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .deploy-option {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .deploy-option:hover {
      border-color: var(--accent);
      background: var(--accent-bg);
    }
    .deploy-option.deploy-provider {
      opacity: 0.6;
      cursor: default;
    }
    .deploy-option.deploy-provider:hover {
      border-color: var(--border);
      background: var(--black);
    }
    .deploy-icon {
      flex-shrink: 0;
    }
    .deploy-icon svg {
      width: 24px;
      height: 24px;
      color: var(--text-dim);
    }
    .deploy-option:hover .deploy-icon svg {
      color: var(--accent);
    }
    .deploy-option.deploy-provider:hover .deploy-icon svg {
      color: var(--text-dim);
    }
    .deploy-info { flex: 1; }
    .deploy-name {
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-bright);
      margin-bottom: 2px;
    }
    .deploy-desc {
      font-size: 0.72rem;
      color: var(--text-dim);
    }
    .deploy-badge {
      font-family: var(--mono);
      font-size: 0.6rem;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .deploy-divider {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 12px 0 4px;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }

    .command-label {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      margin: 16px 0 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .command-box {
      display: flex;
      align-items: center;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      gap: 12px;
    }
    .command-box code {
      flex: 1;
      font-family: var(--mono);
      font-size: 0.78rem;
      color: var(--accent);
      word-break: break-all;
      user-select: all;
    }
    .command-copy {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      cursor: pointer;
      color: var(--text-dim);
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .command-copy:hover { border-color: var(--accent); color: var(--accent); }

    /* ── Toast notifications ── */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 24px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--text-bright);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .toast.success {
      border-color: var(--green);
      background: rgba(74,222,128,0.05);
      color: var(--green);
    }
    .toast.error {
      border-color: #f44;
      background: rgba(255,68,68,0.05);
      color: #f44;
    }

    /* ── Left Preview Chat Panel ── */
    .forge-preview-chat {
      position: fixed;
      top: 60px;
      left: 0;
      bottom: 0;
      width: 380px;
      display: none;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
      z-index: 200;
      box-shadow: 4px 0 20px rgba(0,0,0,0.4);
      transition: transform 0.25s ease, opacity 0.25s ease;
    }
    .forge-preview-chat.active {
      display: flex;
    }
    /* Collapsed = minimised to a tab on the left edge */
    .forge-preview-chat.collapsed {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    /* Retrieve tab — visible when collapsed */
    .preview-retrieve-tab {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 201;
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: none;
      border-radius: 0 8px 8px 0;
      padding: 12px 8px;
      cursor: pointer;
      color: var(--text-dim);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.65rem;
      font-family: var(--mono);
      writing-mode: vertical-lr;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition: all 0.15s;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
    }
    .preview-retrieve-tab:hover { border-color: var(--accent); color: var(--accent); }
    .preview-retrieve-tab.visible { display: flex; }
    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--black);
      flex-shrink: 0;
      gap: 6px;
    }
    .preview-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .preview-header-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    .preview-hdr-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 3px 7px;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 0.7rem;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .preview-hdr-btn:hover { border-color: var(--accent); color: var(--accent); }
    .preview-hdr-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }
    .preview-hdr-btn svg { width: 11px; height: 11px; }
    .preview-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
      min-height: 0;
    }
    .preview-msg {
      display: flex;
      gap: 8px;
      max-width: 90%;
    }
    .preview-msg.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .preview-msg-avatar {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 0.8rem;
    }
    .preview-msg.user .preview-msg-avatar {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.15);
    }
    .preview-msg.assistant .preview-msg-avatar {
      background: var(--surface-2);
      border: 1px solid var(--border);
    }
    .preview-msg-bubble {
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 0.8rem;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .preview-msg.user .preview-msg-bubble {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.12);
      color: var(--text-bright);
      border-top-right-radius: 3px;
    }
    .preview-msg.assistant .preview-msg-bubble {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-top-left-radius: 3px;
    }
    .preview-msg.assistant .preview-msg-bubble code {
      font-family: var(--mono);
      font-size: 0.75em;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 4px;
      color: var(--accent);
    }
    /* Code blocks in preview */
    .preview-msg-bubble pre {
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      margin: 6px 0;
      overflow-x: auto;
      font-size: 0.75rem;
      line-height: 1.5;
      position: relative;
    }
    .preview-msg-bubble pre code {
      background: none !important;
      border: none !important;
      padding: 0 !important;
      color: var(--text) !important;
      font-size: inherit;
    }
    .preview-code-lang {
      position: absolute;
      top: 4px;
      right: 8px;
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .preview-code-copy {
      position: absolute;
      top: 4px;
      right: 8px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 0.55rem;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .preview-msg-bubble pre:hover .preview-code-copy { opacity: 1; }
    .preview-code-copy:hover { border-color: var(--accent); color: var(--accent); }
    /* Lists in preview */
    .preview-msg-bubble ul, .preview-msg-bubble ol {
      margin: 4px 0;
      padding-left: 18px;
    }
    .preview-msg-bubble li { margin: 2px 0; }
    /* Headers in preview */
    .preview-msg-bubble h1, .preview-msg-bubble h2, .preview-msg-bubble h3 {
      color: var(--text-bright);
      margin: 8px 0 4px;
      font-size: 0.85rem;
    }
    .preview-msg-bubble h1 { font-size: 0.95rem; }
    .preview-msg-bubble blockquote {
      border-left: 2px solid var(--accent);
      padding-left: 10px;
      margin: 6px 0;
      color: var(--text-dim);
      font-style: italic;
    }
    .preview-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      color: var(--text-dim);
      font-size: 0.75rem;
      text-align: center;
      padding: 20px;
    }
    .preview-empty svg {
      width: 28px;
      height: 28px;
      color: var(--border-active);
    }
    .preview-input-bar {
      padding: 12px;
      border-top: 1px solid var(--border);
      background: var(--black);
      flex-shrink: 0;
    }
    .preview-input-row {
      display: flex;
      gap: 6px;
      align-items: flex-end;
    }
    .preview-input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      font-family: var(--sans);
      font-size: 0.8rem;
      color: var(--text-bright);
      outline: none;
      resize: none;
      max-height: 80px;
      line-height: 1.4;
    }
    .preview-input:focus { border-color: var(--accent); }
    .preview-input::placeholder { color: var(--text-dim); }
    .preview-send {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      color: #000;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .preview-send:hover { background: #ff7070; }
    .preview-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .preview-send svg { width: 12px; height: 12px; }
    .preview-loading {
      display: inline-flex;
      gap: 3px;
      align-items: center;
      padding: 2px 0;
    }
    .preview-loading span {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: var(--text-dim);
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .preview-loading span:nth-child(2) { animation-delay: 0.2s; }
    .preview-loading span:nth-child(3) { animation-delay: 0.4s; }

    /* ── Responsive ── */
    @media (max-width: 900px) {
      .forge-layout {
        grid-template-columns: 1fr;
      }
      .forge-preview-chat {
        width: 100% !important;
        right: 0;
        border-right: none;
      }
      .forge-sidebar {
        position: relative;
        top: 0;
        height: auto;
        border-left: none;
        border-top: 1px solid var(--border);
      }
      .forge-main {
        padding: 32px 20px 60px;
      }
    }
    @media (max-width: 600px) {
      .option-grid { grid-template-columns: 1fr; }
      .skill-grid { grid-template-columns: 1fr; }
      .model-grid { grid-template-columns: 1fr; }
      .agent-row { grid-template-columns: 36px 1fr auto; }
      .agent-row > :nth-child(2) { grid-column: 2 / 4; }
      .agent-row > :nth-child(3) { grid-column: 2 / 4; }
      .toast { bottom: 16px; }
    }
  
    /* ── Canonical Nav ── */
    nav { background: rgba(0,0,0,0.85); border-bottom: 1px solid var(--border,#1a1a1a); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 500; }
    .nav-inner { width: 100%; padding: 0 32px; box-sizing: border-box; height: 52px; display: flex; align-items: center; justify-content: space-between; }
    .nav-logo { font-family: var(--mono,'Courier New',monospace); font-size: 0.9rem; font-weight: 600; color: var(--accent,#ff5c5c); text-decoration: none; }
    .nav-links { display: flex; gap: 32px; list-style: none; align-items: center; margin: 0; padding: 0; }
    .nav-links a { font-family: var(--mono,'Courier New',monospace); font-size: 0.78rem; color: var(--text-dim,#666); text-decoration: none; text-transform: uppercase; letter-spacing: 0.06em; transition: color 0.15s; }
    .nav-links a:hover { color: var(--text-bright,#fff); }
    .nav-links a.nav-active { color: var(--text-bright,#fff); }
    @media (max-width: 600px) {
      .nav-inner { padding: 0 12px; height: 48px; }
      .nav-links { gap: 8px; }
      .nav-links a { font-size: 0.6rem; }
      .nav-hide-mobile { display: none; }
    }


    /* ── VF Node Cards ── */
    .vf-node {
      width: 210px;
      background: #111111;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.6);
      cursor: grab;
      font-family: 'DM Sans', sans-serif;
      transition: box-shadow 0.15s, transform 0.12s;
    }
    .vf-node:hover {
      box-shadow: 0 10px 36px rgba(0,0,0,0.8);
      transform: translateY(-1px);
    }
    .vf-node.selected {
      box-shadow: 0 0 0 2px rgba(255,255,255,0.12), 0 10px 36px rgba(0,0,0,0.8);
      filter: brightness(1.08);
    }
    /* Inner layout */
    .vf-node-inner {
      display: flex;
      align-items: center;
      gap: 11px;
      padding: 12px 14px 12px 12px;
    }
    /* Coloured icon badge */
    .vf-node-badge-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .vf-node-badge-icon svg {
      position: relative; z-index: 1;
    }
    /* Text block */
    .vf-node-text { flex: 1; min-width: 0; }
    .vf-node-name {
      font-size: 0.82rem;
      font-weight: 600;
      color: #e8e8e8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
      margin-bottom: 2px;
    }
    .vf-node-type {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      opacity: 0.38;
      color: #fff;
    }
    /* Status dot */
    .vf-status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: #4ade80; flex-shrink: 0;
      animation: vfPulse 2s ease-in-out infinite;
    }
    @keyframes vfPulse {
      0%,100% { opacity:1; transform:scale(1); }
      50% { opacity:0.35; transform:scale(0.65); }
    }

    /* ── ReactFlow Overrides ── */
    .react-flow__background { background: #0a0a0a !important; }
    .react-flow__controls {
      background: #141414 !important;
      border: 1px solid #242424 !important;
      border-radius: 8px !important;
      box-shadow: none !important;
    }
    .react-flow__controls-button {
      background: #141414 !important;
      border-bottom-color: #2a2a2a !important;
      color: #aaa !important;
      fill: #aaa !important;
      width: 28px !important;
      height: 28px !important;
    }
    .react-flow__controls-button:hover {
      background: #222 !important;
      fill: #fff !important;
      color: #fff !important;
    }
    .react-flow__controls-button svg {
      width: 14px !important;
      height: 14px !important;
    }
    .react-flow__edge-path { stroke-opacity: 0.7; }
    .react-flow__handle {
      width: 10px !important; height: 10px !important;
      background: #191919 !important;
      border: 2px solid #3a3a3a !important;
      transition: border-color 0.15s, transform 0.15s !important;
    }
    .react-flow__handle:hover {
      border-color: #ff5c5c !important;
      transform: scale(1.3) !important;
    }
    .react-flow__node { padding: 0 !important; }
    @keyframes nodeIn {
      from { opacity:0; transform: scale(0.85); }
      to   { opacity:1; transform: scale(1); }
    }
    .react-flow__node { animation: nodeIn 0.18s ease-out; }
    #forge-root { height: calc(100vh - 57px); overflow: hidden; }

    @keyframes cronSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0 rgba(245,158,11,0.6); }
      70%  { box-shadow: 0 0 0 8px rgba(245,158,11,0); }
      100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); }
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .cron-running { animation: pulse-ring 1.4s ease infinite; }
    .refresh-spin { animation: cronSpin 1s linear infinite; display:inline-block; }

    </style>

  <!-- React Flow stylesheet -->
  <link rel="stylesheet" href="https://esm.sh/@xyflow/react@12/dist/style.css">
  <!-- Babel standalone for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- ESM importmap -->
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18",
      "react-dom": "https://esm.sh/react-dom@18",
      "react-dom/client": "https://esm.sh/react-dom@18/client",
      "@xyflow/react": "https://esm.sh/@xyflow/react@12?deps=react@18,react-dom@18",
      "elkjs": "https://esm.sh/elkjs@0.9.3/lib/elk.bundled.js"
    }
  }
  </script>
</head>
<body>

  <!-- Nav -->
  <!-- Nav -->
  <nav role="navigation" aria-label="Main navigation">
    <div class="nav-inner">
      <a href="/" class="nav-logo" aria-label="vibeclaw.dev home"><img src="/logo.png" alt="VibeClaw" style="height:44px;vertical-align:middle;"></a>
      <ul class="nav-links" role="list">
        <li><a href="/explore.html">Explore</a></li>
        <li><a href="/create.html">Create</a></li>
        <li class="nav-hide-mobile"><a href="/forge.html">Forge</a></li>
        <li class="nav-hide-mobile"><a href="/news.html">News</a></li>
        <li class="nav-hide-mobile"><a href="/docs/">Docs</a></li>
        <li class="nav-more-wrap" style="position:relative;">
          <button id="nav-more-btn" style="background:none;border:1px solid var(--border,#1a1a1a);border-radius:6px;padding:3px 8px;font-family:var(--mono,'Courier New',monospace);font-size:0.62rem;color:var(--text-dim,#666);cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:all 0.15s;white-space:nowrap;">
            More <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px;flex-shrink:0;"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <div id="nav-more-menu" style="display:none;position:absolute;top:calc(100% + 6px);right:0;background:#111;border:1px solid #222;border-radius:8px;padding:6px 0;min-width:180px;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,0.4);">
            <a href="/library.html" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;transition:background 0.1s;">My Library</a>
            <a href="/gallery.html" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;transition:background 0.1s;">Wallpapers</a>
            <div style="height:1px;background:#222;margin:4px 0;"></div>
            <a href="https://openclaw.ai" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;transition:background 0.1s;">OpenClaw</a>
            <a href="https://github.com/jasonkneen/vibeclaw" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;transition:background 0.1s;">GitHub</a>
            <a href="https://x.com/i/communities/2023680827435978937" style="display:flex;align-items:center;gap:6px;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;transition:background 0.1s;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:12px;height:12px;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>Community</a>
          </div>
        </li>
      </ul>
    </div>
  </nav>
<script>
    (function(){
      var btn=document.getElementById('nav-more-btn'),menu=document.getElementById('nav-more-menu');
      if(!btn||!menu)return;
      btn.addEventListener('click',function(e){e.stopPropagation();var o=menu.style.display!=='none';menu.style.display=o?'none':'block';btn.style.borderColor=o?'var(--border,#1a1a1a)':'var(--accent,#ff5c5c)';btn.style.color=o?'var(--text-dim,#666)':'var(--accent,#ff5c5c)';});
      document.addEventListener('click',function(){menu.style.display='none';btn.style.borderColor='var(--border,#1a1a1a)';btn.style.color='var(--text-dim,#666)';});
      menu.querySelectorAll('a').forEach(function(a){a.addEventListener('mouseenter',function(){a.style.background='#1a1a1a';});a.addEventListener('mouseleave',function(){a.style.background='transparent';});});
      var path=location.pathname.replace(/\/$/,'')||'/';
      document.querySelectorAll('.nav-links a').forEach(function(a){var h=(a.getAttribute('href')||'').replace(/\/$/,'');if(h&&path.endsWith(h))a.classList.add('nav-active');});
    })();
  </script>

  <div id="forge-root"></div>

  <script type="text/babel" data-type="module">
import React, { useState, useCallback, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import {
  ReactFlow,
  Background,
  Controls,
  addEdge,
  useNodesState,
  useEdgesState,
  Handle,
  Position,
  Panel,
} from '@xyflow/react';
import ELK from 'elkjs';

/* ── ELK auto-layout ── */
const elk = new ELK();
const ELK_OPTS = {
  'elk.algorithm': 'radial',
  'elk.spacing.nodeNode': '80',
};

const LAYOUT_PRESETS = {
  down:   { label:'Down',   icon:'↓', elk:{ 'elk.algorithm':'layered','elk.direction':'DOWN',  'elk.layered.spacing.nodeNodeBetweenLayers':'220','elk.spacing.nodeNode':'30','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
  right:  { label:'Right',  icon:'→', elk:{ 'elk.algorithm':'layered','elk.direction':'RIGHT', 'elk.layered.spacing.nodeNodeBetweenLayers':'280','elk.spacing.nodeNode':'30','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
  up:     { label:'Up',     icon:'↑', elk:{ 'elk.algorithm':'layered','elk.direction':'UP',    'elk.layered.spacing.nodeNodeBetweenLayers':'220','elk.spacing.nodeNode':'30','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
  left:   { label:'Left',   icon:'←', elk:{ 'elk.algorithm':'layered','elk.direction':'LEFT',  'elk.layered.spacing.nodeNodeBetweenLayers':'280','elk.spacing.nodeNode':'30','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
  radial: { label:'Radial', icon:'◎', elk:{ 'elk.algorithm':'radial', 'elk.spacing.nodeNode':'80' } },
  stress: { label:'Force',  icon:'⬡', elk:{ 'elk.algorithm':'stress', 'elk.spacing.nodeNode':'80','elk.stress.desiredEdgeLength':'180' } },
};

async function elkLayout(nodes, edges, opts = {}) {
  if (!nodes.length) return nodes;

  const algorithm = opts['elk.algorithm'] || ELK_OPTS['elk.algorithm'];
  const isRadial = algorithm === 'radial';

  // Scale radius based on node count so things don't overlap when expanded
  const nodeCount = nodes.length;
  const radius = nodeCount <= 8 ? 280 : nodeCount <= 20 ? 380 : 500;

  // Find the gateway node to use as root (radial only)
  const rootNode = isRadial && nodes.find(n => n.type === 'livegateway' || n.id === 'live-gw' || n.id === 'g1');

  const graph = {
    id: 'root',
    layoutOptions: {
      ...ELK_OPTS,
      ...(isRadial ? {
        'elk.radial.radius': String(radius),
        ...(rootNode ? { 'elk.radial.rootNode': rootNode.id } : {}),
      } : {}),
      ...opts,
    },
    children: nodes.map(n => ({
      id: n.id,
      width: n.measured?.width ?? n.width ?? (n.type === 'treeicon' ? 130 : 220),
      height: n.measured?.height ?? n.height ?? (n.type === 'treeicon' ? 130 : 70),
    })),
    edges: edges
      .filter(e => nodes.find(n => n.id === e.source) && nodes.find(n => n.id === e.target))
      .map(e => ({ id: e.id, sources: [e.source], targets: [e.target] })),
  };
  try {
    const result = await elk.layout(graph);

    // Center the graph around (0,0)
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    result.children?.forEach(node => {
      minX = Math.min(minX, node.x);
      minY = Math.min(minY, node.y);
      maxX = Math.max(maxX, node.x + (node.width ?? 0));
      maxY = Math.max(maxY, node.y + (node.height ?? 0));
    });
    const graphWidth = maxX - minX;
    const graphHeight = maxY - minY;
    const offsetX = -minX - graphWidth / 2;
    const offsetY = -minY - graphHeight / 2;

    return nodes.map(n => {
      const pos = result.children?.find(c => c.id === n.id);
      return pos ? { ...n, position: { x: (pos.x ?? 0) + offsetX, y: (pos.y ?? 0) + offsetY } } : n;
    });
  } catch (err) {
    console.warn('[elk] layout failed', err);
    return nodes;
  }
}

/* ── Templates ── */
function loadTemplate(id, setNodes, setEdges, save) {
  const t = {
    quickstart: {
      nodes: [
        { id:'g1', type:'gateway', position:{x:0,y:0}, data:{label:'My Gateway'} },
        { id:'a1', type:'agent',   position:{x:300,y:0}, data:{label:'Assistant',model:'upstage/solar-pro-3:free'} },
      ],
      edges: [{id:'e1',source:'g1',target:'a1',type:'smoothstep',style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65}}],
    },
    team: {
      nodes: [
        { id:'g1', type:'gateway', position:{x:0,y:120},   data:{label:'My Gateway'} },
        { id:'a1', type:'agent',   position:{x:320,y:-40}, data:{label:'Lead Agent'} },
        { id:'a2', type:'agent',   position:{x:320,y:120}, data:{label:'Coder'} },
        { id:'a3', type:'agent',   position:{x:320,y:280}, data:{label:'Reviewer'} },
      ],
      edges: [
        {id:'e1',source:'g1',target:'a1',type:'smoothstep',style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65}},
        {id:'e2',source:'g1',target:'a2',type:'smoothstep',style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65}},
        {id:'e3',source:'g1',target:'a3',type:'smoothstep',style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65}},
      ],
    },
    research: {
      nodes: [
        { id:'g1', type:'gateway', position:{x:0,y:80},     data:{label:'Research Gateway'} },
        { id:'a1', type:'agent',   position:{x:300,y:20},  data:{label:'Research Agent'} },
        { id:'s1', type:'skill',   position:{x:580,y:-80}, data:{label:'Web Search',skill:'web-search'} },
        { id:'m1', type:'model',   position:{x:580,y:120}, data:{label:'GPT-4o',provider:'openai'} },
      ],
      edges: [
        {id:'e1',source:'g1',target:'a1',type:'smoothstep',style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65}},
        {id:'e2',source:'a1',target:'s1',type:'smoothstep',style:{stroke:'#818cf8',strokeWidth:1.5,opacity:0.65}},
        {id:'e3',source:'a1',target:'m1',type:'smoothstep',style:{stroke:'#818cf8',strokeWidth:1.5,opacity:0.65}},
      ],
    },
  };
  const tmpl = t[id];
  if (!tmpl) return;
  setNodes(tmpl.nodes);
  setEdges(tmpl.edges);
  save(tmpl.nodes, tmpl.edges);
}

/* ── Apply AI result ── */
function applyAiResult(data, setNodes, setEdges) {
  try {
    const nodes = [];
    const edges = [];
    if (data.agents) {
      nodes.push({ id:'g1', type:'gateway', position:{x:0,y:0}, data:{label:data.name||'Gateway'} });
      data.agents.forEach((a, i) => {
        const id = `a${i}`;
        nodes.push({ id, type:'agent', position:{x:320,y:i*220-((data.agents.length-1)*110)}, data:{label:a.name,model:a.model||'upstage/solar-pro-3:free',systemPrompt:a.systemPrompt||''} });
        edges.push({ id:`e${i}`, source:'g1', target:id, type:'smoothstep', style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65} });
      });
      (data.skills||[]).forEach((s, i) => {
        const id = `s${i}`;
        nodes.push({ id, type:'skill', position:{x:580,y:i*100}, data:{label:s.name||s.source||'skill'} });
      });
    }
    if (nodes.length) { setNodes(nodes); setEdges(edges); }
  } catch(e) { console.error('AI result parse error', e); }
}

/* ── Node components ── */

/* ── Compact clean SVG icons — 22px, white strokes ── */
const IcoGateway = () => (
  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="#fff" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round">
    <rect x="2" y="3" width="18" height="13" rx="2"/>
    <path d="M7 19h8M11 16v3"/>
  </svg>
);
const IcoAgent = () => (
  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="#fff" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round">
    <circle cx="11" cy="8" r="4"/>
    <path d="M4 19c0-3.314 3.134-6 7-6s7 2.686 7 6"/>
    <circle cx="11" cy="2" r="1" fill="#fff" stroke="none"/>
  </svg>
);
const IcoSkill = () => (
  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="#fff" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round">
    <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l.7-.7a2 2 0 10-2.8-2.8l-.9.5z"/>
    <path d="M5 19l9-9"/>
    <path d="M7.3 7.3a1 1 0 000 1.4l6 6a1 1 0 001.4 0"/>
    <path d="M5 5l2 2"/>
    <circle cx="5" cy="17" r="2"/>
  </svg>
);
const IcoModel = () => (
  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="#fff" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round">
    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
    <path d="M2 17l10 5 10-5"/>
    <path d="M2 12l10 5 10-5"/>
  </svg>
);
const IcoChannel = () => (
  <svg width="22" height="22" viewBox="0 0 22 22" fill="none" stroke="#fff" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round">
    <path d="M22 2L11 13"/>
    <path d="M22 2L15 22l-4-9-9-4 20-7z"/>
  </svg>
);

/* ── Shared node shell ── */
function VFNode({ selected, color, icon, label, sub, handles='both', status='active' }) {
  // status: 'active' | 'inactive' | 'error' | 'warning'
  const STATUS_DOT = { active:'#4ade80', inactive:'#333', error:'#ef4444', warning:'#f59e0b' };
  const dotColor = STATUS_DOT[status] || '#333';
  const isActive = status === 'active';
  const C = status === 'inactive' ? '#2a2a2a' : color;
  return (
    <div className={`vf-node${selected ? ' selected' : ''}`}
         style={{border:`1.5px solid ${C}`, opacity: status === 'inactive' ? 0.45 : 1}}>
      {(handles==='both'||handles==='left') &&
        <Handle type="target" position={Position.Left}
          style={{background:C, border:`2px solid ${C}`, width:10, height:10, top:'50%', transform:'translateY(-50%)'}}/>}
      <div className="vf-node-inner">
        <div className="vf-node-badge-icon"
             style={{background:`color-mix(in srgb, ${C} 18%, #0a0a0a)`}}>
          {icon}
        </div>
        <div className="vf-node-text">
          <div className="vf-node-name" style={{color: status==='inactive'?'#444':'#e8e8e8'}}>{label}</div>
          <div className="vf-node-type">{sub}</div>
        </div>
        <span style={{
          width:6, height:6, borderRadius:'50%', flexShrink:0,
          background: dotColor,
          boxShadow: isActive ? `0 0 6px ${dotColor}` : 'none',
          animation: isActive ? 'vfPulse 2s ease-in-out infinite' : 'none',
        }}/>
      </div>
      {(handles==='both'||handles==='right') &&
        <Handle type="source" position={Position.Right}
          style={{background:C, border:`2px solid ${C}`, width:10, height:10, top:'50%', transform:'translateY(-50%)'}}/>}
    </div>
  );
}

function GatewayNode({ data, selected }) {
  return <VFNode selected={selected} color="#ff5c5c"
    icon={<IcoGateway/>} label={data.label||'My Gateway'} sub="gateway" status="active"/>;
}
function AgentNode({ data, selected }) {
  if (!data.liveAgent) {
    return <VFNode selected={selected} color="#818cf8" status="active"
      icon={<IcoAgent/>} label={data.label||'New Agent'} sub={data.model?.split('/').pop()||'agent'}/>;
  }
  const C = '#818cf8';
  const isActive = data.enabled !== false;
  const modelSlug = data.model?.split('/').pop() || data.model || '—';
  const provider = data.model?.split('/')[0] || '';
  const promptPreview = data.systemPrompt?.split('\n').find(l => l.trim()) || '';
  return (
    <div className={`vf-node${selected?' selected':''}`}
         style={{border:`1.5px solid ${C}`,padding:0,overflow:'hidden',width:240}}>
      <Handle type="target" position={Position.Left}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <Handle type="source" position={Position.Right}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>

      {/* Header */}
      <div style={{display:'flex',alignItems:'center',gap:8,padding:'9px 12px',borderBottom:'1px solid #161616'}}>
        <div style={{background:'color-mix(in srgb,#818cf8 18%,#0a0a0a)',borderRadius:6,padding:5,display:'flex',flexShrink:0}}>
          <IcoAgent/>
        </div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.78rem',color:'#e0e0e0'}}>{data.label}</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#818cf8',marginTop:1,display:'flex',alignItems:'center',gap:4}}>
            <span>{modelSlug}</span>
          </div>
        </div>
        <span style={{width:6,height:6,borderRadius:'50%',background:isActive?'#4ade80':'#333',boxShadow:isActive?'0 0 6px #4ade80':'none',flexShrink:0,animation:isActive?'vfPulse 2s ease-in-out infinite':'none'}}/>
      </div>

      {/* Detail rows */}
      <div style={{padding:'6px 12px',display:'flex',flexDirection:'column',gap:4}}>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#444',display:'flex',gap:4}}>
          <span style={{color:'#333',flexShrink:0}}>model</span>
          <span style={{color:'#666',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{provider}/{modelSlug}</span>
        </div>
        {data.workspace && (
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#444',display:'flex',gap:4}}>
            <span style={{color:'#333',flexShrink:0}}>workspace</span>
            <span style={{color:'#555',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{data.workspace.split('/').pop()}</span>
          </div>
        )}
        {data.thinking && (
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#444',display:'flex',gap:4}}>
            <span style={{color:'#333',flexShrink:0}}>thinking</span>
            <span style={{color:'#818cf8'}}>{data.thinking}</span>
          </div>
        )}
        {promptPreview && (
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#383838',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',borderTop:'1px solid #111',paddingTop:4,marginTop:2}}>
            {promptPreview}
          </div>
        )}
      </div>
    </div>
  );
}
function SkillNode({ data, selected }) {
  return <VFNode selected={selected} color="#4ade80"
    icon={<IcoSkill/>} label={data.label||'New Skill'} sub="skill" status="active"/>;
}
function ModelNode({ data, selected }) {
  return <VFNode selected={selected} color="#f59e0b"
    icon={<IcoModel/>} label={data.label||'GPT-4o'} sub={data.provider||'model'} status="active"/>;
}
function ChannelNode({ data, selected }) {
  if (!data.dmPolicy && !data.groupPolicy) {
    const status = data.enabled === false ? 'inactive' : 'active';
    return <VFNode selected={selected} color="#22d3ee" status={status}
      icon={<IcoChannel/>} label={data.label||'Telegram'} sub="channel"/>;
  }
  const C = '#22d3ee';
  const isActive = data.enabled !== false;
  const skip = new Set(['label','enabled','_nodeType','id','type','accounts']);
  const details = Object.entries(data).filter(([k,v]) => !skip.has(k) && v !== undefined && v !== null && v !== '');
  return (
    <div className={`vf-node${selected?' selected':''}`}
         style={{border:`1.5px solid ${isActive?C:'#1c1c1c'}`,padding:0,overflow:'hidden',width:220,opacity:isActive?1:0.45}}>
      <Handle type="target" position={Position.Left}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <Handle type="source" position={Position.Right}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <div style={{display:'flex',alignItems:'center',gap:8,padding:'9px 12px',borderBottom:'1px solid #161616'}}>
        <div style={{background:`color-mix(in srgb,${C} 18%,#0a0a0a)`,borderRadius:6,padding:5,display:'flex',flexShrink:0}}><IcoChannel/></div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.78rem',color:'#e0e0e0'}}>{data.label||data.type}</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:isActive?C:'#333',marginTop:1}}>{isActive?'enabled':'disabled'}</div>
        </div>
        <span style={{width:6,height:6,borderRadius:'50%',background:isActive?'#4ade80':'#333',boxShadow:isActive?'0 0 6px #4ade80':'none',flexShrink:0,animation:isActive?'vfPulse 2s ease-in-out infinite':'none'}}/>
      </div>
      <div style={{padding:'6px 12px',display:'flex',flexDirection:'column',gap:3}}>
        {details.slice(0,4).map(([k,v]) => (
          <div key={k} style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.57rem',display:'flex',gap:4}}>
            <span style={{color:'#333',flexShrink:0}}>{k}</span>
            <span style={{color:'#555',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>
              {Array.isArray(v)?v.slice(0,2).join(', ')+(v.length>2?`…`:''):String(v)}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ── Collapsed Server Node — matches reference icon exactly ── */
function useNodeImage(label, category) {
  const [imgUrl, setImgUrl] = React.useState(null);
  React.useEffect(() => {
    const cacheKey = `node-img::${category}::${label}`;
    const cached = localStorage.getItem(cacheKey);
    if (cached) { setImgUrl(cached); return; }
    fetch(`/api/node-image?label=${encodeURIComponent(label)}&category=${encodeURIComponent(category)}`)
      .then(r => r.json())
      .then(d => { if (d.ok && d.dataUrl) { localStorage.setItem(cacheKey, d.dataUrl); setImgUrl(d.dataUrl); } })
      .catch(() => {});
  }, [label, category]);
  return imgUrl;
}

function CollapsedServerNode({ data, selected }) {
  const imgUrl = useNodeImage(data.label || 'Gateway', 'node');
  return (
    <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:9, background:'transparent' }}>
      <Handle type="source" position={Position.Bottom} style={{ opacity:0, pointerEvents:'none' }}/>
      {/* Icon square — dark maroon, iOS-style radius */}
      <div style={{
        width:100, height:100, borderRadius:22, flexShrink:0,
        backgroundColor:'#1c0b0e',
        backgroundImage: `url(${imgUrl})`,
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        border:`1.5px solid ${selected ? '#e8453c' : '#ff5c5c'}`,
        display:'flex', alignItems:'center', justifyContent:'center',
        position:'relative', overflow:'hidden',
        boxShadow: selected ? '0 0 0 3px rgba(232,69,60,0.2), 0 8px 32px rgba(0,0,0,0.9)' : '0 6px 28px rgba(0,0,0,0.8)',
      }}>
        {/* Live dot */}
        {/* Dim overlay tinted red */}
        <div style={{position:'absolute',inset:0,background:'color-mix(in srgb,#1c0b0e 70%,transparent)',zIndex:0}}/>
        <span style={{
          position:'absolute', top:8, right:8, zIndex:2,
          width:6, height:6, borderRadius:'50%',
          background:'#4ade80', boxShadow:'0 0 6px rgba(74,222,128,0.9)',
          animation:'vfPulse 2s ease-in-out infinite',
        }}/>
        {/* Two stacked server rectangles */}
        <div style={{position:'relative',zIndex:1}}>
          <svg width="62" height="54" viewBox="0 0 62 54" fill="none">
            {/* Top rack */}
            <rect x="3" y="3" width="56" height="20" rx="4" stroke="#e8453c" strokeWidth="2"/>
            <circle cx="13" cy="13" r="3.5" fill="#e8453c"/>
            <line x1="23" y1="13" x2="48" y2="13" stroke="#e8453c" strokeWidth="2" strokeLinecap="round"/>
            {/* Bottom rack */}
            <rect x="3" y="31" width="56" height="20" rx="4" stroke="#e8453c" strokeWidth="2"/>
            <circle cx="13" cy="41" r="3.5" fill="#e8453c"/>
            <line x1="23" y1="41" x2="48" y2="41" stroke="#e8453c" strokeWidth="2" strokeLinecap="round"/>
          </svg>
        </div>
      </div>
      {/* Name below */}
      <div style={{
        fontFamily:"'JetBrains Mono',monospace", fontSize:'0.72rem',
        fontWeight:600, color:'#c0c0c0', textAlign:'center',
        maxWidth:160, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis',
      }}>{data.label || 'OpenClaw Gateway'}</div>
    </div>
  );
}

/* ── Tree Icon Node — same style as gateway icon, colored by category ── */
const TREE_CATEGORIES = {
  agent:   { color:'#818cf8', bg:'#0c0a1c', border:'#261e4a',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg> },
  model:   { color:'#f59e0b', bg:'#120900', border:'#3d2500',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg> },
  skill:   { color:'#4ade80', bg:'#050f08', border:'#163324',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg> },
  channel: { color:'#22d3ee', bg:'#03100f', border:'#0b3038',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><circle cx="12" cy="20" r="1" fill={c} stroke="none"/></svg> },
  cron:    { color:'#a855f7', bg:'#0d0618', border:'#2e1258',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> },
  node:    { color:'#22d3ee', bg:'#03100f', border:'#0b3038',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg> },
  command: { color:'#a855f7', bg:'#0d0618', border:'#2e1258',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg> },
  session: { color:'#f59e0b', bg:'#120900', border:'#3d2500',
    icon: (c) => <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> },
};

function TreeIconNode({ data, selected }) {
  const cfg = TREE_CATEGORIES[data.category] || TREE_CATEGORIES.agent;
  const isEnabled = data.enabled !== false;
  const imgUrl = useNodeImage(data.label || 'node', data.category || 'agent');
  return (
    <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:9, background:'transparent' }}>
      <Handle type="target" position={Position.Top} style={{ opacity:0, pointerEvents:'none' }}/>
      <Handle type="source" position={Position.Bottom} style={{ opacity:0, pointerEvents:'none' }}/>
      <div style={{
        width:100, height:100, borderRadius:22,
        backgroundColor: cfg.bg,
        backgroundImage: `url(${imgUrl})`,
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        border:`1.5px solid ${cfg.color}`,
        display:'flex', alignItems:'center', justifyContent:'center',
        position:'relative', opacity: isEnabled ? 1 : 0.4,
        overflow: 'hidden',
        boxShadow: selected ? `0 0 0 3px ${cfg.color}33, 0 8px 32px rgba(0,0,0,0.9)` : '0 6px 28px rgba(0,0,0,0.8)',
        transition:'border-color 0.2s, box-shadow 0.2s',
      }}>
        {/* Layer 0 — colour-mix tint so AI image feels themed */}
        <div style={{
          position:'absolute', inset:0, zIndex:0, pointerEvents:'none',
          background:`color-mix(in srgb, ${cfg.bg} 65%, transparent)`,
        }}/>

        {/* Icon */}
        <div style={{position:'relative', zIndex:1, display:'flex', alignItems:'center', justifyContent:'center'}}>
          {cfg.icon(cfg.color)}
        </div>

        {/* Layer 2 — glass gradient: dark base → transparent → faint top light */}
        <div style={{
          position:'absolute', inset:0, borderRadius:20, zIndex:2, pointerEvents:'none',
          background:`linear-gradient(to top,
            rgba(0,0,0,0.55) 0%,
            rgba(0,0,0,0.20) 38%,
            rgba(0,0,0,0.00) 60%,
            rgba(255,255,255,0.04) 100%)`,
        }}/>

        {/* Layer 3 — top specular blob: convex glass catching overhead light */}
        <div style={{
          position:'absolute', top:0, left:'10%', right:'10%', height:'55%',
          zIndex:3, pointerEvents:'none',
          background:`radial-gradient(ellipse at 50% -10%,
            rgba(255,255,255,0.13) 0%,
            rgba(255,255,255,0.04) 45%,
            transparent 72%)`,
        }}/>

        {/* Layer 4 — bottom rim shadow for physical depth */}
        <div style={{
          position:'absolute', bottom:0, left:0, right:0, height:'30%',
          zIndex:4, pointerEvents:'none', borderRadius:'0 0 20px 20px',
          background:`linear-gradient(to top, rgba(0,0,0,0.30) 0%, transparent 100%)`,
        }}/>

        {/* Status dot — above glass */}
        <span style={{
          position:'absolute', top:8, right:8, width:7, height:7, borderRadius:'50%', zIndex:5,
          background: isEnabled ? '#4ade80' : '#333',
          boxShadow: isEnabled ? '0 0 6px rgba(74,222,128,0.8)' : 'none',
        }}/>

        {data.expandable && (
          <span style={{
            position:'absolute', bottom:7, left:'50%', transform:'translateX(-50%)',
            fontSize:'0.75rem', color: data.expanded ? cfg.color : '#666',
            lineHeight:1, zIndex:5,
          }}>{data.expanded ? '▾' : '▸'}</span>
        )}
      </div>
      <div style={{
        fontFamily:"'JetBrains Mono',monospace", fontSize:'1rem',
        fontWeight:600, color:'#e0e0e0', textAlign:'center',
        maxWidth:150, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis',
      }}>{data.label}</div>
      {data.badge && (
        <div style={{
          fontFamily:"'JetBrains Mono',monospace", fontSize:'0.78rem',
          color: cfg.color, textAlign:'center',
          maxWidth:150, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis',
          marginTop:-4, opacity:0.85,
        }}>{data.badge}</div>
      )}
    </div>
  );
}

const nodeTypes = {
  collapsedserver: CollapsedServerNode,
  treeicon: TreeIconNode,
  gateway:      GatewayNode,
  livegateway:  LiveGatewayNode,
  sectioncard:  SectionCardNode,
  agent:        AgentNode,
  skill:        SkillNode,
  skillslist:   SkillsListNode,
  sessionslist: SessionsListNode,
  cronlist:     CronListNode,
  nodeslist:    NodesListNode,
  modelslist:   ModelsListNode,
  model:        ModelNode,
  channel:      ChannelNode,
};

/* ── Nav Button ── */
function NavBtn({ children, onClick, primary, title, style: extraStyle }) {
  const [hov, setHov] = React.useState(false);
  return (
    <button onClick={onClick} title={title}
      onMouseEnter={() => setHov(true)}
      onMouseLeave={() => setHov(false)}
      style={{
        fontFamily:"'JetBrains Mono',monospace", fontSize:'0.82rem',
        fontWeight:600,
        background: primary ? '#ff5c5c' : hov ? '#2a2a2a' : '#1c1c1c',
        border: `1px solid ${primary ? '#ff5c5c' : hov ? '#ff5c5c' : '#444'}`,
        color: primary ? '#000' : hov ? '#fff' : '#ddd',
        padding:'5px 12px', borderRadius:6, cursor:'pointer',
        transition:'all 0.15s',
        boxShadow: hov && !primary ? '0 0 0 1px #ff5c5c22' : 'none',
        ...extraStyle,
      }}>
      {children}
    </button>
  );
}

/* ── Palette ── */
function PaletteLabel({ children, style }) {
  return (
    <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',textTransform:'uppercase',letterSpacing:'0.12em',color:'#2e2e2e',padding:'6px 2px 3px',...style}}>
      {children}
    </div>
  );
}

function PaletteItem({ children, color, onClick }) {
  const [hov, setHov] = React.useState(false);
  return (
    <button onClick={onClick}
      onMouseEnter={() => setHov(true)}
      onMouseLeave={() => setHov(false)}
      style={{
        display:'flex', alignItems:'center', gap:7,
        padding:'9px 10px', borderRadius:7,
        background: hov ? '#1a1a1a' : '#141414',
        border: `1px solid ${hov ? color : '#1e1e1e'}`,
        cursor:'pointer', color: hov ? '#e0e0e0' : '#666',
        fontFamily:"'JetBrains Mono',monospace", fontSize:'0.72rem',
        textAlign:'left', transition:'all 0.15s', width:'100%',
      }}>
      {children}
    </button>
  );
}

function Palette({ onAdd }) {
  const nodeItems = [
    { type:'gateway', emoji:'🖥️', label:'Gateway', color:'#ff5c5c' },
    { type:'agent',   emoji:'🤖', label:'Agent',   color:'#818cf8' },
    { type:'skill',   emoji:'🔧', label:'Skill',   color:'#4ade80' },
    { type:'model',   emoji:'🧠', label:'Model',   color:'#f59e0b' },
    { type:'channel', emoji:'📡', label:'Channel', color:'#22d3ee' },
  ];
  const templates = [
    { id:'quickstart', emoji:'⚡', label:'Quick Start' },
    { id:'team',       emoji:'👥', label:'Team Setup' },
    { id:'research',   emoji:'🔬', label:'Research Stack' },
  ];

  return (
    <div style={{
      width:196, flexShrink:0,
      background:'rgba(10,10,10,0.97)',
      borderRight:'1px solid #1c1c1c',
      padding:'14px 10px', display:'flex',
      flexDirection:'column', gap:5, overflowY:'auto',
    }}>
      <PaletteLabel>Nodes</PaletteLabel>
      {nodeItems.map(n => (
        <PaletteItem key={n.type} color={n.color} onClick={() => onAdd(n.type)}>
          <span style={{width:8,height:8,borderRadius:'50%',background:n.color,opacity:0.8,flexShrink:0,display:'inline-block'}} />
          {n.emoji} {n.label}
        </PaletteItem>
      ))}
      <PaletteLabel style={{marginTop:10}}>Templates</PaletteLabel>
      {templates.map(t => (
        <PaletteItem key={t.id} color="#444" onClick={() => onAdd(t.id)}>
          {t.emoji} {t.label}
        </PaletteItem>
      ))}
    </div>
  );
}

/* ── Config Panel ── */
function ConfigPanel({ node, onClose, onUpdate }) {
  const emojis = {gateway:'🖥️', agent:'🤖', skill:'🔧', model:'🧠', channel:'📡'};
  const models = [
    'upstage/solar-pro-3:free','anthropic/claude-3-5-sonnet',
    'openai/gpt-4o','meta-llama/llama-3.3-70b-instruct:free',
    'google/gemini-2.0-flash-exp:free',
  ];
  const skills = ['web-search','summarize','github','gmail','calendar','apple-notes','browser','image-gen'];
  const channels = ['telegram','slack','discord','whatsapp','signal','imessage'];

  const panelStyle = {
    width: node ? 300 : 0,
    overflow: node ? 'auto' : 'hidden',
    flexShrink: 0,
    background: 'rgba(10,10,10,0.97)',
    borderLeft: '1px solid #1c1c1c',
    transition: 'width 0.2s cubic-bezier(0.4,0,0.2,1)',
    display: 'flex', flexDirection: 'column',
  };

  if (!node) return <div style={panelStyle} />;

  const type = node.type;
  const d = node.data || {};

  const inputStyle = {
    background:'#0e0e0e', border:'1px solid #242424', borderRadius:6,
    color:'#e0e0e0', padding:'8px 10px',
    fontFamily:"'JetBrains Mono',monospace", fontSize:'0.78rem',
    width:'100%', outline:'none', boxSizing:'border-box',
  };

  const Field = ({ label, children }) => (
    <div style={{display:'flex',flexDirection:'column',gap:5}}>
      <label style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.72rem',textTransform:'uppercase',letterSpacing:'0.08em',color:'#888'}}>{label}</label>
      {children}
    </div>
  );

  return (
    <div style={panelStyle}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'14px 16px',borderBottom:'1px solid #272727'}}>
        <span style={{fontSize:'0.85rem',fontWeight:600,color:'#e0e0e0'}}>
          {emojis[type]} {d.label}
        </span>
        <button onClick={onClose} style={{background:'none',border:'none',color:'#444',fontSize:'1.1rem',cursor:'pointer',padding:'2px 6px',borderRadius:4}}>×</button>
      </div>
      <div style={{padding:16,display:'flex',flexDirection:'column',gap:14,overflowY:'auto',flex:1}}>
        <Field label="Name">
          <input style={inputStyle} value={d.label||''} onChange={e => onUpdate(node.id,'label',e.target.value)} />
        </Field>
        {type === 'agent' && <>
          <Field label="Model">
            <select style={inputStyle} value={d.model||models[0]} onChange={e => onUpdate(node.id,'model',e.target.value)}>
              {models.map(m => <option key={m}>{m}</option>)}
            </select>
          </Field>
          <Field label="System Prompt">
            <textarea style={{...inputStyle,minHeight:90,resize:'vertical'}}
              value={d.systemPrompt||''} onChange={e => onUpdate(node.id,'systemPrompt',e.target.value)} />
          </Field>
        </>}
        {type === 'gateway' && (
          <Field label="Description">
            <textarea style={{...inputStyle,minHeight:70,resize:'vertical'}}
              value={d.desc||''} onChange={e => onUpdate(node.id,'desc',e.target.value)} />
          </Field>
        )}
        {type === 'skill' && (
          <Field label="Skill">
            <select style={inputStyle} value={d.skill||skills[0]} onChange={e => onUpdate(node.id,'skill',e.target.value)}>
              {skills.map(s => <option key={s}>{s}</option>)}
            </select>
          </Field>
        )}
        {type === 'model' && (
          <Field label="Provider">
            <input style={inputStyle} value={d.provider||'openai'} onChange={e => onUpdate(node.id,'provider',e.target.value)} />
          </Field>
        )}
        {type === 'channel' && (
          <Field label="Channel Type">
            <select style={inputStyle} value={d.channelType||channels[0]} onChange={e => onUpdate(node.id,'channelType',e.target.value)}>
              {channels.map(c => <option key={c}>{c}</option>)}
            </select>
          </Field>
        )}
      </div>
    </div>
  );
}

/* ── AI Build Modal ── */
function AiBuildModal({ onClose, onResult }) {
  const [prompt, setPrompt] = React.useState('');
  const [loading, setLoading] = React.useState(false);
  const chips = ['coding agent','web researcher','GitHub bot','daily assistant','agent squad'];

  const build = async () => {
    if (!prompt.trim()) return;
    setLoading(true);
    try {
      const resp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'upstage/solar-pro-3:free',
          messages: [
            { role: 'system', content: `You are an OpenClaw server configurator. Given a user description, output a JSON object with: name (string), agents (array of {name, model, systemPrompt}), skills (array of {source}). Respond ONLY with valid JSON, no markdown.` },
            { role: 'user', content: prompt }
          ],
          max_tokens: 500,
        })
      });
      const data = await resp.json();
      const text = data.choices?.[0]?.message?.content || '';
      const config = JSON.parse(text);
      onResult(config);
    } catch(e) {
      console.error('AI build error:', e);
    }
    setLoading(false);
  };

  return (
    <div onClick={onClose} style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.75)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div onClick={e => e.stopPropagation()} style={{background:'#141414',border:'1px solid #2a2a2a',borderRadius:12,padding:28,width:560,maxWidth:'90vw'}}>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',textTransform:'uppercase',letterSpacing:'0.1em',color:'#444',marginBottom:12}}>✨ AI Build</div>
        <textarea value={prompt} onChange={e => setPrompt(e.target.value)}
          placeholder="Describe your agent network..."
          style={{width:'100%',minHeight:90,background:'#0e0e0e',border:'1px solid #242424',borderRadius:8,color:'#e0e0e0',padding:12,fontFamily:"'JetBrains Mono',monospace",fontSize:'0.8rem',resize:'vertical',outline:'none',boxSizing:'border-box'}} />
        <div style={{display:'flex',gap:6,flexWrap:'wrap',margin:'10px 0'}}>
          {chips.map(c => (
            <button key={c} onClick={() => setPrompt(c)}
              style={{background:'transparent',border:'1px solid #2a2a2a',borderRadius:20,padding:'4px 10px',cursor:'pointer',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#555',transition:'all 0.15s'}}
              onMouseEnter={e => {e.target.style.borderColor='#ff5c5c';e.target.style.color='#e0e0e0';}}
              onMouseLeave={e => {e.target.style.borderColor='#2a2a2a';e.target.style.color='#555';}}>
              "{c}"
            </button>
          ))}
        </div>
        <div style={{display:'flex',justifyContent:'flex-end',gap:8,marginTop:14}}>
          <NavBtn onClick={onClose}>Cancel</NavBtn>
          <NavBtn primary onClick={build}>{loading ? 'Building…' : 'Build it →'}</NavBtn>
        </div>
      </div>
    </div>
  );
}

/* ── Export Modal ── */
function ExportModal({ nodes, edges, onClose }) {
  const gateways = nodes.filter(n => n.type === 'gateway');
  const agents   = nodes.filter(n => n.type === 'agent');
  const skills   = nodes.filter(n => n.type === 'skill');
  const spec = {
    specVersion: '1.0',
    id: 'srv_' + Math.random().toString(36).slice(2,10),
    name: gateways[0]?.data?.label || 'My Gateway',
    runtime: {
      type: agents.length > 1 ? 'multi' : 'single',
      model: { provider:'openrouter', model: agents[0]?.data?.model || 'upstage/solar-pro-3:free' },
    },
    agents: agents.map((a, i) => ({
      id: i===0 ? 'main' : (a.data.label||'').toLowerCase().replace(/\W+/g,'') || `agent${i}`,
      name: a.data.label, role: i===0 ? 'lead' : 'specialist',
      systemPrompt: a.data.systemPrompt || '',
    })),
    skills: skills.map(s => ({ source: `builtin:${s.data.skill||s.data.label}` })),
    workspace: {},
  };
  const json = JSON.stringify(spec, null, 2);

  return (
    <div onClick={onClose} style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.75)',zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div onClick={e => e.stopPropagation()} style={{background:'#141414',border:'1px solid #2a2a2a',borderRadius:12,padding:28,width:600,maxWidth:'90vw',maxHeight:'80vh',display:'flex',flexDirection:'column',gap:16}}>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',textTransform:'uppercase',letterSpacing:'0.1em',color:'#444'}}>⬇ Export Config</div>
        <pre style={{background:'#0a0a0a',border:'1px solid #1e1e1e',borderRadius:8,padding:16,fontFamily:"'JetBrains Mono',monospace",fontSize:'0.72rem',color:'#4ade80',overflowY:'auto',flex:1,margin:0}}>{json}</pre>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color:'#444',background:'#0a0a0a',border:'1px solid #1e1e1e',borderRadius:6,padding:'8px 12px'}}>
          curl -fsSL https://vibeclaw.dev/install.sh | bash
        </div>
        <div style={{display:'flex',justifyContent:'flex-end',gap:8}}>
          <NavBtn onClick={onClose}>Close</NavBtn>
          <NavBtn primary onClick={() => {
            const blob = new Blob([json], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${spec.name.toLowerCase().replace(/\s+/g,'-')}.json`;
            a.click();
          }}>⬇ Download JSON</NavBtn>
        </div>
      </div>
    </div>
  );
}

/* ── Section Card — collapsed section node, click to expand ── */
function SectionCardNode({ data, selected }) {
  const C = data.color || '#555';
  const ICONS = { Agents:'🤖', Skills:'🔧', Channels:'📡', Sessions:'🕐', 'Cron Jobs':'⏱', Nodes:'📱' };
  return (
    <div className={`vf-node${selected?' selected':''}`}
         style={{border:`1.5px solid ${C}`,padding:0,overflow:'hidden',width:180,cursor:'pointer'}}
         >
      <Handle type="target" position={Position.Left}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <Handle type="source" position={Position.Right}
        style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <div style={{display:'flex',alignItems:'center',gap:8,padding:'10px 14px'}}>
        <span style={{fontSize:'1rem'}}>{ICONS[data.label]||'📦'}</span>
        <div style={{flex:1}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>{data.label}</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:C,marginTop:1}}>{data.count} {data.count===1?'item':'items'}</div>
        </div>
        <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#333'}}>▶</span>
      </div>
    </div>
  );
}

/* ── Skills List Node — canvas node showing all skills ── */
function SkillsListNode({ data, selected }) {
  const [filter, setFilter] = React.useState('');
  const [toggling, setToggling] = React.useState({});
  const skills = data.skills || [];

  const filtered = skills.filter(s => !filter || s.id.toLowerCase().includes(filter.toLowerCase()));
  const on = filtered.filter(s => s.enabled);
  const off = filtered.filter(s => !s.enabled);

  const handleToggle = async (skill) => {
    setToggling(t => ({...t, [skill.id]: true}));
    try {
      await fetch('/api/gateway-patch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ skillPatch: { skillId: skill.id, enabled: !skill.enabled } }),
      });
      window.__liveSkillToggled?.(skill.id, !skill.enabled);
    } catch(e) {}
    setToggling(t => ({...t, [skill.id]: false}));
  };

  return (
    <div className={`vf-node${selected?' selected':''}`}
         style={{border:'1.5px solid #4ade80', padding:0, overflow:'hidden', width:260, maxHeight:480, display:'flex', flexDirection:'column'}}>
      <Handle type="target" position={Position.Left}
        style={{background:'#4ade80',border:'2px solid #4ade80',width:10,height:10,top:24,transform:'none'}}/>

      {/* Header */}
      <div style={{padding:'10px 12px', borderBottom:'1px solid #1a1a1a', display:'flex', alignItems:'center', justifyContent:'space-between', flexShrink:0}}>
        <div style={{display:'flex', alignItems:'center', gap:8}}>
          <div style={{background:'color-mix(in srgb,#4ade80 18%,#0a0a0a)', borderRadius:6, padding:5, display:'flex'}}>
            <IcoSkill/>
          </div>
          <div>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>Skills</div>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem',color:'#4ade80',marginTop:1}}>
              {skills.filter(s=>s.enabled).length} on · {skills.filter(s=>!s.enabled).length} off
            </div>
          </div>
        </div>
      </div>

      {/* Filter */}
      <div style={{padding:'6px 10px', borderBottom:'1px solid #141414', flexShrink:0}} className="nodrag nopan">
        <input value={filter} onChange={e=>setFilter(e.target.value)}
          placeholder="filter…"
          style={{width:'100%',background:'#0a0a0a',border:'1px solid #1e1e1e',borderRadius:4,padding:'4px 8px',color:'#aaa',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',outline:'none',boxSizing:'border-box'}}
        />
      </div>

      {/* Skill rows */}
      <div style={{overflowY:'auto', flex:1}} className="nodrag nopan">
        {[...on, ...off].map(s => (
          <div key={s.id} style={{padding:'6px 10px',borderBottom:'1px solid #0e0e0e',display:'flex',alignItems:'flex-start',gap:6,justifyContent:'space-between'}}>
            <div style={{display:'flex',alignItems:'flex-start',gap:6,flex:1,minWidth:0}}>
              <span style={{width:5,height:5,borderRadius:'50%',background:s.enabled?'#4ade80':'#2a2a2a',boxShadow:s.enabled?'0 0 5px #4ade8066':'none',flexShrink:0,marginTop:4}}/>
              <div style={{minWidth:0}}>
                <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:s.enabled?'#bbb':'#3a3a3a'}}>{s.id}</div>
                {s.description && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',color:'#3a3a3a',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',marginTop:1}}>{s.description}</div>}
              </div>
            </div>
            <button onClick={()=>handleToggle(s)} disabled={!!toggling[s.id]}
              style={{background:'none',border:`1px solid ${s.enabled?'#2a5c3a':'#222'}`,borderRadius:10,padding:'1px 8px',cursor:'pointer',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',color:s.enabled?'#4ade80':'#333',flexShrink:0}}>
              {toggling[s.id]?'…':s.enabled?'on':'off'}
            </button>
          </div>
        ))}
        {filtered.length===0 && <div style={{padding:16,textAlign:'center',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#2a2a2a'}}>no match</div>}
      </div>
    </div>
  );
}

/* ── Sessions List Node ── */
function SessionsListNode({ data }) {
  const sessions = data.sessions || [];
  const fmtTime = iso => {
    if (!iso) return '';
    const d = new Date(iso), now = new Date();
    const diff = now - d;
    if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
    return d.toLocaleDateString();
  };
  return (
    <div className="vf-node" style={{border:'1.5px solid #f59e0b',padding:0,overflow:'hidden',width:320,maxHeight:440,display:'flex',flexDirection:'column'}}>
      <Handle type="target" position={Position.Left} style={{background:'#f59e0b',border:'2px solid #f59e0b',width:10,height:10,top:24}}/>
      <div style={{padding:'10px 12px',borderBottom:'1px solid #1a1a1a',display:'flex',alignItems:'center',gap:8,flexShrink:0}}>
        <div style={{background:'color-mix(in srgb,#f59e0b 18%,#0a0a0a)',borderRadius:6,padding:5,fontSize:'0.85rem'}}>🕐</div>
        <div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>Sessions</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem',color:'#f59e0b',marginTop:1}}>{sessions.length} recent · {sessions.reduce((a,s)=>a+(s.messageCount||0),0)} messages</div>
        </div>
      </div>
      <div style={{overflowY:'auto',flex:1}}>
        {sessions.map(s => (
          <div key={s.id} style={{padding:'8px 12px',borderBottom:'1px solid #0e0e0e'}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:3}}>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#666'}}>{s.id.slice(0,12)}…</span>
              <div style={{display:'flex',gap:8,alignItems:'center'}}>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.52rem',color:'#444'}}>{s.messageCount} msg</span>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.52rem',color:'#333'}}>{s.sizeKb}kb</span>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.52rem',color:'#555'}}>{fmtTime(s.lastActive)}</span>
              </div>
            </div>
            {s.lastUserMessage && (
              <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.62rem',color:'#777',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',borderLeft:'2px solid #333',paddingLeft:6}}>
                {s.lastUserMessage}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

/* ── Cron Jobs Node ── */
function CronListNode({ data }) {
  const jobs = data.cronJobs || [];
  const STATUS = { ok:'#4ade80', error:'#ef4444', running:'#f59e0b' };
  const runningCount = jobs.filter(j => j.lastStatus === 'running').length;
  return (
    <div className="vf-node" style={{border:'1.5px solid #a855f7',padding:0,overflow:'hidden',width:300,maxHeight:420,display:'flex',flexDirection:'column'}}>
      <Handle type="target" position={Position.Left} style={{background:'#a855f7',border:'2px solid #a855f7',width:10,height:10,top:24}}/>
      <div style={{padding:'10px 12px',borderBottom:'1px solid #1a1a1a',display:'flex',alignItems:'center',gap:8,flexShrink:0}}>
        <div style={{background:'color-mix(in srgb,#a855f7 18%,#0a0a0a)',borderRadius:6,padding:5,display:'flex',fontSize:'0.85rem'}}>⏱</div>
        <div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>Cron Jobs</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem',color:'#a855f7',marginTop:1}}>
            {jobs.filter(j=>j.enabled).length} active · {jobs.length} total
            {runningCount > 0 && <span style={{color:'#f59e0b',marginLeft:6}}>· <span className="refresh-spin">⟳</span> {runningCount} running</span>}
          </div>
        </div>
      </div>
      <div style={{overflowY:'auto',flex:1}} className="nodrag nopan">
        {jobs.map(j => (
          <div key={j.id}
            onClick={e=>{e.stopPropagation();window.__liveCronClick?.(j);}}
            style={{padding:'8px 12px',borderBottom:'1px solid #0e0e0e',cursor:'pointer',transition:'background 0.1s'}}
            onMouseEnter={e=>e.currentTarget.style.background='#111'}
            onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:3}}>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                <span className={j.lastStatus==='running'?'cron-running':''} style={{width:5,height:5,borderRadius:'50%',background:j.enabled?(STATUS[j.lastStatus]||'#555'):'#222',flexShrink:0}}/>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',color:j.enabled?'#ccc':'#444'}}>{j.name}</span>
              </div>
              <div style={{display:'flex',alignItems:'center',gap:6}}>
                {j.lastStatus && <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',color:STATUS[j.lastStatus]||'#555'}}>{j.lastStatus}</span>}
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.5rem',color:'#333'}}>edit →</span>
              </div>
            </div>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',paddingLeft:11,display:'flex',flexDirection:'column',gap:2}}>
              <span>{j.schedule?.expr || j.schedule?.kind} {j.schedule?.tz ? `(${j.schedule.tz})` : ''}</span>
              <span>last: {j.lastRunAt ? new Date(j.lastRunAt).toLocaleString() : 'never'} {j.lastDurationMs ? `· ${j.lastDurationMs}ms` : ''}</span>
              {j.nextRunAt && <span style={{color:'#555'}}>next: {new Date(j.nextRunAt).toLocaleString()}</span>}
              {j.payloadMessage && <span style={{color:'#444',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',maxWidth:240}}>↳ {j.payloadMessage}</span>}
            </div>
          </div>
        ))}
        <div onClick={e=>{e.stopPropagation();window.__liveNewCron?.();}}
          style={{padding:'8px 12px',cursor:'pointer',display:'flex',alignItems:'center',gap:6,opacity:0.5,transition:'opacity 0.15s'}}
          onMouseEnter={e=>e.currentTarget.style.opacity='1'}
          onMouseLeave={e=>e.currentTarget.style.opacity='0.5'}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color:'#a855f7'}}>＋</span>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#888'}}>New Cron Job</span>
        </div>
      </div>
    </div>
  );
}

/* ── Nodes List Node ── */
function NodesListNode({ data }) {
  const nodes = data.nodes || [];
  return (
    <div className="vf-node" style={{border:'1.5px solid #22d3ee',padding:0,overflow:'hidden',width:260,maxHeight:300,display:'flex',flexDirection:'column'}}>
      <Handle type="target" position={Position.Left} style={{background:'#22d3ee',border:'2px solid #22d3ee',width:10,height:10,top:24}}/>
      <div style={{padding:'10px 12px',borderBottom:'1px solid #1a1a1a',display:'flex',alignItems:'center',gap:8,flexShrink:0}}>
        <div style={{background:'color-mix(in srgb,#22d3ee 18%,#0a0a0a)',borderRadius:6,padding:5,display:'flex',fontSize:'0.85rem'}}>📱</div>
        <div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>Nodes</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem',color:'#22d3ee',marginTop:1}}>{nodes.length} paired</div>
        </div>
      </div>
      <div style={{overflowY:'auto',flex:1}}>
        {nodes.map(n => (
          <div key={n.id} style={{padding:'10px 12px',borderBottom:'1px solid #0e0e0e'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:4}}>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.72rem',color:'#ccc',fontWeight:600}}>{n.name}</span>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',color:'#22d3ee'}}>{n.platform}</span>
            </div>
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#555',marginBottom:3}}>{n.modelIdentifier || n.deviceFamily} · v{n.version}</div>
            {n.lastSeen && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.52rem',color:'#333',marginBottom:5}}>last seen {new Date(n.lastSeen).toLocaleString()}</div>}
            <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
              {(n.caps||[]).map(c => (
                <span key={c} style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.5rem',color:'#22d3ee',background:'rgba(34,211,238,0.08)',border:'1px solid rgba(34,211,238,0.2)',borderRadius:3,padding:'1px 5px'}}>{c}</span>
              ))}
            </div>
          </div>
        ))}
        {nodes.length === 0 && <div style={{padding:16,textAlign:'center',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#2a2a2a'}}>no nodes paired</div>}
      </div>
    </div>
  );
}

/* ── Models List Node ── */
function ModelsListNode({ data }) {
  const providers = data.providers || [];
  const C = '#f97316';
  return (
    <div className="vf-node" style={{border:`1.5px solid ${C}`,padding:0,overflow:'hidden',width:280,maxHeight:320,display:'flex',flexDirection:'column'}}>
      <Handle type="target" position={Position.Left} style={{background:C,border:`2px solid ${C}`,width:10,height:10,top:24}}/>
      <div style={{padding:'10px 12px',borderBottom:'1px solid #1a1a1a',display:'flex',alignItems:'center',gap:8,flexShrink:0}}>
        <div style={{background:'color-mix(in srgb,#f97316 18%,#0a0a0a)',borderRadius:6,padding:5,display:'flex',fontSize:'0.85rem'}}>🧠</div>
        <div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.75rem',color:'#e0e0e0'}}>Models</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem',color:C,marginTop:1}}>{providers.length} providers · {data.models?.length||0} models</div>
        </div>
      </div>
      <div style={{overflowY:'auto',flex:1}}>
        {providers.map(p => (
          <div key={p.id} style={{padding:'8px 12px',borderBottom:'1px solid #0e0e0e'}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:4}}>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.72rem',color:'#ccc',fontWeight:600}}>{p.id}</span>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.52rem',color:'#444'}}>{p.models?.length||0} models</span>
            </div>
            <div style={{display:'flex',gap:4,flexWrap:'wrap'}}>
              {(p.models||[]).map(m => (
                <span key={m.id} style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.5rem',color:C,background:'rgba(249,115,22,0.08)',border:'1px solid rgba(249,115,22,0.2)',borderRadius:3,padding:'1px 5px'}}>{m.id}</span>
              ))}
            </div>
          </div>
        ))}
        {providers.length === 0 && <div style={{padding:16,textAlign:'center',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#2a2a2a'}}>no providers configured</div>}
      </div>
    </div>
  );
}

/* ── Live Gateway Node — expandable sections ── */
function LiveGatewayNode({ data, selected }) {
  const sections = [
    { key:'agents',   label:'Agents',   count: data.agentCount||0,   color:'#818cf8' },
    { key:'skills',   label:'Skills',   count: data.skillCount||0,   color:'#4ade80' },
    { key:'channels', label:'Channels', count: data.channelCount||0, color:'#22d3ee' },
    { key:'sessions', label:'Sessions', count: data.sessionCount||0, color:'#f59e0b' },
    { key:'cron',     label:'Cron Jobs',count: data.cronCount||0,    color:'#a855f7' },
    { key:'nodes',    label:'Nodes',    count: data.nodeCount||0,    color:'#22d3ee' },
    { key:'models',   label:'Models',   count: data.modelCount||0,   color:'#f97316' },
  ];

  return (
    <div className={`vf-node${selected?' selected':''}`}
         style={{border:'1.5px solid #ff5c5c', minWidth:240, padding:0, overflow:'hidden'}}>
      <Handle type="source" position={Position.Right}
        style={{background:'#ff5c5c',border:'2px solid #ff5c5c',width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>
      <Handle type="target" position={Position.Left}
        style={{background:'#ff5c5c',border:'2px solid #ff5c5c',width:10,height:10,top:'50%',transform:'translateY(-50%)'}}/>

      {/* Header */}
      <div style={{display:'flex',alignItems:'center',gap:10,padding:'10px 14px',borderBottom:'1px solid #272727'}}>
        <div style={{background:'color-mix(in srgb,#ff5c5c 18%,#0a0a0a)',borderRadius:8,padding:7,display:'flex'}}>
          <IcoGateway/>
        </div>
        <div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:'0.8rem',color:'#e0e0e0'}}>{data.label}</div>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.58rem',color:'#444',marginTop:1}}>
            port {data.port} · v{data.version}
          </div>
        </div>
        <div style={{marginLeft:'auto',display:'flex',alignItems:'center',gap:8}}>
          <span style={{width:7,height:7,borderRadius:'50%',background:'#4ade80',boxShadow:'0 0 8px #4ade8066'}}/>
          <span className="nodrag nopan"
            onMouseDown={e=>e.stopPropagation()}
            onClick={e=>{e.preventDefault();e.stopPropagation();window.__liveShowGateway?.();}}
            style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#444',cursor:'pointer',padding:'2px 6px',border:'1px solid #1e1e1e',borderRadius:4}}>⚙</span>
        </div>
      </div>

      {/* Overview stats — like admin main page */}
      <div style={{padding:'8px 14px',borderBottom:'1px solid #141414',display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}}>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem'}}>
          <span style={{color:'#333'}}>status </span><span style={{color:'#4ade80'}}>online</span>
        </div>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem'}}>
          <span style={{color:'#333'}}>ws </span><span style={{color:'#555'}}>:{data.port}</span>
        </div>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem'}}>
          <span style={{color:'#333'}}>sessions </span><span style={{color:'#f59e0b'}}>{data.sessionCount||0}</span>
        </div>
        <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.56rem'}}>
          <span style={{color:'#333'}}>cron </span><span style={{color:'#a855f7'}}>{data.cronCount||0} jobs</span>
        </div>
      </div>

      {/* Expandable sections */}
      {sections.map(s => {
        const expanded = data.expanded?.[s.key];
        return (
          <div key={s.key}
            className="nodrag nopan"
            onMouseDown={e => e.stopPropagation()}
            onClick={e => { e.preventDefault(); e.stopPropagation(); window.__liveToggle?.(s.key); }}
            style={{
              display:'flex', alignItems:'center', justifyContent:'space-between',
              padding:'8px 14px', cursor:'pointer',
              borderBottom:'1px solid #141414',
              background: expanded ? `color-mix(in srgb,${s.color} 6%,#0a0a0a)` : 'transparent',
              transition:'background 0.15s',
            }}>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{width:6,height:6,borderRadius:'50%',background: expanded ? s.color : '#2a2a2a',transition:'all 0.2s',boxShadow: expanded ? `0 0 6px ${s.color}88` : 'none'}}/>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color: expanded ? '#ccc' : '#555'}}>{s.label}</span>
            </div>
            <div style={{display:'flex',alignItems:'center',gap:8}}>
              <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.62rem',color: expanded ? s.color : '#333'}}>{s.count}</span>
              <span style={{color: expanded ? s.color : '#333',fontSize:'0.65rem',transition:'transform 0.2s',display:'inline-block',transform: expanded ? 'rotate(90deg)' : 'none'}}>▶</span>
            </div>
          </div>
        );
      })}
    </div>
  );
}

/* ── Skill category map ── */
const SKILL_CATS = {
  // Dev & Code
  'coding-agent':'Dev','github':'Dev','gh-issues':'Dev','ai-elements':'Dev',
  'clawhub':'Dev','skill-creator':'Dev','mcporter':'Dev','tmux':'Dev','oracle':'Dev',
  // Productivity
  'apple-notes':'Productivity','bear-notes':'Productivity','obsidian':'Productivity',
  'apple-reminders':'Productivity','things-mac':'Productivity','notion':'Productivity',
  'trello':'Productivity','summarize':'Productivity','session-logs':'Productivity','nano-pdf':'Productivity',
  // Messaging & Comms
  'himalaya':'Messaging','imap':'Messaging','discord':'Messaging','slack':'Messaging',
  'wacli':'Messaging','imsg':'Messaging','gog':'Messaging','bluebubbles':'Messaging','voice-call':'Messaging',
  // AI & Media
  'gemini':'AI','openai-image-gen':'AI','nano-banana-pro':'AI','model-usage':'AI',
  'openai-whisper':'AI','openai-whisper-api':'AI','sherpa-onnx-tts':'AI','sag':'AI',
  'video-frames':'AI','songsee':'AI','camsnap':'AI','gifgrep':'AI','spotify-player':'AI',
  // Smart Home
  'openhue':'Smart Home','eightctl':'Smart Home','blucli':'Smart Home',
  'sonoscli':'Smart Home','eigrnctl':'Smart Home',
  // System & Security
  'healthcheck':'System','peekaboo':'System','canvas':'System','1password':'System',
  'fieldkit':'System','find-skills':'System','gvg':'System',
  // Web & Info
  'blogwatcher':'Web','weather':'Web','goplaces':'Web','ordercli':'Web',
  'food-order':'Web','gifrep':'Web','gifgrep':'Web',
};
const SKILL_CAT_COLOR = {
  'Dev':'#818cf8','Productivity':'#f59e0b','Messaging':'#22d3ee',
  'AI':'#a855f7','Smart Home':'#4ade80','System':'#ef4444','Web':'#f97316',
  'Other':'#666',
};
function skillCat(id) { return SKILL_CATS[id] || 'Other'; }

/* ── Family Tree: ~10 icon nodes + expandable children ── */
function buildFamilyTree(data, expandedIds = new Set(), edgeDash) {
  const E = (id, s, t, color='#666') => ({
    id, source:s, target:t, type:'default',
    style:{ stroke:color, strokeWidth:2.5, opacity:0.85,
      ...(edgeDash ? { strokeDasharray: edgeDash } : {}) },
  });

  const nodes = [{
    id:'live-server', type:'collapsedserver', position:{x:0,y:0},
    data:{
      label: data.gateway?.name || 'OpenClaw Gateway',
      agentCount: data.agents?.length || 0,
      skillCount: data.skills?.filter(s=>s.enabled!==false).length || 0,
      channelCount: data.channels?.length || 0,
      cronCount: data.cronJobs?.length || 0,
    },
  }];
  const edges = [];

  // Agents — one parent group node
  const agents = data.agents || [];
  if (agents.length > 0) {
    const activeAgents = agents.filter(a => a.enabled !== false).length;
    nodes.push({ id:'ft-agents-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${agents.length} Agent${agents.length===1?'':'s'}`, category:'agent', enabled:activeAgents>0, expandable:true, expanded:expandedIds.has('ft-agents-group') } });
    edges.push(E('e-agents-group', 'live-server', 'ft-agents-group', '#818cf8'));
    if (expandedIds.has('ft-agents-group')) {
      // Compute session counts per agent
      const sessionsByAgent = {};
      (data.sessions||[]).forEach(s => { sessionsByAgent[s.agentId||'main'] = (sessionsByAgent[s.agentId||'main']||0) + 1; });
      agents.forEach((ag,i) => {
        const agId = `ft-ag-${ag.id||i}`;
        const sessCnt = sessionsByAgent[ag.id] || 0;
        nodes.push({ id:agId, type:'treeicon', position:{x:0,y:0},
          data:{ label:ag.name||ag.id||'Agent', category:'agent', enabled:ag.enabled!==false,
                 expandable:true, expanded:expandedIds.has(agId),
                 badge: sessCnt > 0 ? `${sessCnt} session${sessCnt===1?'':'s'}` : undefined,
                 _nodeType:'agent', ...ag } });
        edges.push(E(`e-ag-${i}`, 'ft-agents-group', agId, '#818cf8'));
        if (expandedIds.has(agId)) {
          if (ag.model) {
            const mId = `ft-model-${i}`;
            nodes.push({ id:mId, type:'treeicon', position:{x:0,y:0},
              data:{ label:ag.model.split('/').pop(), category:'model', enabled:true } });
            edges.push(E(`e-model-${i}`, agId, mId, '#f59e0b'));
          }
          (ag.fallbackModels||[]).forEach((fm,j) => {
            const fmId = `ft-fm-${i}-${j}`;
            nodes.push({ id:fmId, type:'treeicon', position:{x:0,y:0},
              data:{ label:fm.split('/').pop(), category:'model', enabled:true } });
            edges.push(E(`e-fm-${i}-${j}`, agId, fmId, '#f59e0b'));
          });
        }
      });
    }
  }

  // Channels — one parent group node
  const channels = data.channels || [];
  if (channels.length > 0) {
    const activeChannels = channels.filter(c => c.enabled !== false).length;
    nodes.push({ id:'ft-channels-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${channels.length} Channel${channels.length===1?'':'s'}`, category:'channel', enabled:activeChannels>0, expandable:true, expanded:expandedIds.has('ft-channels-group') } });
    edges.push(E('e-channels-group', 'live-server', 'ft-channels-group', '#22d3ee'));
    if (expandedIds.has('ft-channels-group')) {
      channels.forEach((ch,i) => {
        const id = `ft-ch-${ch.id||i}`;
        nodes.push({ id, type:'treeicon', position:{x:0,y:0},
          data:{ label:ch.type||ch.id||'Channel', category:'channel', enabled:ch.enabled!==false,
                 _nodeType:'channel', ...ch } });
        edges.push(E(`e-ch-${i}`, 'ft-channels-group', id, '#22d3ee'));
      });
      // "New channel" add button
      nodes.push({ id:'ft-ch-new', type:'treeicon', position:{x:0,y:0},
        data:{ label:'＋ Add Channel', category:'channel', enabled:true, _nodeType:'newchannel', _new:true } });
      edges.push(E('e-ch-new', 'ft-channels-group', 'ft-ch-new', '#22d3ee'));
    }
  }

  // Cron jobs — one parent group node, individual jobs hang off it
  const cronJobs = data.cronJobs || [];
  if (cronJobs.length > 0) {
    const activeCron = cronJobs.filter(j => j.enabled !== false).length;
    const nextJob = cronJobs.filter(j=>j.nextRunAt).sort((a,b) => new Date(a.nextRunAt)-new Date(b.nextRunAt))[0];
    const cronBadge = nextJob ? `next: ${new Date(nextJob.nextRunAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}` : `${cronJobs.length} total`;
    nodes.push({ id:'ft-cron-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${activeCron} Cron Jobs`, badge:cronBadge, category:'cron', enabled:activeCron>0, expandable:true, expanded:expandedIds.has('ft-cron-group') } });
    edges.push(E('e-cron-group', 'live-server', 'ft-cron-group', '#a855f7'));
    if (expandedIds.has('ft-cron-group')) {
      cronJobs.forEach((job,i) => {
        const id = `ft-cr-${job.id||i}`;
        const schedLabel = job.schedule?.kind === 'cron' ? job.schedule.expr
          : job.schedule?.kind === 'every' ? `every ${Math.round((job.schedule.everyMs||0)/60000)}m`
          : job.schedule?.kind || 'scheduled';
        nodes.push({ id, type:'treeicon', position:{x:0,y:0},
          data:{ label:job.name||job.id||'Cron', category:'cron', enabled:job.enabled!==false,
                 expandable:true, expanded:expandedIds.has(id),
                 _nodeType:'cronlist', ...job } });
        edges.push(E(`e-cr-${i}`, 'ft-cron-group', id, '#a855f7'));
        if (expandedIds.has(id)) {
          const schedId = `${id}-sched`;
          nodes.push({ id:schedId, type:'treeicon', position:{x:0,y:0},
            data:{ label:schedLabel, category:'cron', enabled:job.enabled!==false } });
          edges.push(E(`e-cr-sched-${i}`, id, schedId, '#a855f7'));
        }
      });
    }
  }

  // Paired devices — one parent group node
  const pairedNodes = data.nodes || [];
  if (pairedNodes.length > 0) {
    nodes.push({ id:'ft-nodes-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${pairedNodes.length} Node${pairedNodes.length===1?'':'s'}`, category:'node', enabled:true, expandable:true, expanded:expandedIds.has('ft-nodes-group') } });
    edges.push(E('e-nodes-group', 'live-server', 'ft-nodes-group', '#22d3ee'));
    if (expandedIds.has('ft-nodes-group')) {
      pairedNodes.forEach((nd,i) => {
        const id = `ft-nd-${nd.id||i}`;
        nodes.push({ id, type:'treeicon', position:{x:0,y:0},
          data:{ label:nd.name||nd.id||'Node', category:'node', enabled:true } });
        edges.push(E(`e-nd-${i}`, 'ft-nodes-group', id, '#22d3ee'));
      });
    }
  }

  // Skills — summary node → category groups → individual skills
  const enabledSkills = (data.skills||[]).filter(s=>s.enabled!==false);
  if (enabledSkills.length > 0) {
    nodes.push({ id:'ft-skills', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${enabledSkills.length} Skills`, category:'skill', enabled:true, expandable:true, expanded:expandedIds.has('ft-skills') } });
    edges.push(E('e-skills', 'live-server', 'ft-skills', '#4ade80'));
    if (expandedIds.has('ft-skills')) {
      // Group by category
      const cats = {};
      enabledSkills.forEach(sk => {
        const c = skillCat(sk.id||sk.name||'');
        if (!cats[c]) cats[c] = [];
        cats[c].push(sk);
      });
      Object.entries(cats).forEach(([cat, skills], ci) => {
        const catId = `ft-skcat-${cat.replace(/\s+/g,'-').toLowerCase()}`;
        const catColor = SKILL_CAT_COLOR[cat] || SKILL_CAT_COLOR['Other'];
        nodes.push({ id:catId, type:'treeicon', position:{x:0,y:0},
          data:{ label:`${cat} (${skills.length})`, category:'skill', enabled:true,
                 expandable:true, expanded:expandedIds.has(catId), color:catColor } });
        edges.push(E(`e-skcat-${ci}`, 'ft-skills', catId, catColor));
        if (expandedIds.has(catId)) {
          skills.forEach((sk,i) => {
            const skId = `ft-sk-${catId}-${i}`;
            nodes.push({ id:skId, type:'treeicon', position:{x:0,y:0},
              data:{ label:sk.id||sk.name||'Skill', category:'skill', enabled:sk.enabled!==false,
                     skillId:sk.id, description:sk.description||'', _nodeType:'singleskill' } });
            edges.push(E(`e-sk-${catId}-${i}`, catId, skId, catColor));
          });
        }
      });
    }
  }

  // Sessions — collapsible group → individual session entries
  const sessions = data.sessions || [];
  if (sessions.length > 0) {
    const totalMsgs = sessions.reduce((s, x) => s + (x.messageCount||0), 0);
    const recentSession = sessions[0];
    const sessionBadge = recentSession?.lastActive
      ? `last: ${(() => { const d=Date.now()-new Date(recentSession.lastActive); return d<3600000?`${Math.floor(d/60000)}m ago`:d<86400000?`${Math.floor(d/3600000)}h ago`:`${Math.floor(d/86400000)}d ago`; })()}`
      : `${totalMsgs} messages`;
    nodes.push({ id:'ft-sessions-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${sessions.length} Sessions`, badge:sessionBadge,
             category:'session', enabled:true, expandable:true, expanded:expandedIds.has('ft-sessions-group') } });
    edges.push(E('e-sessions-group', 'live-server', 'ft-sessions-group', '#f59e0b'));
    if (expandedIds.has('ft-sessions-group')) {
      sessions.forEach((s,i) => {
        const id = `ft-ss-${s.id||i}`;
        const fmtTime = iso => {
          if (!iso) return '';
          const diff = Date.now() - new Date(iso);
          if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
          if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
          return new Date(iso).toLocaleDateString();
        };
        nodes.push({ id, type:'treeicon', position:{x:0,y:0},
          data:{ label:s.id?.slice(0,16)||`session-${i}`, category:'session', enabled:true,
                 _nodeType:'session', _session: s,
                 badge: `${s.messageCount||0} msg · ${fmtTime(s.lastActive)}` } });
        edges.push(E(`e-ss-${i}`, 'ft-sessions-group', id, '#f59e0b'));
      });
    }
  }

  // System / Commands node
  nodes.push({ id:'ft-commands', type:'treeicon', position:{x:0,y:0},
    data:{ label:'System Config', category:'command', enabled:true, _nodeType:'commands',
           _config: { commands: data.config?.commands, web: data.config?.web, talk: data.config?.talk } } });
  edges.push(E('e-commands', 'live-server', 'ft-commands', '#a855f7'));

  // Model providers — one parent node → provider children → model leaves
  const providers = data.modelProviders || [];
  if (providers.length > 0) {
    const totalModels = providers.reduce((s,p) => s + (p.models?.length||0), 0);
    nodes.push({ id:'ft-models-group', type:'treeicon', position:{x:0,y:0},
      data:{ label:`${providers.length} Provider${providers.length===1?'':'s'}`,
             badge:`${totalModels} models configured`,
             category:'model', enabled:true, expandable:true, expanded:expandedIds.has('ft-models-group'),
             _nodeType:'modelslist', providers, models: data.models||[] } });
    edges.push(E('e-models-group', 'live-server', 'ft-models-group', '#f97316'));
    if (expandedIds.has('ft-models-group')) {
      providers.forEach((prov,i) => {
        const provId = `ft-prov-${prov.id||i}`;
        nodes.push({ id:provId, type:'treeicon', position:{x:0,y:0},
          data:{ label:prov.id, category:'model', enabled:true, expandable:(prov.models?.length||0)>0,
                 expanded:expandedIds.has(provId) } });
        edges.push(E(`e-prov-${i}`, 'ft-models-group', provId, '#f97316'));
        if (expandedIds.has(provId)) {
          (prov.models||[]).forEach((m,j) => {
            const mId = `ft-pm-${prov.id}-${j}`;
            nodes.push({ id:mId, type:'treeicon', position:{x:0,y:0},
              data:{ label:m.name||m.id, category:'model', enabled:true } });
            edges.push(E(`e-pm-${prov.id}-${j}`, provId, mId, '#f97316'));
          });
        }
      });
    }
  }

  return { nodes, edges };
}

/* ── Live Mode: gateway + all section nodes visible but collapsed ── */
function buildLiveInitial(data) {
  const EDGE = (id,s,t,color,active=true) => ({
    id, source:s, target:t, type:'smoothstep',
    style:{stroke:active?color:'#2a2a2a', strokeWidth:active?1.5:1, opacity:active?0.65:0.2},
    animated: active,
  });

  const sections = [
    { id:'live-sec-agents',   label:'Agents',    count: data.agents?.length||0,          color:'#818cf8', x:380,  y:-180 },
    { id:'live-sec-skills',   label:'Skills',    count: data.skills?.length||0,          color:'#4ade80', x:380,  y:-40  },
    { id:'live-sec-channels', label:'Channels',  count: data.channels?.length||0,        color:'#22d3ee', x:-380, y:-100 },
    { id:'live-sec-sessions', label:'Sessions',  count: data.sessions?.length||0,        color:'#f59e0b', x:380,  y:100  },
    { id:'live-sec-cron',     label:'Cron Jobs', count: data.cronJobs?.length||0,        color:'#a855f7', x:0,    y:300  },
    { id:'live-sec-nodes',    label:'Nodes',     count: data.nodes?.length||0,           color:'#22d3ee', x:-380, y:60   },
    { id:'live-sec-models',   label:'Models',    count: data.models?.length||0,          color:'#f97316', x:-380, y:220  },
  ];

  const nodes = [{
    id: 'live-gw',
    type: 'livegateway',
    position: { x: 0, y: 0 },
    data: {
      label: 'OpenClaw Gateway',
      port: data.gateway?.port,
      version: data.gateway?.version,
      agentCount:   data.agents?.length    || 0,
      skillCount:   data.skills?.length    || 0,
      channelCount: data.channels?.length  || 0,
      sessionCount: data.sessions?.length  || 0,
      cronCount:    data.cronJobs?.length  || 0,
      nodeCount:    data.nodes?.length     || 0,
      modelCount:   data.models?.length    || 0,
      expanded: {},
    },
  }];

  const edges = [];

  // Add collapsed section nodes
  sections.forEach(s => {
    nodes.push({
      id: s.id,
      type: 'sectioncard',
      position: { x: s.x, y: s.y },
      data: { label: s.label, count: s.count, color: s.color, sectionKey: s.id.replace('live-sec-','') },
    });
    edges.push(EDGE(`e-${s.id}`, 'live-gw', s.id, s.color, s.count > 0));
  });

  return { nodes, edges };
}

function buildExpandedNodes(section, data, currentExpanded) {
  const addNodes = [];
  const addEdges = [];
  const EDGE = (id,s,t,color,active=true) => ({
    id, source:s, target:t, type:'smoothstep',
    style:{stroke:active?color:'#2a2a2a', strokeWidth:active?1.5:1, opacity:active?0.65:0.2},
    animated: active,
  });

  if (section === 'agents') {
    (data.agents||[]).forEach((ag,i) => {
      const total = data.agents.length;
      const angle = (i / total) * Math.PI * 0.8 - Math.PI * 0.4;
      const x = 380 + Math.sin(angle) * 60;
      const y = (i - (total-1)/2) * 160;
      addNodes.push({ id:`live-ag-${ag.id}`, type:'agent', position:{x,y},
        data:{
          label: ag.name||ag.id,
          model: ag.model,
          agentId: ag.id,
          enabled: ag.enabled,
          liveAgent: true,
          workspace: ag.workspace,
          systemPrompt: ag.systemPrompt,
          thinking: ag.thinking,
          fallbackModels: ag.fallbackModels,
        } });
      addEdges.push(EDGE(`eag-${ag.id}`,'live-gw',`live-ag-${ag.id}`,'#818cf8', ag.enabled!==false));
    });
  }

  if (section === 'skills') {
    addNodes.push({ id:'live-skills', type:'skillslist', position:{x:380, y:-280},
      data:{ skills: data.skills || [] } });
    addEdges.push(EDGE('eskills','live-gw','live-skills','#4ade80'));
  }

  if (section === 'channels') {
    (data.channels||[]).forEach((ch,i) => {
      const total = data.channels.length;
      const y = (i - (total-1)/2) * 140;
      const { id: _id, ...chConfig } = ch;
      addNodes.push({ id:`live-ch-${ch.id}`, type:'channel', position:{x:-360,y},
        data:{ label:ch.type||ch.id, enabled:ch.enabled, ...chConfig } });
      addEdges.push(EDGE(`ech-${ch.id}`,`live-ch-${ch.id}`,'live-gw','#22d3ee', ch.enabled!==false));
    });
  }

  if (section === 'sessions') {
    addNodes.push({ id:'live-sessions', type:'sessionslist', position:{x:420, y:280},
      data:{ sessions: data.sessions||[] } });
    addEdges.push(EDGE('esessions','live-gw','live-sessions','#f59e0b'));
  }

  if (section === 'cron') {
    const anyActive = (data.cronJobs||[]).some(j => j.enabled !== false);
    addNodes.push({ id:'live-cron', type:'cronlist', position:{x:0, y:360},
      data:{ cronJobs: data.cronJobs||[] } });
    addEdges.push(EDGE('ecron','live-gw','live-cron','#a855f7', anyActive));
  }

  if (section === 'nodes') {
    addNodes.push({ id:'live-nodes', type:'nodeslist', position:{x:-420, y:-240},
      data:{ nodes: data.nodes||[] } });
    addEdges.push(EDGE('enodes','live-gw','live-nodes','#22d3ee'));
  }

  if (section === 'models') {
    addNodes.push({ id:'live-models', type:'modelslist', position:{x:0, y:-380},
      data:{ providers: data.modelProviders||[], models: data.models||[] } });
    addEdges.push(EDGE('emodels','live-gw','live-models','#f97316'));
  }

  return { addNodes, addEdges };
}

/* ── Live Skill Panel (replaces ConfigPanel in live mode) ── */
function LiveSkillPanel({ agent, skills, onClose, onToggleSkill }) {
  const [filter, setFilter] = React.useState('');
  const [toggling, setToggling] = React.useState({});

  if (!agent) return (
    <div style={{width:0,overflow:'hidden',background:'rgba(10,10,10,0.97)',borderLeft:'1px solid #1c1c1c',transition:'width 0.2s'}} />
  );

  const filtered = skills.filter(s =>
    !filter || s.id.toLowerCase().includes(filter.toLowerCase())
  );
  const enabled = filtered.filter(s => s.enabled);
  const disabled = filtered.filter(s => !s.enabled);

  const handleToggle = async (skill) => {
    setToggling(t => ({...t, [skill.id]: true}));
    try {
      await fetch('/api/gateway-patch', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          patch: { skills: { entries: { [skill.id]: { enabled: !skill.enabled } } } }
        }),
      });
      onToggleSkill(skill.id, !skill.enabled);
    } catch(e) { console.error('Patch failed', e); }
    setToggling(t => ({...t, [skill.id]: false}));
  };

  const SkillRow = ({ s }) => (
    <div style={{
      display:'flex', alignItems:'center', justifyContent:'space-between',
      padding:'7px 14px',
      borderBottom:'1px solid #141414',
      opacity: toggling[s.id] ? 0.5 : 1,
      transition:'opacity 0.15s',
    }}>
      <div style={{display:'flex',alignItems:'center',gap:8}}>
        <span style={{
          width:6, height:6, borderRadius:'50%', flexShrink:0,
          background: s.enabled ? '#4ade80' : '#333',
          boxShadow: s.enabled ? '0 0 6px #4ade8088' : 'none',
          transition:'all 0.2s',
        }}/>
        <span style={{
          fontFamily:"'JetBrains Mono',monospace", fontSize:'0.72rem',
          color: s.enabled ? '#ccc' : '#444',
          transition:'color 0.2s',
        }}>{s.id}</span>
      </div>
      <button onClick={() => handleToggle(s)} disabled={!!toggling[s.id]} style={{
        background:'none', border:`1px solid ${s.enabled ? '#2a5c3a' : '#2a2a2a'}`,
        borderRadius:20, padding:'2px 10px', cursor:'pointer',
        fontFamily:"'JetBrains Mono',monospace", fontSize:'0.58rem',
        color: s.enabled ? '#4ade80' : '#444',
        transition:'all 0.15s',
      }}>
        {toggling[s.id] ? '…' : s.enabled ? 'on' : 'off'}
      </button>
    </div>
  );

  return (
    <div style={{
      width:'100%', display:'flex', flexDirection:'column',
      background:'rgba(22,22,22,0.99)', overflow:'hidden', height:'100%',
    }}>
      {/* Header */}
      <div style={{padding:'12px 14px',borderBottom:'1px solid #272727',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
        <div>
          <div style={{fontSize:'0.82rem',fontWeight:600,color:'#e0e0e0'}}>
            {agent.isSkillsView ? '🔧 Skills' : `🤖 ${agent.label}`}
          </div>
          {!agent.isSkillsView && (
            <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#888',marginTop:2}}>{agent.model}</div>
          )}
        </div>
        <button onClick={onClose} style={{background:'none',border:'none',color:'#444',fontSize:'1.1rem',cursor:'pointer',padding:'2px 6px'}}>×</button>
      </div>
      {/* Stats bar */}
      <div style={{padding:'8px 14px',borderBottom:'1px solid #272727',display:'flex',gap:14}}>
        <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#4ade80'}}>
          ◉ {enabled.length} on
        </span>
        <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#777'}}>
          ○ {disabled.length} off
        </span>
        <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#555'}}>
          {skills.length} total
        </span>
      </div>
      {/* Search */}
      <div style={{padding:'8px 14px',borderBottom:'1px solid #272727'}}>
        <input
          placeholder="filter skills…"
          value={filter} onChange={e => setFilter(e.target.value)}
          style={{
            width:'100%', background:'#0e0e0e', border:'1px solid #1e1e1e',
            borderRadius:5, padding:'5px 9px', color:'#aaa', outline:'none',
            fontFamily:"'JetBrains Mono',monospace", fontSize:'0.7rem', boxSizing:'border-box',
          }}
        />
      </div>
      {/* Skill list */}
      <div style={{overflowY:'auto',flex:1}}>
        {enabled.length > 0 && (
          <>
            <div style={{padding:'6px 14px 2px',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',textTransform:'uppercase',letterSpacing:'0.1em',color:'#2a2a2a'}}>Active</div>
            {enabled.map(s => <SkillRow key={s.id} s={s}/>)}
          </>
        )}
        {disabled.length > 0 && (
          <>
            <div style={{padding:'10px 14px 2px',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.55rem',textTransform:'uppercase',letterSpacing:'0.1em',color:'#2a2a2a'}}>Disabled</div>
            {disabled.map(s => <SkillRow key={s.id} s={s}/>)}
          </>
        )}
        {filtered.length === 0 && (
          <div style={{padding:24,textAlign:'center',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color:'#333'}}>no skills match</div>
        )}
      </div>
    </div>
  );
}

/* ── Shared edit panel shell ── */
const panelInput = {
  background:'#1a1a1a', border:'1px solid #2e2e2e', borderRadius:6,
  color:'#e8e8e8', padding:'8px 12px', fontFamily:"'JetBrains Mono',monospace",
  fontSize:'0.9rem', width:'100%', outline:'none', boxSizing:'border-box',
};
const panelLabel = { fontFamily:"'JetBrains Mono',monospace", fontSize:'0.72rem',
  textTransform:'uppercase', letterSpacing:'0.08em', color:'#999', display:'block', marginBottom:5 };
const panelField = ({ label, children }) => (
  <div style={{marginBottom:12}}>
    <span style={panelLabel}>{label}</span>
    {children}
  </div>
);
function PanelShell({ emoji, title, subtitle, subtitleColor='#4ade80', onClose, children, saving, onSave, saveStatus }) {
  return (
    <div style={{width:'100%',display:'flex',flexDirection:'column',background:'rgba(22,22,22,0.99)',overflow:'hidden',height:'100%'}}>
      <div style={{padding:'12px 14px',borderBottom:'1px solid #272727',display:'flex',alignItems:'center',justifyContent:'space-between',flexShrink:0}}>
        <div>
          <div style={{fontSize:'0.82rem',fontWeight:600,color:'#f0f0f0'}}>{emoji} {title}</div>
          {subtitle && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:subtitleColor,marginTop:2}}>{subtitle}</div>}
        </div>
        <button onClick={onClose} title="Deselect node" style={{background:'none',border:'1px solid #222',borderRadius:5,color:'#555',fontSize:'0.7rem',cursor:'pointer',padding:'3px 7px',fontFamily:"'JetBrains Mono',monospace",lineHeight:1}}>← back</button>
      </div>
      <div style={{overflowY:'auto',flex:1,padding:16}}>{children}</div>
      {onSave && (
        <div style={{padding:'12px 16px',borderTop:'1px solid #272727',flexShrink:0}}>
          {saveStatus && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:saveStatus.startsWith('✓')?'#4ade80':'#ef4444',marginBottom:8,textAlign:'center'}}>{saveStatus}</div>}
          <button onClick={onSave} disabled={saving} style={{
            width:'100%',background:'#ff5c5c',border:'none',borderRadius:6,
            padding:'8px',color:'#000',fontFamily:"'JetBrains Mono',monospace",
            fontSize:'0.72rem',fontWeight:700,cursor:'pointer',opacity:saving?0.6:1,
          }}>{saving ? 'Saving…' : '✓ Save Changes'}</button>
        </div>
      )}
    </div>
  );
}

/* ── Toggle helper ── */
function PanelToggle({ value, onChange }) {
  return (
    <div onClick={() => onChange(!value)} style={{
      width:36, height:20, borderRadius:10, cursor:'pointer', flexShrink:0,
      background: value ? '#4ade80' : '#2a2a2a',
      border: `1px solid ${value ? '#4ade80' : '#444'}`,
      position:'relative', transition:'all 0.2s',
    }}>
      <div style={{
        position:'absolute', top:2, left: value ? 16 : 2,
        width:14, height:14, borderRadius:'50%',
        background: value ? '#000' : '#666',
        transition:'left 0.2s',
      }}/>
    </div>
  );
}

/* ── Section divider ── */
function PanelSection({ label }) {
  return (
    <div style={{
      fontFamily:"'JetBrains Mono',monospace", fontSize:'0.7rem',
      color:'#777', textTransform:'uppercase', letterSpacing:'0.1em',
      borderBottom:'1px solid #2a2a2a', paddingBottom:6, marginBottom:10, marginTop:18,
    }}>{label}</div>
  );
}

/* ── Agent Edit Panel ── */
function LiveAgentPanel({ data, models, onClose, onSaved, onDeleted }) {
  const [agentName,    setAgentName]    = React.useState(data.label || data.agentId || '');
  const [model,        setModel]        = React.useState(data.model || '');
  const [fallbacks,    setFallbacks]    = React.useState((data.fallbackModels||[]).join('\n'));
  const [thinking,     setThinking]     = React.useState(data.thinking || '');
  const [workspace,    setWorkspace]    = React.useState(data.workspace || '');
  const [maxConc,      setMaxConc]      = React.useState(data.maxConcurrent ?? 4);
  const [compaction,   setCompaction]   = React.useState(data.compaction?.mode || 'safeguard');
  const [subModel,     setSubModel]     = React.useState(data.subagents?.model || data.model || '');
  const [subMaxConc,   setSubMaxConc]   = React.useState(data.subagents?.maxConcurrent ?? 8);
  const [memEnabled,   setMemEnabled]   = React.useState(data.memorySearch?.enabled !== false);
  const [memSession,   setMemSession]   = React.useState(data.memorySearch?.experimental?.sessionMemory === true);
  const [memCache,     setMemCache]     = React.useState(data.memorySearch?.cache?.enabled !== false);
  const [memProvider,  setMemProvider]  = React.useState(data.memorySearch?.provider || 'gemini');
  const [memModel,     setMemModel]     = React.useState(data.memorySearch?.model || 'gemini-embedding-001');
  const [prompt,       setPrompt]       = React.useState(data.systemPrompt || '');
  const [saving,       setSaving]       = React.useState(false);
  const [saveStatus,   setSaveStatus]   = React.useState('');
  const [deleting,     setDeleting]     = React.useState(false);
  const [confirmDel,   setConfirmDel]   = React.useState(false);

  const modelList = models?.map(m => `${m.provider}/${m.id}`) || [];

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      const fallbackList = fallbacks.split('\n').map(s=>s.trim()).filter(Boolean);
      const r = await fetch('/api/gateway-patch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ agentPatch: {
          agentId: data.agentId || 'main',
          patch: {
            name: agentName,
            model,
            fallbackModels: fallbackList,
            thinking: thinking || undefined,
            workspace,
            maxConcurrent: Number(maxConc),
            compaction: { mode: compaction },
            subagents: { model: subModel, maxConcurrent: Number(subMaxConc) },
            memorySearch: {
              enabled: memEnabled,
              provider: memProvider,
              model: memModel,
              cache: { enabled: memCache },
              experimental: { sessionMemory: memSession },
            },
            systemPrompt: prompt,
          },
        }}),
      });
      const d = await r.json();
      setSaveStatus(d.ok ? '✓ Saved — restart to apply' : `✗ ${d.error}`);
      if (d.ok) onSaved?.({ model, systemPrompt: prompt, workspace });
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 4000);
  };

  const MS = (v, onChange, placeholder='') => (
    <input value={v} onChange={e=>onChange(e.target.value)} style={panelInput} placeholder={placeholder}/>
  );
  const SEL = (v, onChange, opts) => (
    <select value={v} onChange={e=>onChange(e.target.value)} style={panelInput}>
      {opts.map(([val,label]) => <option key={val} value={val}>{label}</option>)}
      {!opts.find(([val])=>val===v) && <option value={v}>{v}</option>}
    </select>
  );
  const TOG = (v, onChange, label) => (
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
      <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.88rem',color:'#bbb'}}>{label}</span>
      <PanelToggle value={v} onChange={onChange}/>
    </div>
  );

  return (
    <PanelShell emoji="🤖" title={data.label||'Agent'} subtitle={`${data.agentId||'main'} · ${model.split('/').pop()}`} onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      <PanelSection label="Identity"/>
      {panelField({ label:'Agent ID', children: <input value={data.agentId||'main'} disabled style={{...panelInput,opacity:0.35,cursor:'not-allowed'}}/> })}
      {panelField({ label:'Display Name', children: MS(agentName, setAgentName, 'e.g. Cynthia') })}

      <PanelSection label="Models"/>
      {panelField({ label:'Primary', children: SEL(model, setModel, modelList.map(m=>[m,m])) })}
      {panelField({ label:'Fallbacks', children:
        <>
          <textarea value={fallbacks} onChange={e=>setFallbacks(e.target.value)} rows={3}
            style={{...panelInput,resize:'vertical',lineHeight:1.6}} placeholder={'one per line — used if primary fails'}/>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',marginTop:3}}>tried in order if primary rate-limits or errors</div>
        </>
      })}
      {panelField({ label:'Thinking', children: SEL(thinking, setThinking, [['','off'],['low','low'],['medium','medium'],['high','high']]) })}

      <PanelSection label="Concurrency"/>
      {panelField({ label:'Max Concurrent', children: <input type="number" min={1} max={32} value={maxConc} onChange={e=>setMaxConc(e.target.value)} style={panelInput}/> })}
      {panelField({ label:'Compaction', children: SEL(compaction, setCompaction, [['safeguard','safeguard'],['aggressive','aggressive'],['off','off']]) })}

      <PanelSection label="Subagents"/>
      {panelField({ label:'Sub Max Concurrent', children: <input type="number" min={1} max={64} value={subMaxConc} onChange={e=>setSubMaxConc(e.target.value)} style={panelInput}/> })}
      {panelField({ label:'Sub Model', children: SEL(subModel, setSubModel, modelList.map(m=>[m,m])) })}

      <PanelSection label="Memory Search"/>
      {TOG(memEnabled, setMemEnabled, 'Enabled')}
      {memEnabled && <>
        {TOG(memSession, setMemSession, 'Session Memory (experimental)')}
        {TOG(memCache, setMemCache, 'Cache')}
        {panelField({ label:'Provider', children: MS(memProvider, setMemProvider, 'gemini') })}
        {panelField({ label:'Embedding Model', children: MS(memModel, setMemModel, 'gemini-embedding-001') })}
      </>}

      <PanelSection label="Workspace"/>
      {panelField({ label:'Path', children: MS(workspace, setWorkspace, '/path/to/workspace') })}

      <PanelSection label="System Prompt"/>
      <textarea value={prompt} onChange={e=>setPrompt(e.target.value)} rows={8}
        style={{...panelInput,resize:'vertical',lineHeight:1.5,width:'100%',boxSizing:'border-box'}}
        placeholder={'Leave empty to use workspace SOUL.md / AGENTS.md'}/>
      <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',marginTop:3}}>workspace files override this at runtime</div>

      {data.agentId && data.agentId !== 'main' && data.agentId !== 'defaults' && (
        <>
          <PanelSection label="Danger Zone"/>
          {confirmDel
            ? <div style={{display:'flex',gap:6}}>
                <button onClick={async () => {
                  setDeleting(true);
                  await fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ agentDelete: { agentId: data.agentId } }) });
                  setDeleting(false);
                  onDeleted?.();
                }} disabled={deleting} style={{flex:1,background:'#7f1d1d',border:'1px solid #ef4444',borderRadius:5,padding:'7px',color:'#fca5a5',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>{deleting?'Deleting…':'⚠ Confirm Delete'}</button>
                <button onClick={()=>setConfirmDel(false)} style={{flex:1,background:'none',border:'1px solid #333',borderRadius:5,padding:'7px',color:'#666',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>Cancel</button>
              </div>
            : <button onClick={()=>setConfirmDel(true)} style={{width:'100%',background:'none',border:'1px solid #3a1818',borderRadius:5,padding:'7px',color:'#ef4444',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>✕ Delete Agent</button>
          }
        </>
      )}

    </PanelShell>
  );
}

/* ── Channel Edit Panel ── */
const CHANNEL_EMOJIS = { whatsapp:'💬', discord:'🎮', slack:'#️⃣', telegram:'✈️', sms:'📱', email:'✉️', web:'🌐', imessage:'💙', default:'📡' };
const CHANNEL_TYPES  = ['whatsapp','discord','slack','telegram','sms','email','web','imessage'];

function LiveChannelPanel({ data, onClose, onSaved, onDeleted, onCreated }) {
  const isNew       = !!data._new;
  const channelType = data.id || data.type || '';
  const POLICY_OPTS = [['allowlist','allowlist'],['all','allow all'],['none','block all']];

  // Create-mode fields
  const [newTypeSelect, setNewTypeSelect] = React.useState('whatsapp');
  const [customTypeId,  setCustomTypeId]  = React.useState('');
  const newType = newTypeSelect === 'custom' ? (customTypeId || 'custom') : newTypeSelect;

  // Common
  const [enabled,     setEnabled]     = React.useState(data.enabled !== false);
  const [dmPolicy,    setDmPolicy]    = React.useState(data.dmPolicy     || 'allowlist');
  const [groupPolicy, setGroupPolicy] = React.useState(data.groupPolicy  || 'allowlist');
  const [allowFrom,   setAllowFrom]   = React.useState((data.allowFrom||[]).join('\n'));
  const [selfChat,    setSelfChat]    = React.useState(data.selfChatMode === true);
  const [debounce,    setDebounce]    = React.useState(data.debounceMs   ?? 0);
  const [mediaMax,    setMediaMax]    = React.useState(data.mediaMaxMb   ?? 50);
  const [extraJson,   setExtraJson]   = React.useState('');

  // Per-account overrides (whatsapp only)
  const [accounts,       setAccounts]       = React.useState(Object.entries(data.accounts||{}).map(([id,cfg])=>({id,...cfg})));
  const [editingAcct,    setEditingAcct]    = React.useState(null);
  const [newAcctId,      setNewAcctId]      = React.useState('');
  const [addingAcct,     setAddingAcct]     = React.useState(false);

  // Danger zone
  const [confirmDel,  setConfirmDel]  = React.useState(false);
  const [deleting,    setDeleting]    = React.useState(false);
  const [saving,      setSaving]      = React.useState(false);
  const [saveStatus,  setSaveStatus]  = React.useState('');

  const patch = async (body) => fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      const chId = isNew ? newType : channelType;
      const cfg = {
        enabled, dmPolicy, groupPolicy,
        allowFrom: allowFrom.split('\n').map(s=>s.trim()).filter(Boolean),
        selfChatMode: selfChat,
        debounceMs: Number(debounce),
        mediaMaxMb: Number(mediaMax),
      };
      if (extraJson.trim()) { try { Object.assign(cfg, JSON.parse(extraJson)); } catch {} }

      const r = isNew
        ? await patch({ channelCreate: { channelId: chId, channel: cfg } })
        : await patch({ channelPatch:  { channelId: chId, patch: cfg  } });

      setSaveStatus(r.ok ? '✓ Saved — restart to apply' : `✗ ${r.error}`);
      if (r.ok) { if (isNew) onCreated?.({ id: chId, type: chId, ...cfg }); else onSaved?.(); }
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 3000);
  };

  const saveAccount = async (acctId, acctPatch) => {
    await patch({ channelAccountPatch: { channelId: channelType, accountId: acctId, patch: acctPatch } });
  };

  const deleteAccount = async (acctId) => {
    await patch({ channelAccountDelete: { channelId: channelType, accountId: acctId } });
    setAccounts(prev => prev.filter(a => a.id !== acctId));
  };

  const addAccount = async () => {
    if (!newAcctId.trim()) return;
    const init = { dmPolicy: 'allowlist', groupPolicy: 'allowlist', debounceMs: 0 };
    await patch({ channelAccountPatch: { channelId: channelType, accountId: newAcctId.trim(), patch: init } });
    setAccounts(prev => [...prev, { id: newAcctId.trim(), ...init }]);
    setAddingAcct(false); setNewAcctId('');
  };

  const SEL = (v, onChange, opts) => (
    <select value={v} onChange={e=>onChange(e.target.value)} style={panelInput}>
      {opts.map(([val,label]) => <option key={val} value={val}>{label}</option>)}
    </select>
  );
  const TOG = (v, set, label) => (
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
      <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.88rem',color:'#bbb'}}>{label}</span>
      <PanelToggle value={v} onChange={set}/>
    </div>
  );

  const chEmoji = CHANNEL_EMOJIS[isNew ? newType : channelType] || CHANNEL_EMOJIS.default;
  const chTitle = isNew ? 'New Channel' : (data.label || channelType);

  return (
    <PanelShell emoji={chEmoji} title={chTitle} subtitle={isNew ? 'create' : (enabled?'enabled':'disabled')} subtitleColor={isNew ? '#22d3ee' : (enabled?'#4ade80':'#555')} onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      {isNew && (
        <>
          <PanelSection label="Channel Type"/>
          {panelField({ label:'Type', children:
            <select value={newTypeSelect} onChange={e=>setNewTypeSelect(e.target.value)} style={panelInput}>
              {CHANNEL_TYPES.map(t => <option key={t} value={t}>{CHANNEL_EMOJIS[t]||'📡'} {t}</option>)}
              <option value="custom">custom…</option>
            </select>
          })}
          {newTypeSelect === 'custom' && panelField({ label:'Custom ID', children:
            <input value={customTypeId} onChange={e=>setCustomTypeId(e.target.value)} style={panelInput} placeholder="e.g. signal"/>
          })}
        </>
      )}

      <PanelSection label="Status"/>
      {TOG(enabled, setEnabled, 'Enabled')}

      <PanelSection label="Policy"/>
      {panelField({ label:'DM Policy',    children: SEL(dmPolicy,    setDmPolicy,    POLICY_OPTS) })}
      {panelField({ label:'Group Policy', children: SEL(groupPolicy, setGroupPolicy, POLICY_OPTS) })}
      {TOG(selfChat, setSelfChat, 'Self Chat Mode')}

      <PanelSection label="Allowlist"/>
      {panelField({ label:'Allow From', children:
        <>
          <textarea value={allowFrom} onChange={e=>setAllowFrom(e.target.value)} rows={4}
            style={{...panelInput,resize:'vertical',lineHeight:1.7}}
            placeholder={'+447700900000\n+447700900001'}/>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',marginTop:3}}>one number per line · only used when dmPolicy = allowlist</div>
        </>
      })}

      <PanelSection label="Media & Timing"/>
      {panelField({ label:'Debounce (ms)',  children: <input type="number" min={0} value={debounce} onChange={e=>setDebounce(e.target.value)} style={panelInput}/> })}
      {panelField({ label:'Max Media (MB)', children: <input type="number" min={1} max={500} value={mediaMax} onChange={e=>setMediaMax(e.target.value)} style={panelInput}/> })}

      {!isNew && (
        <>
          <PanelSection label="Extra Config (JSON)"/>
          <textarea value={extraJson} onChange={e=>setExtraJson(e.target.value)} rows={3}
            style={{...panelInput,resize:'vertical',lineHeight:1.5}}
            placeholder={'{"customField": "value"}'}/>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',marginTop:3}}>merged on top of the above fields</div>
        </>
      )}

      {/* Per-account overrides — whatsapp only */}
      {!isNew && (channelType === 'whatsapp' || accounts.length > 0) && (
        <>
          <PanelSection label="Account Overrides"/>
          {accounts.map(acct => (
            <div key={acct.id} style={{background:'#141414',border:'1px solid #1e1e1e',borderRadius:6,marginBottom:8,overflow:'hidden'}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'6px 10px',borderBottom:'1px solid #1a1a1a'}}>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',color:'#22d3ee'}}>{acct.id}</span>
                <div style={{display:'flex',gap:4}}>
                  <button onClick={() => setEditingAcct(editingAcct?.id === acct.id ? null : {...acct})}
                    style={{background:'none',border:'1px solid #2a2a2a',borderRadius:3,padding:'2px 7px',color:'#888',fontSize:'0.58rem',cursor:'pointer',fontFamily:"'JetBrains Mono',monospace"}}>
                    {editingAcct?.id === acct.id ? 'done' : '⚙ edit'}
                  </button>
                  <button onClick={() => deleteAccount(acct.id)}
                    style={{background:'none',border:'1px solid #3a1818',borderRadius:3,padding:'2px 7px',color:'#ef4444',fontSize:'0.58rem',cursor:'pointer'}}>✕</button>
                </div>
              </div>
              {editingAcct?.id === acct.id && (
                <div style={{padding:'8px 10px',display:'flex',flexDirection:'column',gap:6}}>
                  {panelField({ label:'DM Policy', children: SEL(editingAcct.dmPolicy||'allowlist', v=>setEditingAcct(a=>({...a,dmPolicy:v})), POLICY_OPTS) })}
                  {panelField({ label:'Group Policy', children: SEL(editingAcct.groupPolicy||'allowlist', v=>setEditingAcct(a=>({...a,groupPolicy:v})), POLICY_OPTS) })}
                  {panelField({ label:'Debounce (ms)', children: <input type="number" min={0} value={editingAcct.debounceMs??0} onChange={e=>setEditingAcct(a=>({...a,debounceMs:Number(e.target.value)}))} style={panelInput}/> })}
                  <button onClick={async () => {
                    const {id,...rest} = editingAcct;
                    await saveAccount(id, rest);
                    setAccounts(prev => prev.map(a => a.id === id ? {...a,...rest} : a));
                    setEditingAcct(null);
                  }} style={{background:'#22d3ee',border:'none',borderRadius:4,padding:'5px',color:'#000',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',fontWeight:700,cursor:'pointer'}}>
                    Save Override
                  </button>
                </div>
              )}
            </div>
          ))}
          {addingAcct ? (
            <div style={{display:'flex',gap:4,marginBottom:8}}>
              <input value={newAcctId} onChange={e=>setNewAcctId(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addAccount()}
                style={{...panelInput,flex:1,fontSize:'0.65rem'}} placeholder="account ID (e.g. custom-1)"/>
              <button onClick={addAccount} style={{background:'#22d3ee',border:'none',borderRadius:4,padding:'3px 8px',color:'#000',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',cursor:'pointer'}}>+</button>
              <button onClick={()=>{setAddingAcct(false);setNewAcctId('');}} style={{background:'none',border:'1px solid #333',borderRadius:4,padding:'3px 7px',color:'#666',fontSize:'0.65rem',cursor:'pointer'}}>✕</button>
            </div>
          ) : (
            <button onClick={()=>setAddingAcct(true)} style={{width:'100%',background:'none',border:'1px dashed #1e1e1e',borderRadius:5,padding:'5px',color:'#444',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.62rem',cursor:'pointer',marginBottom:8}}>+ add account override</button>
          )}
        </>
      )}

      {/* Danger zone — delete channel */}
      {!isNew && (
        <>
          <PanelSection label="Danger Zone"/>
          {confirmDel
            ? <div style={{display:'flex',gap:6}}>
                <button onClick={async () => {
                  setDeleting(true);
                  await patch({ channelDelete: { channelId: channelType } });
                  setDeleting(false);
                  onDeleted?.();
                }} disabled={deleting} style={{flex:1,background:'#7f1d1d',border:'1px solid #ef4444',borderRadius:5,padding:'7px',color:'#fca5a5',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>
                  {deleting ? 'Deleting…' : '⚠ Confirm Delete'}
                </button>
                <button onClick={()=>setConfirmDel(false)} style={{flex:1,background:'none',border:'1px solid #333',borderRadius:5,padding:'7px',color:'#666',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>Cancel</button>
              </div>
            : <button onClick={()=>setConfirmDel(true)} style={{width:'100%',background:'none',border:'1px solid #3a1818',borderRadius:5,padding:'7px',color:'#ef4444',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>✕ Remove Channel</button>
          }
        </>
      )}
    </PanelShell>
  );
}

/* ── Cron Edit Panel ── */
function LiveCronPanel({ data, onClose, onSaved, onCreated, onAgentList }) {
  const isNew = !data.id;
  const STATUS_COLOR = { ok:'#4ade80', error:'#ef4444', running:'#f59e0b' };

  // Editable state
  const [name,          setName]          = React.useState(data.name || '');
  const [enabled,       setEnabled]       = React.useState(data.enabled !== false);
  const [schedKind,     setSchedKind]     = React.useState(data.schedule?.kind || 'cron');
  const [schedExpr,     setSchedExpr]     = React.useState(data.schedule?.expr || '');
  const [schedEveryMin, setSchedEveryMin] = React.useState(data.schedule?.everyMs ? String(data.schedule.everyMs/60000) : '60');
  const [schedAt,       setSchedAt]       = React.useState(data.schedule?.at || '');
  const [sessionTarget, setSessionTarget] = React.useState(data.sessionTarget || 'isolated');
  const [payloadKind,   setPayloadKind]   = React.useState(data.payloadKind || data.payload?.kind || 'systemEvent');
  const [payloadMsg,    setPayloadMsg]    = React.useState(data.payloadMessage || data.payload?.text || data.payload?.message || '');
  const [deliveryMode,  setDeliveryMode]  = React.useState(data.deliveryMode || data.delivery?.mode || 'announce');
  const [deliveryTo,    setDeliveryTo]    = React.useState(data.delivery?.to || data.delivery?.channel || '');

  const [saving,      setSaving]      = React.useState(false);
  const [saveStatus,  setSaveStatus]  = React.useState('');
  const [triggering,  setTriggering]  = React.useState(false);
  const [deletingJob, setDeletingJob] = React.useState(false);
  const [confirmJob,  setConfirmJob]  = React.useState(false);

  const sel = (val, set, opts) => (
    <select value={val} onChange={e=>set(e.target.value)} style={panelInput}>
      {opts.map(([v,l])=><option key={v} value={v}>{l}</option>)}
    </select>
  );

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      const schedule =
        schedKind === 'cron'  ? { kind:'cron',  expr:schedExpr } :
        schedKind === 'every' ? { kind:'every', everyMs:Math.round(parseFloat(schedEveryMin)*60000) } :
                                { kind:'at',    at:schedAt };
      const payload =
        payloadKind === 'systemEvent' ? { kind:'systemEvent', text:payloadMsg } :
                                        { kind:'agentTurn',   message:payloadMsg };
      const delivery = deliveryMode === 'none' ? { mode:'none' }
        : deliveryMode === 'webhook' ? { mode:'webhook', to:deliveryTo }
        : { mode:'announce', ...(deliveryTo ? { channel:deliveryTo } : {}) };

      const jobData = { name, enabled, schedule, sessionTarget, payload, delivery };
      const r = await fetch('/api/gateway-patch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: isNew
          ? JSON.stringify({ cronCreate: { job: jobData } })
          : JSON.stringify({ cronPatch: { jobId: data.id, patch: jobData } }),
      });
      const d = await r.json();
      setSaveStatus(d.ok ? (isNew ? '✓ Created' : '✓ Saved') : `✗ ${d.error||'failed'}`);
      if (d.ok && isNew) onCreated?.({ ...jobData, id: d.id });
      if (d.ok && !isNew) onSaved?.(jobData);
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 3500);
  };

  const trigger = async () => {
    setTriggering(true);
    try {
      await fetch('/api/gateway-patch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ cronPatch: { jobId: data.id, patch: { _triggerNow:true } } }),
      });
    } catch {}
    setTimeout(() => setTriggering(false), 2000);
  };

  return (
    <PanelShell emoji="⏱" title={isNew ? 'New Cron Job' : (name||data.id)} subtitle={isNew ? 'create' : data.lastStatus} subtitleColor={isNew ? '#a855f7' : (STATUS_COLOR[data.lastStatus]||'#555')} onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      {/* Read-only stats (existing jobs only) */}
      {!isNew && [
        ['Next Run',  data.nextRunAt  ? new Date(data.nextRunAt).toLocaleString()  : '—'],
        ['Last Run',  data.lastRunAt  ? `${new Date(data.lastRunAt).toLocaleString()}${data.lastDurationMs?` · ${data.lastDurationMs}ms`:''}` : 'never'],
        ['Runs',      data.totalRuns  || 0],
        ...(data.consecutiveErrors > 0 ? [['Errors', data.consecutiveErrors]] : []),
      ].map(([k,v]) => (
        <div key={k} style={{display:'flex',justifyContent:'space-between',padding:'6px 10px',background:'#181818',borderRadius:5,border:'1px solid #2a2a2a',marginBottom:5}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.63rem',color:'#999'}}>{k}</span>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.63rem',color: k==='Errors'?'#ef4444':'#777',textAlign:'right',maxWidth:180}}>{String(v)}</span>
        </div>
      ))}

      <div style={{marginTop:4,borderTop:'1px solid #2a2a2a',paddingTop:12}}>
        {panelField({ label:'Name',           children: <input value={name}          onChange={e=>setName(e.target.value)}          style={panelInput}/> })}
        {panelField({ label:'Enabled',        children: sel(String(enabled), v=>setEnabled(v==='true'), [['true','Enabled'],['false','Disabled']]) })}
        {panelField({ label:'Session Target', children: sel(sessionTarget,   setSessionTarget,          [['isolated','isolated'],['main','main']]) })}

        {/* Schedule */}
        {panelField({ label:'Schedule Type',  children: sel(schedKind, setSchedKind, [['cron','Cron expression'],['every','Every N minutes'],['at','One-shot at time']]) })}
        {schedKind === 'cron'  && panelField({ label:'Cron Expr',   children: <input value={schedExpr}     onChange={e=>setSchedExpr(e.target.value)}     placeholder="0 9 * * *"  style={panelInput}/> })}
        {schedKind === 'every' && panelField({ label:'Every (min)', children: <input value={schedEveryMin} onChange={e=>setSchedEveryMin(e.target.value)} placeholder="60"          style={panelInput} type="number" min="1"/> })}
        {schedKind === 'at'    && panelField({ label:'Run At',      children: <input value={schedAt}       onChange={e=>setSchedAt(e.target.value)}       placeholder="ISO datetime" style={panelInput}/> })}

        {/* Payload */}
        {panelField({ label:'Payload Type',   children: sel(payloadKind, setPayloadKind, [['systemEvent','System Event'],['agentTurn','Agent Turn']]) })}
        {panelField({ label: payloadKind==='agentTurn' ? 'Agent Message' : 'Event Text', children:
          <textarea value={payloadMsg} onChange={e=>setPayloadMsg(e.target.value)} rows={3} style={{...panelInput,resize:'vertical'}}/>
        })}

        {/* Delivery */}
        {panelField({ label:'Delivery',       children: sel(deliveryMode, setDeliveryMode, [['announce','Announce'],['none','None'],['webhook','Webhook']]) })}
        {deliveryMode !== 'none' && panelField({ label: deliveryMode==='webhook' ? 'Webhook URL' : 'Channel/To', children:
          <input value={deliveryTo} onChange={e=>setDeliveryTo(e.target.value)} placeholder={deliveryMode==='webhook'?'https://…':'channel id or empty'} style={panelInput}/>
        })}
      </div>

      {!isNew && (
        <button onClick={trigger} disabled={triggering} style={{
          width:'100%',background:'transparent',border:'1px solid #2a2a2a',borderRadius:6,
          padding:'7px',color:'#666',fontFamily:"'JetBrains Mono',monospace",
          fontSize:'0.7rem',cursor:'pointer',marginTop:12,marginBottom:6,
        }}>{triggering ? '↺ Running…' : '▶ Trigger Now'}</button>
      )}

      {!isNew && (confirmJob
        ? <div style={{display:'flex',gap:6,marginTop:4}}>
            <button onClick={async () => {
              setDeletingJob(true);
              await fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ cronDelete: { jobId: data.id } }) });
              setDeletingJob(false);
              onClose?.();
            }} disabled={deletingJob} style={{flex:1,background:'#7f1d1d',border:'1px solid #ef4444',borderRadius:5,padding:'6px',color:'#fca5a5',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',cursor:'pointer'}}>{deletingJob?'Deleting…':'⚠ Confirm Delete'}</button>
            <button onClick={()=>setConfirmJob(false)} style={{flex:1,background:'none',border:'1px solid #333',borderRadius:5,padding:'6px',color:'#666',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',cursor:'pointer'}}>Cancel</button>
          </div>
        : <button onClick={()=>setConfirmJob(true)} style={{width:'100%',background:'none',border:'1px solid #3a1818',borderRadius:5,padding:'6px',color:'#ef4444',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',cursor:'pointer',marginTop:4}}>✕ Delete Job</button>
      )}
    </PanelShell>
  );
}

/* ── Gateway Info + Config Panel ── */
function LiveGatewayPanel({ data, onClose }) {
  const cfg = data._config || {};
  const mem = cfg.memory   || {};
  const msg = cfg.messages || {};
  const tts = msg.tts      || {};
  const el  = tts.elevenlabs || {};
  const diag= cfg.diagnostics || {};
  const upd = cfg.update   || {};
  const disc= cfg.discovery|| {};
  const canvas= cfg.canvas || {};

  // Gateway config state
  const [port,           setPort]           = React.useState(data.port || 18789);
  const [mode,           setMode]           = React.useState(data.mode || 'local');
  const [bind,           setBind]           = React.useState(data.bind || 'loopback');
  const [tailscale,      setTailscale]      = React.useState(data.tailscale?.mode || 'off');
  const [allowedOrigins, setAllowedOrigins] = React.useState((data.allowedOrigins||[]).join('\n'));
  const [authToken,      setAuthToken]      = React.useState(data.auth?.token || '');

  // Memory state
  const [memBackend,     setMemBackend]     = React.useState(mem.backend || 'qmd');
  const [memInterval,    setMemInterval]    = React.useState(mem.qmd?.update?.interval || '5m');
  const [memMaxResults,  setMemMaxResults]  = React.useState(mem.qmd?.limits?.maxResults ?? 6);
  const [memTimeout,     setMemTimeout]     = React.useState(mem.qmd?.limits?.timeoutMs ?? 8000);

  // TTS state
  const [ttsProvider,    setTtsProvider]    = React.useState(tts.provider || 'elevenlabs');
  const [ttsAuto,        setTtsAuto]        = React.useState(tts.auto || 'inbound');
  const [ttsMode,        setTtsMode]        = React.useState(tts.mode || 'final');
  const [elVoiceId,      setElVoiceId]      = React.useState(el.voiceId || '');
  const [elModelId,      setElModelId]      = React.useState(el.modelId || 'eleven_multilingual_v2');
  const [elStability,    setElStability]    = React.useState(el.voiceSettings?.stability ?? 0.5);
  const [elSimilarity,   setElSimilarity]   = React.useState(el.voiceSettings?.similarityBoost ?? 0.75);
  const [elStyle,        setElStyle]        = React.useState(el.voiceSettings?.style ?? 0.3);
  const [elSpeed,        setElSpeed]        = React.useState(el.voiceSettings?.speed ?? 1);
  const [elApiKey,       setElApiKey]       = React.useState(el.apiKey || '');
  const [responsePrefix, setResponsePrefix] = React.useState(msg.responsePrefix || '');
  const [ackScope,       setAckScope]       = React.useState(msg.ackReactionScope || 'group-mentions');

  // Diagnostics & Update
  const [diagEnabled,    setDiagEnabled]    = React.useState(diag.enabled !== false);
  const [updateChannel,  setUpdateChannel]  = React.useState(upd.channel || 'beta');
  const [checkOnStart,   setCheckOnStart]   = React.useState(upd.checkOnStart !== false);
  const [mdnsMode,       setMdnsMode]       = React.useState(disc.mdns?.mode || 'full');
  const [canvasEnabled,  setCanvasEnabled]  = React.useState(canvas.enabled !== false);
  const [canvasLiveRld,  setCanvasLiveRld]  = React.useState(canvas.liveReload !== false);
  const [a2aEnabled,     setA2aEnabled]     = React.useState(cfg.tools?.agentToAgent?.enabled !== false);
  // New agent form
  const [creatingAgent,  setCreatingAgent]  = React.useState(false);
  const [newAgentId,     setNewAgentId]     = React.useState('');
  const [newAgentModel,  setNewAgentModel]  = React.useState('');
  const [newAgentSaving, setNewAgentSaving] = React.useState(false);
  const [newAgentMsg,    setNewAgentMsg]    = React.useState('');

  const [saving,      setSaving]      = React.useState(false);
  const [saveStatus,  setSaveStatus]  = React.useState('');
  const [restarting,  setRestarting]  = React.useState(false);
  const [restartMsg,  setRestartMsg]  = React.useState('');

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      const calls = [
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ gatewayPatch: { patch: {
            port: Number(port), mode, bind,
            tailscale: { mode: tailscale },
            auth: { token: authToken },
            allowedOrigins: allowedOrigins.split('\n').map(s=>s.trim()).filter(Boolean),
          }}}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ memoryPatch: {
            backend: memBackend,
            qmd: { update: { interval: memInterval }, limits: { maxResults: Number(memMaxResults), timeoutMs: Number(memTimeout) } },
          }}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messagesPatch: {
            responsePrefix,
            ackReactionScope: ackScope,
            tts: {
              provider: ttsProvider, auto: ttsAuto, mode: ttsMode,
              elevenlabs: { apiKey: elApiKey, voiceId: elVoiceId, modelId: elModelId,
                voiceSettings: { stability: Number(elStability), similarityBoost: Number(elSimilarity), style: Number(elStyle), speed: Number(elSpeed) } },
            },
          }}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ diagnosticsPatch: { enabled: diagEnabled }}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ updatePatch: { channel: updateChannel, checkOnStart }}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ discoveryPatch: { mdns: { mode: mdnsMode } }}) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ canvasHostPatch: { enabled: canvasEnabled, liveReload: canvasLiveRld }}) }),
      ];
      await Promise.all(calls);
      setSaveStatus('✓ Saved — restart to apply');
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 4000);
  };

  const restart = async () => {
    setRestarting(true);
    try {
      await fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action: 'restart' }) });
      setRestartMsg('↺ Restart signal sent');
    } catch(e) { setRestartMsg(`✗ ${e.message}`); }
    setRestarting(false);
    setTimeout(() => setRestartMsg(''), 4000);
  };

  const SEL = (v, set, opts) => <select value={v} onChange={e=>set(e.target.value)} style={panelInput}>{opts.map(([a,b])=><option key={a} value={a}>{b}</option>)}</select>;
  const INP = (v, set, props={}) => <input value={v} onChange={e=>set(e.target.value)} style={panelInput} {...props}/>;
  const NUM = (v, set, props={}) => <input type="number" value={v} onChange={e=>set(e.target.value)} style={panelInput} {...props}/>;
  const TOG = (v, set, label) => <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}><span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.88rem',color:'#bbb'}}>{label}</span><PanelToggle value={v} onChange={set}/></div>;
  const STAT = (k, v) => <div style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'#181818',borderRadius:6,border:'1px solid #2a2a2a',marginBottom:6}}><span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.85rem',color:'#888'}}>{k}</span><span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.85rem',fontWeight:600,color:'#e0e0e0'}}>{v}</span></div>;

  return (
    <PanelShell emoji="🖥️" title="OpenClaw Gateway" subtitle="● online" subtitleColor="#4ade80" onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      <PanelSection label="Overview"/>
      {STAT('Port',     data.port)}
      {STAT('Version',  `v${data.version}`)}
      {STAT('Agents',   data.agentCount)}
      {STAT('Skills',   data.skillCount)}
      {STAT('Channels', data.channelCount)}
      {STAT('Sessions', data.sessionCount)}
      {STAT('Cron',     data.cronCount)}
      {STAT('Nodes',    data.nodeCount)}

      {creatingAgent ? (
        <div style={{background:'#141414',border:'1px solid #818cf8',borderRadius:7,padding:'10px 12px',marginBottom:12,display:'flex',flexDirection:'column',gap:6}}>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#818cf8',marginBottom:2}}>New Named Agent</div>
          {panelField({ label:'Agent ID', children: <input value={newAgentId} onChange={e=>setNewAgentId(e.target.value)} style={panelInput} placeholder="e.g. researcher"/> })}
          {panelField({ label:'Model',    children: <input value={newAgentModel} onChange={e=>setNewAgentModel(e.target.value)} style={panelInput} placeholder="inherits defaults"/> })}
          {newAgentMsg && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#4ade80'}}>{newAgentMsg}</div>}
          <div style={{display:'flex',gap:6}}>
            <button onClick={async () => {
              if (!newAgentId.trim()) return;
              setNewAgentSaving(true);
              const r = await fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ agentCreate: { agentId: newAgentId.trim(), agent: { name: newAgentId.trim(), model: newAgentModel || undefined } } }) });
              const d = await r.json();
              setNewAgentMsg(d.ok ? '✓ Created — restart to apply' : `✗ ${d.error}`);
              setNewAgentSaving(false);
              if (d.ok) { setCreatingAgent(false); setNewAgentId(''); setNewAgentModel(''); }
              setTimeout(() => setNewAgentMsg(''), 3500);
            }} disabled={newAgentSaving} style={{flex:1,background:'#818cf8',border:'none',borderRadius:5,padding:'6px',color:'#000',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.67rem',fontWeight:700,cursor:'pointer'}}>Create</button>
            <button onClick={()=>{setCreatingAgent(false);setNewAgentId('');setNewAgentModel('');}} style={{flex:1,background:'none',border:'1px solid #333',borderRadius:5,padding:'6px',color:'#666',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.67rem',cursor:'pointer'}}>Cancel</button>
          </div>
        </div>
      ) : (
        <button onClick={()=>setCreatingAgent(true)} style={{width:'100%',background:'none',border:'1px dashed #2a2a2a',borderRadius:6,padding:'6px',color:'#555',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.67rem',cursor:'pointer',marginBottom:12}}>
          ＋ New Named Agent
        </button>
      )}

      <PanelSection label="Gateway Config"/>
      {panelField({ label:'Port',      children: NUM(port, setPort, {min:1024,max:65535}) })}
      {panelField({ label:'Mode',      children: SEL(mode, setMode, [['local','local'],['remote','remote']]) })}
      {panelField({ label:'Bind',      children: SEL(bind, setBind, [['loopback','loopback'],['all','all interfaces']]) })}
      {panelField({ label:'Tailscale', children: SEL(tailscale, setTailscale, [['off','off'],['serve','serve'],['funnel','funnel']]) })}
      {panelField({ label:'Auth Token', children: INP(authToken, setAuthToken, {type:'password'}) })}
      {panelField({ label:'Allowed Origins', children:
        <textarea value={allowedOrigins} onChange={e=>setAllowedOrigins(e.target.value)} rows={3} style={{...panelInput,resize:'vertical',lineHeight:1.7}} placeholder={'http://localhost:5173\nhttps://myapp.com'}/>
      })}

      <PanelSection label="Memory"/>
      {panelField({ label:'Backend',      children: INP(memBackend, setMemBackend) })}
      {panelField({ label:'Update Interval', children: INP(memInterval, setMemInterval, {placeholder:'5m'}) })}
      {panelField({ label:'Max Results',  children: NUM(memMaxResults, setMemMaxResults, {min:1,max:50}) })}
      {panelField({ label:'Timeout (ms)', children: NUM(memTimeout,    setMemTimeout,    {min:1000}) })}

      <PanelSection label="TTS / Messages"/>
      {panelField({ label:'Provider',     children: SEL(ttsProvider, setTtsProvider, [['elevenlabs','ElevenLabs'],['none','none']]) })}
      {panelField({ label:'Auto',         children: SEL(ttsAuto,     setTtsAuto,     [['inbound','inbound'],['off','off'],['all','all']]) })}
      {panelField({ label:'Mode',         children: SEL(ttsMode,     setTtsMode,     [['final','final'],['streaming','streaming']]) })}
      {panelField({ label:'EL API Key',   children: INP(elApiKey,    setElApiKey,    {type:'password'}) })}
      {panelField({ label:'EL Voice ID',  children: INP(elVoiceId,   setElVoiceId) })}
      {panelField({ label:'EL Model',     children: INP(elModelId,   setElModelId) })}
      {panelField({ label:'Stability',    children: NUM(elStability,  setElStability,  {min:0,max:1,step:0.05}) })}
      {panelField({ label:'Similarity',   children: NUM(elSimilarity, setElSimilarity, {min:0,max:1,step:0.05}) })}
      {panelField({ label:'Style',        children: NUM(elStyle,      setElStyle,      {min:0,max:1,step:0.05}) })}
      {panelField({ label:'Speed',        children: NUM(elSpeed,      setElSpeed,      {min:0.5,max:2,step:0.1}) })}
      {panelField({ label:'Resp Prefix',  children: INP(responsePrefix, setResponsePrefix, {placeholder:'optional prepend text'}) })}
      {panelField({ label:'ACK Scope',    children: SEL(ackScope, setAckScope, [['group-mentions','group mentions'],['all','all'],['none','none']]) })}

      <PanelSection label="Diagnostics & Updates"/>
      {TOG(diagEnabled, setDiagEnabled, 'Diagnostics enabled')}
      {panelField({ label:'Update Channel', children: SEL(updateChannel, setUpdateChannel, [['beta','beta'],['stable','stable']]) })}
      {TOG(checkOnStart, setCheckOnStart, 'Check on start')}
      {panelField({ label:'mDNS Mode',  children: SEL(mdnsMode, setMdnsMode, [['full','full'],['announce','announce'],['off','off']]) })}

      <PanelSection label="Canvas"/>
      {TOG(canvasEnabled, setCanvasEnabled, 'Canvas Host Enabled')}
      {TOG(canvasLiveRld, setCanvasLiveRld, 'Live Reload')}

      <PanelSection label="Tools"/>
      {TOG(a2aEnabled, v => {
        setA2aEnabled(v);
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ toolsPatch: { agentToAgent: { enabled: v } } }) });
      }, 'Agent-to-Agent calls')}

      {cfg.plugins && Object.keys(cfg.plugins).length > 0 && <>
        <PanelSection label="Plugins"/>
        {Object.entries(cfg.plugins).map(([pid, pc]) => (
          <div key={pid} style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
            <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',color:'#888'}}>{pid}</span>
            <PanelToggle value={pc.enabled !== false} onChange={v => {
              fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ pluginsPatch: { [pid]: { enabled: v } } }) });
            }}/>
          </div>
        ))}
      </>}

      <PanelSection label="Actions"/>
      <button onClick={restart} disabled={restarting} style={{
        width:'100%',background:'transparent',border:'1px solid #333',borderRadius:6,
        padding:'8px',color:'#888',fontFamily:"'JetBrains Mono',monospace",
        fontSize:'0.72rem',cursor:'pointer',marginBottom:6,
      }}>{restarting ? '↺ Restarting…' : '↺ Restart Gateway'}</button>
      {restartMsg && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#4ade80',textAlign:'center'}}>{restartMsg}</div>}

    </PanelShell>
  );
}

/* ── Single Skill Panel ── */
function SingleSkillPanel({ data, skills, onClose, onToggleSkill }) {
  const skillId = data.skillId || data.label || '';
  const live = skills.find(s => s.id === skillId) || { id: skillId, enabled: data.enabled !== false };
  const [enabled,   setEnabled]   = React.useState(live.enabled);
  const [apiKey,    setApiKey]    = React.useState(live.config?.apiKey || '');
  const [saving,    setSaving]    = React.useState(false);
  const [saveStatus,setSaveStatus]= React.useState('');

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      const patch = { enabled, ...(apiKey ? { apiKey } : {}) };
      await fetch('/api/gateway-patch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ skillPatch: { skillId, patch } }),
      });
      onToggleSkill?.(skillId, enabled);
      setSaveStatus('✓ Saved');
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 3000);
  };

  const cat = SKILL_CATS[skillId] || 'Other';
  const color = SKILL_CAT_COLOR[cat] || '#555';
  const hasApiKey = !!(live.config?.apiKey || apiKey);

  return (
    <PanelShell emoji="🔧" title={skillId} subtitle={cat} subtitleColor={color} onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      <PanelSection label="Info"/>
      {[['Skill ID', skillId], ['Category', cat], ...(data.description ? [['Description', data.description]] : [])].map(([k,v]) => (
        <div key={k} style={{display:'flex',justifyContent:'space-between',padding:'7px 10px',background:'#181818',borderRadius:5,border:'1px solid #2a2a2a',marginBottom:6}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#999'}}>{k}</span>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#ccc',textAlign:'right',maxWidth:180,wordBreak:'break-all'}}>{String(v)}</span>
        </div>
      ))}

      <PanelSection label="Config"/>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
        <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',color:'#888'}}>Enabled</span>
        <PanelToggle value={enabled} onChange={setEnabled}/>
      </div>
      {panelField({ label:'API Key', children:
        <>
          <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)}
            style={panelInput} placeholder={hasApiKey ? '••••••••••••' : 'optional API key'}/>
          <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.54rem',color:'#333',marginTop:3}}>required for some skills (image gen, TTS, etc.)</div>
        </>
      })}

    </PanelShell>
  );
}

/* ── Session Detail Panel ── */
function LiveSessionPanel({ data, onClose }) {
  const s = data._session || data;
  const fmtTime = iso => iso ? new Date(iso).toLocaleString() : '—';
  const fmtDiff = iso => {
    if (!iso) return '';
    const diff = Date.now() - new Date(iso);
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
    return `${Math.floor(diff/86400000)}d ago`;
  };
  const C = '#f59e0b';

  const copyId = () => navigator.clipboard?.writeText(s.id || '').catch(()=>{});

  return (
    <PanelShell emoji="🕐" title="Session" subtitle={`${s.messageCount||0} messages`} subtitleColor={C} onClose={onClose}>

      <PanelSection label="Identity"/>
      <div onClick={copyId} title="click to copy" style={{
        fontFamily:"'JetBrains Mono',monospace",fontSize:'0.6rem',color:'#555',
        background:'#111',borderRadius:5,padding:'7px 10px',marginBottom:10,
        cursor:'pointer',wordBreak:'break-all',border:'1px solid #1e1e1e',
      }}>
        {s.id || '—'}
        <span style={{color:'#2a2a2a',marginLeft:6}}>⎘</span>
      </div>

      {[
        ['Last Active', `${fmtTime(s.lastActive)} (${fmtDiff(s.lastActive)})`],
        ['Messages',    s.messageCount || 0],
        ['Size',        s.sizeKb ? `${s.sizeKb} KB` : '—'],
        ['Model',       s.model || '—'],
        ['Agent',       s.agentId || 'main'],
      ].map(([k,v]) => (
        <div key={k} style={{display:'flex',justifyContent:'space-between',padding:'6px 10px',background:'#141414',borderRadius:5,border:'1px solid #1e1e1e',marginBottom:5}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.63rem',color:'#666'}}>{k}</span>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.63rem',color:'#888',textAlign:'right',maxWidth:200}}>{String(v)}</span>
        </div>
      ))}

      {s.lastUserMessage && (
        <>
          <PanelSection label="Last User Message"/>
          <div style={{
            fontFamily:"'JetBrains Mono',monospace",fontSize:'0.67rem',color:'#aaa',
            background:'#111',borderRadius:6,padding:'8px 10px',
            borderLeft:'2px solid #f59e0b',lineHeight:1.6,
          }}>{s.lastUserMessage}</div>
        </>
      )}

      {s.lastAssistantMessage && (
        <>
          <PanelSection label="Last Assistant Message"/>
          <div style={{
            fontFamily:"'JetBrains Mono',monospace",fontSize:'0.67rem',color:'#888',
            background:'#111',borderRadius:6,padding:'8px 10px',
            borderLeft:'2px solid #333',lineHeight:1.6,
          }}>{s.lastAssistantMessage}</div>
        </>
      )}

      <PanelSection label="Actions"/>
      <button onClick={() => {
        if (confirm(`Delete session ${(s.id||'').slice(0,12)}…? This cannot be undone.`)) {
          fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ sessionDelete: { agentId: s.agentId||'main', sessionId: s.id } }) });
          onClose?.();
        }
      }} style={{
        width:'100%',background:'none',border:'1px solid #3a1818',borderRadius:5,
        padding:'7px',color:'#ef4444',fontFamily:"'JetBrains Mono',monospace",
        fontSize:'0.68rem',cursor:'pointer',
      }}>✕ Delete Session</button>

    </PanelShell>
  );
}

/* ── Commands + Web Panel ── */
function LiveCommandsPanel({ data, onClose }) {
  const cfg     = data._config || {};
  const cmdsCfg = cfg.commands || {};
  const webCfg  = cfg.web      || {};
  const talkCfg = cfg.talk     || {};

  const [native,       setNative]       = React.useState(cmdsCfg.native       ?? 'auto');
  const [nativeSkills, setNativeSkills] = React.useState(cmdsCfg.nativeSkills ?? 'auto');
  const [restartCmd,   setRestartCmd]   = React.useState(cmdsCfg.restart !== false);
  const [webEnabled,   setWebEnabled]   = React.useState(webCfg.enabled !== false);
  const [talkEnabled,  setTalkEnabled]  = React.useState(talkCfg.enabled !== false);
  const [talkPort,     setTalkPort]     = React.useState(talkCfg.port || 3000);
  const [saving,       setSaving]       = React.useState(false);
  const [saveStatus,   setSaveStatus]   = React.useState('');

  const save = async () => {
    setSaving(true); setSaveStatus('');
    try {
      await Promise.all([
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ commandsPatch: { native, nativeSkills, restart: restartCmd } }) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ webPatch: { enabled: webEnabled } }) }),
        fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ patch: { talk: { enabled: talkEnabled, port: Number(talkPort) } } }) }),
      ]);
      setSaveStatus('✓ Saved — restart to apply');
    } catch(e) { setSaveStatus(`✗ ${e.message}`); }
    setSaving(false);
    setTimeout(() => setSaveStatus(''), 3000);
  };

  const SEL = (v, set, opts) => <select value={v} onChange={e=>set(e.target.value)} style={panelInput}>{opts.map(([a,b])=><option key={a} value={a}>{b}</option>)}</select>;
  const TOG = (v, set, label) => <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}><span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.88rem',color:'#bbb'}}>{label}</span><PanelToggle value={v} onChange={set}/></div>;

  return (
    <PanelShell emoji="⚙️" title="System Config" subtitle="commands · web · talk" subtitleColor="#a855f7" onClose={onClose} saving={saving} onSave={save} saveStatus={saveStatus}>

      <PanelSection label="Native Commands"/>
      {panelField({ label:'Commands Mode',    children: SEL(String(native),       setNative,       [['auto','auto (detect)'],['true','always on'],['false','off']]) })}
      {panelField({ label:'Skills Mode',      children: SEL(String(nativeSkills), setNativeSkills, [['auto','auto (detect)'],['true','always on'],['false','off']]) })}
      {TOG(restartCmd, setRestartCmd, 'Restart command enabled')}

      <PanelSection label="Web UI"/>
      {TOG(webEnabled, setWebEnabled, 'Web UI Enabled')}

      <PanelSection label="Talk (Voice)"/>
      {TOG(talkEnabled, setTalkEnabled, 'Talk Server Enabled')}
      {panelField({ label:'Talk Port', children: <input type="number" min={1024} max={65535} value={talkPort} onChange={e=>setTalkPort(e.target.value)} style={panelInput}/> })}

    </PanelShell>
  );
}

/* ── Models Management Panel ── */
function LiveModelsPanel({ data, onClose }) {
  const [providers, setProviders] = React.useState(data.providers || []);
  const [editing,   setEditing]   = React.useState(null); // { providerId, provider }
  const [newProv,   setNewProv]   = React.useState(false);
  const [newProvId, setNewProvId] = React.useState('');
  const [newApiKey, setNewApiKey] = React.useState('');
  const [newBaseUrl,setNewBaseUrl]= React.useState('');
  const [newModelId,setNewModelId]= React.useState('');
  const [addingTo,  setAddingTo]  = React.useState(null);
  const [saving,    setSaving]    = React.useState(false);
  const [status,    setStatus]    = React.useState('');

  const patch = async (body) => {
    const r = await fetch('/api/gateway-patch', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    return r.json();
  };

  const saveProvider = async (providerId, providerData) => {
    setSaving(true);
    const d = await patch({ providerUpsert: { providerId, provider: providerData } });
    setStatus(d.ok ? '✓ Saved' : `✗ ${d.error}`);
    setSaving(false);
    setTimeout(() => setStatus(''), 3000);
  };

  const removeProvider = async (providerId) => {
    if (!confirm(`Remove provider "${providerId}"?`)) return;
    setSaving(true);
    await patch({ providerRemove: { providerId } });
    setProviders(p => p.filter(x => x.id !== providerId));
    setSaving(false);
  };

  const addModel = async (providerId) => {
    if (!newModelId.trim()) return;
    setSaving(true);
    await patch({ modelAdd: { providerId, model: { id: newModelId.trim(), name: newModelId.trim() } } });
    setProviders(p => p.map(x => x.id === providerId
      ? { ...x, models: [...(x.models||[]), { id: newModelId.trim() }] }
      : x));
    setNewModelId(''); setAddingTo(null);
    setSaving(false);
  };

  const removeModel = async (providerId, modelId) => {
    await patch({ modelRemove: { providerId, modelId } });
    setProviders(p => p.map(x => x.id === providerId
      ? { ...x, models: (x.models||[]).filter(m => m.id !== modelId) }
      : x));
  };

  const createProvider = async () => {
    if (!newProvId.trim()) return;
    const prov = { models: [], ...(newApiKey ? { apiKey: newApiKey } : {}), ...(newBaseUrl ? { baseUrl: newBaseUrl } : {}) };
    await patch({ providerUpsert: { providerId: newProvId.trim(), provider: prov } });
    setProviders(p => [...p, { id: newProvId.trim(), ...prov }]);
    setNewProv(false); setNewProvId(''); setNewApiKey(''); setNewBaseUrl('');
  };

  return (
    <PanelShell emoji="🧠" title="Model Providers" subtitle={`${providers.length} providers`} subtitleColor="#f97316" onClose={onClose}>
      {status && <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.65rem',color:'#4ade80',marginBottom:8,textAlign:'center'}}>{status}</div>}

      {providers.map(prov => (
        <div key={prov.id} style={{background:'#141414',border:'1px solid #2a2a2a',borderRadius:8,marginBottom:10,overflow:'hidden'}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'10px 14px',borderBottom:'1px solid #1e1e1e'}}>
            <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'1rem',fontWeight:700,color:'#fb923c'}}>{prov.id}</span>
            <div style={{display:'flex',gap:6}}>
              <button onClick={() => setEditing(editing?.providerId === prov.id ? null : { providerId:prov.id, apiKey:prov.apiKey||'', baseUrl:prov.baseUrl||'' })}
                style={{background:'none',border:'1px solid #444',borderRadius:4,padding:'4px 10px',color:'#bbb',fontSize:'0.78rem',cursor:'pointer',fontFamily:"'JetBrains Mono',monospace"}}>
                {editing?.providerId === prov.id ? 'done' : '⚙ edit'}
              </button>
              <button onClick={() => removeProvider(prov.id)}
                style={{background:'none',border:'1px solid #5a2020',borderRadius:4,padding:'4px 10px',color:'#f87171',fontSize:'0.78rem',cursor:'pointer',fontFamily:"'JetBrains Mono',monospace"}}>
                ✕
              </button>
            </div>
          </div>

          {editing?.providerId === prov.id && (
            <div style={{padding:'8px 12px',borderBottom:'1px solid #1e1e1e',display:'flex',flexDirection:'column',gap:6}}>
              {panelField({ label:'API Key', children:
                <input type="password" value={editing.apiKey} onChange={e=>setEditing(ed=>({...ed,apiKey:e.target.value}))} style={panelInput} placeholder="sk-..."/>
              })}
              {panelField({ label:'Base URL', children:
                <input value={editing.baseUrl} onChange={e=>setEditing(ed=>({...ed,baseUrl:e.target.value}))} style={panelInput} placeholder="https://api.openai.com/v1"/>
              })}
              <button onClick={() => saveProvider(prov.id, { apiKey:editing.apiKey, baseUrl:editing.baseUrl })}
                disabled={saving} style={{background:'#f97316',border:'none',borderRadius:4,padding:'4px 10px',color:'#000',fontSize:'0.65rem',fontFamily:"'JetBrains Mono',monospace",fontWeight:700,cursor:'pointer'}}>
                Save
              </button>
            </div>
          )}

          <div style={{padding:'8px 12px'}}>
            <div style={{display:'flex',flexWrap:'wrap',gap:4,marginBottom:6}}>
              {(prov.models||[]).map(m => (
                <div key={m.id} style={{display:'flex',alignItems:'center',gap:4,background:'rgba(249,115,22,0.12)',border:'1px solid rgba(249,115,22,0.35)',borderRadius:5,padding:'4px 8px'}}>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.82rem',color:'#fdba74'}}>{m.id}</span>
                  <button onClick={() => removeModel(prov.id, m.id)} style={{background:'none',border:'none',color:'#888',cursor:'pointer',fontSize:'0.75rem',padding:'0 2px',lineHeight:1}}>✕</button>
                </div>
              ))}
            </div>
            {addingTo === prov.id ? (
              <div style={{display:'flex',gap:4}}>
                <input value={newModelId} onChange={e=>setNewModelId(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addModel(prov.id)}
                  style={{...panelInput,flex:1,fontSize:'0.65rem'}} placeholder="model-id e.g. gpt-4.1"/>
                <button onClick={() => addModel(prov.id)} style={{background:'#f97316',border:'none',borderRadius:4,padding:'3px 8px',color:'#000',fontSize:'0.65rem',fontFamily:"'JetBrains Mono',monospace",cursor:'pointer'}}>+</button>
                <button onClick={() => { setAddingTo(null); setNewModelId(''); }} style={{background:'none',border:'1px solid #333',borderRadius:4,padding:'3px 8px',color:'#666',fontSize:'0.65rem',cursor:'pointer'}}>✕</button>
              </div>
            ) : (
              <button onClick={() => setAddingTo(prov.id)} style={{background:'none',border:'1px solid #2a2a2a',borderRadius:4,padding:'3px 10px',color:'#555',fontSize:'0.6rem',fontFamily:"'JetBrains Mono',monospace",cursor:'pointer',width:'100%'}}>+ add model</button>
            )}
          </div>
        </div>
      ))}

      {newProv ? (
        <div style={{background:'#141414',border:'1px solid #f97316',borderRadius:8,padding:'10px 12px',display:'flex',flexDirection:'column',gap:6}}>
          {panelField({ label:'Provider ID', children: <input value={newProvId} onChange={e=>setNewProvId(e.target.value)} style={panelInput} placeholder="e.g. openai"/> })}
          {panelField({ label:'API Key',     children: <input type="password" value={newApiKey} onChange={e=>setNewApiKey(e.target.value)} style={panelInput} placeholder="sk-..."/> })}
          {panelField({ label:'Base URL',    children: <input value={newBaseUrl} onChange={e=>setNewBaseUrl(e.target.value)} style={panelInput} placeholder="optional custom base URL"/> })}
          <div style={{display:'flex',gap:6}}>
            <button onClick={createProvider} style={{flex:1,background:'#f97316',border:'none',borderRadius:4,padding:'6px',color:'#000',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',fontWeight:700,cursor:'pointer'}}>Create</button>
            <button onClick={() => { setNewProv(false); setNewProvId(''); setNewApiKey(''); setNewBaseUrl(''); }} style={{flex:1,background:'none',border:'1px solid #333',borderRadius:4,padding:'6px',color:'#666',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer'}}>Cancel</button>
          </div>
        </div>
      ) : (
        <button onClick={() => setNewProv(true)} style={{width:'100%',background:'none',border:'1px dashed #2a2a2a',borderRadius:6,padding:'8px',color:'#555',fontFamily:"'JetBrains Mono',monospace",fontSize:'0.68rem',cursor:'pointer',marginTop:4}}>+ add provider</button>
      )}
    </PanelShell>
  );
}

/* ── Live Node Panel — routes to the right editor by node type ── */
function LiveNodePanel({ node, skills, models, onClose, onToggleSkill, onNodeUpdate, onAgentCreated, onCronCreated, onChannelCreated }) {
  if (!node) return null;
  if (node._nodeType === 'livegateway') return <LiveGatewayPanel data={node} onClose={onClose}/>;
  if (node._nodeType === 'modelslist') return <LiveModelsPanel data={node} onClose={onClose}/>;
  if (node._nodeType === 'commands')   return <LiveCommandsPanel data={node} onClose={onClose}/>;
  if (node._nodeType === 'session')    return <LiveSessionPanel   data={node} onClose={onClose}/>;
  if (node._nodeType === 'channel' || node._nodeType === 'newchannel')
    return <LiveChannelPanel data={node} onClose={onClose}
      onSaved={onClose}
      onDeleted={onClose}
      onCreated={ch => { onChannelCreated?.(ch); onClose(); }}/>;
  if (node._nodeType === 'cronlist') return <LiveCronPanel data={node} onClose={onClose} onAgentList={models} onCreated={onCronCreated} onSaved={d => { onNodeUpdate?.(node, d); onClose(); }}/>;
  if (node._nodeType === 'agent') return <LiveAgentPanel data={node} models={models} onClose={onClose} onSaved={d => { onNodeUpdate?.(node, d); }} onDeleted={onClose}/>;
  if (node._nodeType === 'singleskill') return <SingleSkillPanel data={node} skills={skills} onClose={onClose} onToggleSkill={onToggleSkill}/>;
  if (node._nodeType === 'group') return <GroupSummaryPanel data={node} onClose={onClose}/>;
  return <LiveSkillPanel agent={node} skills={skills} onClose={onClose} onToggleSkill={onToggleSkill}/>;
}

/* ── Floating Tree Node Properties Panel ── */
/* ── Group Summary Panel — consistent size/position with all other panels ── */
function GroupSummaryPanel({ data, onClose }) {
  const cfg = TREE_CATEGORIES[data.category] || TREE_CATEGORIES.skill;
  const color = data.color || cfg.color;
  const catLabel = data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'Group';

  const infoRows = [
    ['Type',    catLabel],
    ['Count',   data.label?.match(/\d+/)?.[0] || '—'],
    ['Status',  data.enabled !== false ? 'active' : 'inactive'],
    ...(data.expandable ? [['Tip', 'click node to expand']] : []),
  ];

  return (
    <PanelShell emoji={cfg.icon ? '' : '📦'} title={data.label || 'Group'} subtitle={catLabel} subtitleColor={color} onClose={onClose}>
      {infoRows.map(([k,v]) => (
        <div key={k} style={{display:'flex',justifyContent:'space-between',padding:'8px 12px',background:'#181818',borderRadius:6,border:'1px solid #2a2a2a',marginBottom:8}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color:'#999'}}>{k}</span>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.7rem',color: k==='Status'&&data.enabled!==false?'#4ade80':'#ccc'}}>{v}</span>
        </div>
      ))}
    </PanelShell>
  )
}


/* ── Main App ── */
const INITIAL_NODES = [{
  id: 'gateway-1', type: 'gateway',
  position: { x: 0, y: 0 },
  data: { label: 'My Gateway', desc: '' },
}];

function ForgeApp() {
  const [nodes, setNodes, onNodesChange] = useNodesState(INITIAL_NODES);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const [selectedNode, setSelectedNode] = useState(null);
  const [selectedTreeNode, setSelectedTreeNode] = useState(null);
  const [showAiModal, setShowAiModal] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const rfInstance = useRef(null);

  // Live mode
  const liveMode = true;
  const [liveCollapsed, setLiveCollapsed] = useState(false);
  const [ftExpandedIds, setFtExpandedIds] = useState(new Set());
  const ftExpandedIdsRef = useRef(new Set());
  const [liveData, setLiveData] = useState(null);
  const [liveSkills, setLiveSkills] = useState([]);
  const [liveLoading, setLiveLoading] = useState(false);
  const [liveError, setLiveError] = useState(null);
  const [liveSelectedAgent, setLiveSelectedAgent] = useState(null);
  const [sidePanelOpen,     setSidePanelOpen]     = useState(true);
  const [layoutKey,         setLayoutKey]         = useState(() => localStorage.getItem('forge-layout') || 'down');
  const [edgeStyleKey,      setEdgeStyleKey]      = useState(() => localStorage.getItem('forge-edge-style') || 'solid');
  const treeElkRef     = useRef(null);
  const edgeStyleRef   = useRef(localStorage.getItem('forge-edge-style') || 'solid');
  const [liveLastRefresh,   setLiveLastRefresh]   = useState(null);
  const [liveRefreshTick,   setLiveRefreshTick]   = useState(0); // seconds since last refresh
  const liveNodesRef = useRef([]);
  const liveEdgesRef = useRef([]);
  const autoRefreshRef  = useRef(null);
  const liveLoadingRef  = useRef(false);

  const save = useCallback((nds, eds) => {
    localStorage.setItem('vf-forge', JSON.stringify({ nodes: nds, edges: eds }));
  }, []);

  // Keep ref in sync with ftExpandedIds state
  React.useEffect(() => { ftExpandedIdsRef.current = ftExpandedIds; }, [ftExpandedIds]);

  // Auto-open side panel when a node is selected
  React.useEffect(() => {
    if (liveSelectedAgent) setSidePanelOpen(true);
  }, [liveSelectedAgent]);

  // On mount: load live data immediately
  React.useEffect(() => { loadLive(); }, []);

  // Re-centre diagram when window is resized (zoom stays locked via minZoom=maxZoom)
  React.useEffect(() => {
    const onResize = () => rfInstance.current?.fitView({ padding: 0.25, duration: 0 });
    window.addEventListener('resize', onResize);
    return () => window.removeEventListener('resize', onResize);
  }, []);

  // Track which sections are expanded
  const [liveExpanded, setLiveExpanded] = useState({});
  const liveDataRef = useRef(null);

  // Build a single collapsed server node from live data (or placeholder)
  const buildCollapsedServerNode = useCallback((data) => [{
    id: 'live-server',
    type: 'collapsedserver',
    position: { x: 0, y: 0 },
    data: data ? {
      label: data.gateway?.name || 'OpenClaw Gateway',
      agentCount: data.agents?.length || 0,
      skillCount: data.skills?.filter(s => s.enabled !== false)?.length || 0,
      channelCount: data.channels?.length || 0,
      cronCount: data.cronJobs?.length || 0,
      nodeCount: data.nodes?.length || 0,
    } : { label: 'OpenClaw Gateway' },
  }], []);

  // ── Layout presets ──────────────────────────────────────────────
  const LAYOUT_OPTS = {
    down:   { label:'Down',   icon:'↓', elk:{ 'elk.algorithm':'layered','elk.direction':'DOWN',  'elk.layered.spacing.nodeNodeBetweenLayers':'200','elk.spacing.nodeNode':'40','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
    right:  { label:'Right',  icon:'→', elk:{ 'elk.algorithm':'layered','elk.direction':'RIGHT', 'elk.layered.spacing.nodeNodeBetweenLayers':'260','elk.spacing.nodeNode':'40','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
    up:     { label:'Up',     icon:'↑', elk:{ 'elk.algorithm':'layered','elk.direction':'UP',    'elk.layered.spacing.nodeNodeBetweenLayers':'200','elk.spacing.nodeNode':'40','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
    left:   { label:'Left',   icon:'←', elk:{ 'elk.algorithm':'layered','elk.direction':'LEFT',  'elk.layered.spacing.nodeNodeBetweenLayers':'260','elk.spacing.nodeNode':'40','elk.layered.nodePlacement.strategy':'SIMPLE','elk.edgeRouting':'ORTHOGONAL' } },
    radial: { label:'Radial', icon:'◎', elk:{ 'elk.algorithm':'radial', 'elk.spacing.nodeNode':'100' } },
    stress: { label:'Force',  icon:'⬡', elk:{ 'elk.algorithm':'stress', 'elk.spacing.nodeNode':'120','elk.stress.desiredEdgeLength':'200' } },
  };

  const EDGE_STYLES = {
    solid:    { label:'—',    dash: undefined },
    dashed:   { label:'╌',    dash: '10 5' },
    dotted:   { label:'···',  dash: '2 6' },
    longdash: { label:'╍',    dash: '18 7' },
  };

  // Keep treeElkRef in sync with layoutKey
  React.useEffect(() => {
    treeElkRef.current = (LAYOUT_OPTS[layoutKey] || LAYOUT_OPTS.down).elk;
    localStorage.setItem('forge-layout', layoutKey);
  }, [layoutKey]);
  if (!treeElkRef.current) treeElkRef.current = (LAYOUT_OPTS[layoutKey] || LAYOUT_OPTS.down).elk;

  // Keep edgeStyleRef in sync with edgeStyleKey
  React.useEffect(() => {
    edgeStyleRef.current = edgeStyleKey;
    localStorage.setItem('forge-edge-style', edgeStyleKey);
    // Re-apply so all edges pick up the new dash pattern
    applyFamilyTree(ftExpandedIdsRef.current);
  }, [edgeStyleKey]);

  const applyFamilyTree = useCallback(async (expandedIds) => {
    const data = liveDataRef.current;
    if (!data) return;
    const EDGE_STYLE_DASHES = { solid:undefined, dashed:'10 5', dotted:'2 6', longdash:'18 7' };
    const dash = EDGE_STYLE_DASHES[edgeStyleRef.current];
    const { nodes: lnodes, edges: ledges } = buildFamilyTree(data, expandedIds, dash);
    setEdges(ledges);
    const laid = await elkLayout(lnodes, ledges, treeElkRef.current);
    setNodes(laid);
    setTimeout(() => rfInstance.current?.fitView({ padding: 0.15, duration: 350 }), 150);
  }, []);

  const handleExpandServer = useCallback(async () => {
    const data = liveDataRef.current;
    if (!data) return;
    setLiveCollapsed(false);
    setLiveExpanded({});
    setFtExpandedIds(new Set());
    await applyFamilyTree(new Set(), true);
    setLiveSelectedAgent(null);
  }, [applyFamilyTree]);

  // ── Child layout engine ──────────────────────────────────────────────────
  // Places new children below their parents:
  //  • max MAX_PER_ROW nodes per row, centered under parent
  //  • overlapping rows shift down until clear
  //  • parent positions are NEVER touched
  const placeNewChildren = useCallback((lnodes, ledges, snapshotPos) => {
    const COL_GAP   = 150;   // center-to-center horizontal spacing
    const ROW_GAP   = 200;   // center-to-center vertical spacing
    const MAX_ROW   = 10;    // max nodes per row
    const NODE_W    = 120;   // collision box width
    const NODE_H    = 120;   // collision box height

    // Working copy of all positions (parents + newly placed)
    const allPos = new Map(snapshotPos);

    // Group new nodes by their direct parent
    const childrenByParent = new Map();
    lnodes.forEach(n => {
      if (snapshotPos.has(n.id)) return;
      const pe = ledges.find(e => e.target === n.id);
      if (!pe) return;
      if (!childrenByParent.has(pe.source)) childrenByParent.set(pe.source, []);
      childrenByParent.get(pe.source).push(n);
    });

    const overlaps = (x, y) => {
      for (const pos of allPos.values()) {
        if (Math.abs(x - pos.x) < NODE_W && Math.abs(y - pos.y) < NODE_H) return true;
      }
      return false;
    };

    childrenByParent.forEach((children, parentId) => {
      const parentPos = allPos.get(parentId);
      if (!parentPos) return;

      // Split into rows of ≤ MAX_ROW
      for (let ri = 0; ri < Math.ceil(children.length / MAX_ROW); ri++) {
        const row = children.slice(ri * MAX_ROW, (ri + 1) * MAX_ROW);
        const halfW = ((row.length - 1) * COL_GAP) / 2;

        // Start one row below parent (or previous row)
        let rowY = parentPos.y + ROW_GAP * (ri + 1);

        // Shift down until the whole row is clear of all known positions
        let attempts = 0;
        let blocked = true;
        while (blocked && attempts < 20) {
          blocked = false;
          for (let ci = 0; ci < row.length; ci++) {
            const x = parentPos.x - halfW + ci * COL_GAP;
            if (overlaps(x, rowY)) { blocked = true; rowY += ROW_GAP; break; }
          }
          attempts++;
        }

        row.forEach((child, ci) => {
          const x = parentPos.x - halfW + ci * COL_GAP;
          allPos.set(child.id, { x, y: rowY });
        });
      }
    });

    return lnodes.map(n => ({ ...n, position: allPos.get(n.id) || snapshotPos.get(n.id) || n.position }));
  }, []);

  const handleTreeNodeToggle = useCallback((node) => {
    if (!node.data?.expandable) return;
    const data = liveDataRef.current;
    if (!data) return;

    // Snapshot positions before any state change
    const currentNodes = rfInstance.current?.getNodes() || [];
    const snapshotPos = new Map(currentNodes.map(n => [n.id, n.position]));

    setFtExpandedIds(prev => {
      const next = new Set(prev);
      if (next.has(node.id)) next.delete(node.id);
      else next.add(node.id);

      const { nodes: lnodes, edges: ledges } = buildFamilyTree(data, next);
      setEdges(ledges);

      const hasNew = lnodes.some(n => !snapshotPos.has(n.id));

      if (hasNew) {
        // Expanding — park new nodes at their parent's position, hidden
        setNodes(lnodes.map(n => {
          if (snapshotPos.has(n.id)) return { ...n, position: snapshotPos.get(n.id) };
          const parentEdge = ledges.find(e => e.target === n.id);
          const parentPos = parentEdge ? (snapshotPos.get(parentEdge.source) || {x:0,y:0}) : {x:0,y:0};
          return { ...n, position: parentPos, style: { ...(n.style||{}), opacity:0 } };
        }));
      } else {
        // Collapsing — restore known positions, hide outgoing nodes briefly
        setNodes(lnodes.map(n => ({ ...n, position: snapshotPos.get(n.id) || n.position, style: { ...(n.style||{}), opacity:0 } })));
      }

      // Run ELK then reveal
      setTimeout(async () => {
        const cur = rfInstance.current;
        if (!cur) return;
        const laid = await elkLayout(cur.getNodes(), cur.getEdges(), treeElkRef.current);
        setNodes(laid.map(n => ({ ...n, style: { ...(n.style||{}), opacity:1, transition:'opacity 0.2s' } })));
        setTimeout(() => cur.fitView({ padding:0.25, duration:400 }), 80);
      }, 30);

      return next;
    });
  }, []);

  // Collapse back to the single server icon
  const handleCollapseToServer = useCallback(() => {
    const data = liveDataRef.current;
    setLiveCollapsed(true);
    setLiveExpanded({});
    setLiveSelectedAgent(null);
    setNodes(buildCollapsedServerNode(data));
    setEdges([]);
    setTimeout(() => rfInstance.current?.fitView({ padding: 0.3, duration: 400 }), 100);
  }, [buildCollapsedServerNode]);

  // Load live data — starts collapsed, just the one server icon
  const loadLive = useCallback(async () => {
    setLiveLoading(true);
    liveLoadingRef.current = true;
    setLiveError(null);
    setLiveExpanded({});
    setLiveSelectedAgent(null);
    setNodes([]);
    setEdges([]);
    try {
      const resp = await fetch('/api/gateway-live');
      const data = await resp.json();
      if (!data.ok) throw new Error(data.error || 'Failed');
      setLiveData(data);
      liveDataRef.current = data;
      setLiveSkills(data.skills || []);
      // Start expanded — build the full family tree
      setLiveCollapsed(false);
      setFtExpandedIds(new Set());
      await applyFamilyTree(new Set());
    } catch(e) {
      setLiveError(e.message);
    }
    setLiveLoading(false);
    liveLoadingRef.current = false;
  }, [buildCollapsedServerNode, applyFamilyTree]);

  // Silent background refresh — updates data without resetting layout/selection
  const refreshLive = useCallback(async () => {
    if (liveLoadingRef.current) return;
    try {
      const resp = await fetch('/api/gateway-live');
      const data = await resp.json();
      if (!data.ok) return;
      const prev = liveDataRef.current;
      liveDataRef.current = data;
      setLiveData(data);
      setLiveLastRefresh(Date.now());
      setLiveRefreshTick(0);
      // Only re-render tree if data actually changed (session count, cron state, etc.)
      const prevSig = JSON.stringify({ a: prev?.agents?.length, s: prev?.sessions?.length, c: prev?.cronJobs?.map(j=>j.lastStatus) });
      const nextSig = JSON.stringify({ a: data.agents?.length,  s: data.sessions?.length,  c: data.cronJobs?.map(j=>j.lastStatus) });
      if (prevSig !== nextSig) await applyFamilyTree(ftExpandedIdsRef.current, false);
    } catch {}
  }, [applyFamilyTree]); // ftExpandedIdsRef always current via sync effect; liveLoadingRef always current

  // Auto-refresh every 30 seconds
  React.useEffect(() => {
    autoRefreshRef.current = setInterval(refreshLive, 30_000);
    return () => clearInterval(autoRefreshRef.current);
  }, [refreshLive]);

  // Tick counter for "N seconds ago" display
  React.useEffect(() => {
    const t = setInterval(() => setLiveRefreshTick(s => s + 1), 1000);
    return () => clearInterval(t);
  }, []);

  // Set liveLastRefresh on initial load
  React.useEffect(() => {
    if (liveData && !liveLastRefresh) setLiveLastRefresh(Date.now());
  }, [liveData]);

  // Global keyboard shortcuts (defined AFTER refreshLive to avoid temporal dead zone)
  React.useEffect(() => {
    const handler = (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
      if (e.key === 'Escape') { setLiveSelectedAgent(null); }  // panel stays open
      if ((e.key === 'r' || e.key === 'R') && !e.metaKey && !e.ctrlKey) { e.preventDefault(); refreshLive(); }
    };
    window.addEventListener('keydown', handler);
    return () => window.removeEventListener('keydown', handler);
  }, [refreshLive]);

  // Expand/collapse sections from gateway node
  const handleLiveToggle = useCallback((section) => {
    const data = liveDataRef.current;
    if (!data) return;

    setLiveExpanded(prev => {
      const nowExpanded = !prev[section];
      const next = { ...prev, [section]: nowExpanded };

      const sectionCardId = `live-sec-${section}`;
      const sectionEdgeId = `e-live-sec-${section}`;

      if (nowExpanded) {
        // Remove section card, add expanded content — hidden until ELK positions them
        const { addNodes, addEdges } = buildExpandedNodes(section, data, next);
        const hiddenAdd = addNodes.map(n => ({ ...n, style: { ...(n.style||{}), opacity:0 } }));
        setEdges(eds => [...eds.filter(e => e.id !== sectionEdgeId), ...addEdges]);
        setNodes(nds => [...nds.filter(n => n.id !== sectionCardId), ...hiddenAdd]);
        setTimeout(async () => {
          const cur = rfInstance.current;
          if (!cur) return;
          const laid = await elkLayout(cur.getNodes(), cur.getEdges(), treeElkRef.current);
          setNodes(laid.map(n => ({ ...n, style: { ...(n.style||{}), opacity:1, transition:'opacity 0.2s' } })));
          setTimeout(() => cur.fitView({ padding:0.25, duration:400 }), 80);
        }, 50);
      } else {
        // Remove expanded content, restore section card
        const prefixMap = { agents:'live-ag-', channels:'live-ch-', skills:'live-skills', sessions:'live-sessions', cron:'live-cron', nodes:'live-nodes', models:'live-models' };
        const edgePrefixMap = { agents:'eag-', channels:'ech-', skills:'eskills', sessions:'esessions', cron:'ecron', nodes:'enodes', models:'emodels' };
        const prefix = prefixMap[section] || `live-${section}`;
        const edgePrefix = edgePrefixMap[section] || `e${section}`;
        const COLORS = { agents:'#818cf8', skills:'#4ade80', channels:'#22d3ee', sessions:'#f59e0b', cron:'#a855f7', nodes:'#22d3ee', models:'#f97316' };
        const LABELS = { agents:'Agents', skills:'Skills', channels:'Channels', sessions:'Sessions', cron:'Cron Jobs', nodes:'Nodes', models:'Models' };
        const COUNTS = { agents:data.agents?.length||0, skills:data.skills?.length||0, channels:data.channels?.length||0, sessions:data.sessions?.length||0, cron:data.cronJobs?.length||0, nodes:data.nodes?.length||0, models:data.models?.length||0 };

        setNodes(nds => [
          ...nds.filter(n => !n.id.startsWith(prefix) && n.id !== sectionCardId),
          { id: sectionCardId, type:'sectioncard', position: nds.find(n => n.id.startsWith(prefix))?.position || {x:0,y:0},
            data:{ label:LABELS[section], count:COUNTS[section], color:COLORS[section], sectionKey:section } },
        ]);
        setEdges(eds => [
          ...eds.filter(e => !e.id.startsWith(edgePrefix) && e.id !== sectionEdgeId),
          { id:sectionEdgeId, source:'live-gw', target:sectionCardId, type:'smoothstep',
            style:{stroke:COLORS[section],strokeWidth:1.5,opacity:0.65}, animated:true },
        ]);
        setTimeout(async () => {
          const cur = rfInstance.current;
          if (!cur) return;
          const laid = await elkLayout(cur.getNodes(), cur.getEdges(), treeElkRef.current);
          setNodes(laid);
          setTimeout(() => cur.fitView({ padding:0.25, duration:400 }), 80);
        }, 50);
      }

      // Update gateway node expanded state
      setNodes(nds => nds.map(n =>
        n.id === 'live-gw' ? { ...n, data: { ...n.data, expanded: next } } : n
      ));

      return next;
    });
  }, []);

  // Register global handlers
  React.useEffect(() => {
    window.__liveToggle = handleLiveToggle;
    window.__liveCronClick = (job) => {
      setLiveSelectedAgent({ ...job, _nodeType: 'cronlist' });
    };
    window.__liveNewCron = () => {
      setLiveSelectedAgent({ _nodeType: 'cronlist' }); // no id = create mode
    };
    window.__liveNewChannel = () => {
      setLiveSelectedAgent({ _nodeType: 'newchannel', _new: true });
    };
    window.__liveShowGateway = () => {
      const gwNode = nodes.find(n => n.id === 'live-gw');
      if (gwNode) setLiveSelectedAgent({ ...gwNode.data, _config: liveDataRef.current?.config || {}, _nodeType: 'livegateway' });
    };
    window.__liveSkillToggled = (skillId, newEnabled) => {
      // Update the skills list node data in-place
      setNodes(nds => nds.map(n =>
        n.id === 'live-skills'
          ? { ...n, data: { ...n.data, skills: n.data.skills.map(s => s.id === skillId ? {...s, enabled:newEnabled} : s) } }
          : n
      ));
      setLiveSkills(prev => prev.map(s => s.id === skillId ? {...s, enabled:newEnabled} : s));
    };
    return () => { delete window.__liveToggle; delete window.__liveShowGateway; delete window.__liveSkillToggled; };
  }, [handleLiveToggle, nodes]);

  const toggleLive = useCallback(() => {
    if (liveMode) {
      setLiveMode(false);
      setLiveSelectedAgent(null);
      setLiveExpanded({});
      liveDataRef.current = null;
      try {
        const saved = JSON.parse(localStorage.getItem('vf-forge'));
        if (saved?.nodes?.length) { setNodes(saved.nodes); setEdges(saved.edges||[]); }
        else { setNodes(INITIAL_NODES); setEdges([]); }
      } catch(e) { setNodes(INITIAL_NODES); setEdges([]); }
    } else {
      setLiveMode(true);
      loadLive();
    }
  }, [liveMode, loadLive]);

  const onConnect = useCallback(params => {
    if (liveMode) return;
    const newEdges = addEdge({
      ...params, type:'smoothstep',
      style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65},
    }, edges);
    setEdges(newEdges);
    save(nodes, newEdges);
  }, [edges, nodes, save, liveMode]);

  const onNodeClick = useCallback((_, node) => {
    if (node.type === 'collapsedserver' || node.type === 'livegateway') {
      const d = liveDataRef.current;
      if (d) setLiveSelectedAgent({
        ...(d.gateway || {}),
        agentCount:   d.agents?.length || 0,
        skillCount:   d.skills?.filter(s=>s.enabled!==false).length || 0,
        channelCount: d.channels?.length || 0,
        sessionCount: d.sessions?.length || 0,
        cronCount:    d.cronJobs?.length || 0,
        nodeCount:    d.nodes?.length || 0,
        modelCount:   d.models?.length || 0,
        _config:      d.config || {},
        _nodeType: 'livegateway',
      });
      return;
    }
    if (node.type === 'sectioncard') {
      handleLiveToggle(node.data.sectionKey);
      return;
    }
    if (node.type === 'treeicon') {
      handleTreeNodeToggle(node);
      const nt = node.data?._nodeType;
      // All treeicon nodes route through liveSelectedAgent — consistent panel for everything
      setLiveSelectedAgent(prev =>
        prev?._nodeType === (nt||'group') && prev?.id === (node.data?.id||node.id) ? null
        : { ...node.data, _nodeType: nt || 'group', id: node.data?.id || node.id }
      );
      return;
    }
    setLiveSelectedAgent({ ...node.data, _nodeType: node.type });
  }, [handleLiveToggle, handleTreeNodeToggle]);

  // Update a live node's data after saving (e.g. agent model change)
  const handleNodeUpdate = useCallback((node, patch) => {
    setNodes(nds => nds.map(n =>
      n.id.includes(node.agentId || node.id) ? { ...n, data: { ...n.data, ...patch } } : n
    ));
  }, []);

  const onPaneClick = useCallback(() => {
    setSelectedNode(null);
    setSelectedTreeNode(null);
    if (liveMode) setLiveSelectedAgent(null);
  }, [liveMode]);

  const updateNode = useCallback((id, key, value) => {
    setNodes(nds => {
      const updated = nds.map(n =>
        n.id === id ? { ...n, data: { ...n.data, [key]: value } } : n
      );
      save(updated, edges);
      return updated;
    });
    setSelectedNode(prev =>
      prev?.id === id ? { ...prev, data: { ...prev.data, [key]: value } } : prev
    );
  }, [edges, save]);

  const addNode = useCallback(type => {
    if (liveMode) return;
    if (['quickstart','team','research'].includes(type)) {
      loadTemplate(type, setNodes, setEdges, save);
      setSelectedNode(null);
      return;
    }
    const defaults = {
      gateway:{ label:'My Gateway', desc:'' },
      agent:  { label:'New Agent', model:'upstage/solar-pro-3:free', systemPrompt:'' },
      skill:  { label:'New Skill', skill:'web-search' },
      model:  { label:'GPT-4o', provider:'openai' },
      channel:{ label:'Telegram', channelType:'telegram' },
    };
    const vp = rfInstance.current?.getViewport() || { x:0, y:0, zoom:1 };
    const x = (-vp.x + window.innerWidth/2) / vp.zoom - 100;
    const y = (-vp.y + window.innerHeight/2) / vp.zoom - 40;
    const id = `${type}-${Date.now()}`;
    const newNode = { id, type, position:{x,y}, data: defaults[type] || { label:'Node' } };
    setNodes(nds => { const upd = [...nds, newNode]; save(upd, edges); return upd; });
  }, [edges, save, liveMode]);

  const handleToggleSkill = useCallback((skillId, newEnabled) => {
    setLiveSkills(prev => prev.map(s => s.id === skillId ? {...s, enabled:newEnabled} : s));
  }, []);

  const runningCron = liveData?.cronJobs?.filter(j => j.lastStatus === 'running').length || 0;

  const PANEL_W = 340;
  const TAB_W   = 20;

  // After panel open/close, re-fit the view so the diagram uses the new canvas width
  React.useEffect(() => {
    const t = setTimeout(() => rfInstance.current?.fitView({ padding:0.25, duration:300 }), 280);
    return () => clearTimeout(t);
  }, [sidePanelOpen]);

  return (
    <div style={{display:'flex', height:'calc(100vh - 57px)', overflow:'hidden'}}>
      {/* Canvas — flex:1 so it shrinks/grows with the side panel */}
      <div style={{flex:1, position:'relative', minHeight:0, height:'100%', minWidth:0}}>
        {/* ── Live status bar ── */}
        {liveMode && (
          <div style={{
            position:'absolute', top:0, left:0, right:0, zIndex:10,
            background:'rgba(12,12,12,0.97)',
            borderBottom:'1px solid #1f1f1f',
            padding:'0 16px',
            height:34,
            display:'flex', alignItems:'center', gap:0,
            fontFamily:"'JetBrains Mono',monospace", fontSize:'0.68rem',
            userSelect:'none',
          }}>

            {/* LIVE / status badge */}
            <div style={{
              display:'flex', alignItems:'center', gap:7,
              paddingRight:14, marginRight:14,
              borderRight:'1px solid #222',
            }}>
              {liveLoading
                ? <span className="refresh-spin" style={{color:'#4ade80',fontSize:'0.8rem',lineHeight:1}}>⟳</span>
                : liveError
                  ? <span style={{width:7,height:7,borderRadius:'50%',background:'#ef4444',boxShadow:'0 0 8px rgba(239,68,68,0.8)',flexShrink:0}}/>
                  : <span style={{width:7,height:7,borderRadius:'50%',background:'#4ade80',boxShadow:'0 0 8px rgba(74,222,128,0.8)',flexShrink:0}}/>}
              <span style={{color: liveError ? '#ef4444' : '#4ade80', fontWeight:700, letterSpacing:'0.08em', fontSize:'0.65rem'}}>
                {liveError ? 'ERROR' : 'LIVE'}
              </span>
              {liveError
                ? <span style={{color:'#7f1d1d',fontSize:'0.6rem',maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{liveError}</span>
                : liveData?.gateway?.version
                  ? <span style={{color:'#444',fontSize:'0.6rem'}}>v{liveData.gateway.version}</span>
                  : null
              }
            </div>

            {/* Stats */}
            {!liveCollapsed && liveData && (() => {
              const SEP = <span style={{color:'#252525',margin:'0 10px'}}>│</span>;
              const VAL = (n, label) => (
                <span>
                  <span style={{color:'#ccc',fontWeight:600}}>{n}</span>
                  <span style={{color:'#555',marginLeft:4}}>{label}</span>
                </span>
              );
              return (
                <>
                  {VAL(liveData.agents?.length||0, 'agents')}
                  {SEP}
                  {VAL(liveSkills.filter(s=>s.enabled).length, 'skills')}
                  {SEP}
                  {VAL(liveData.channels?.length||0, 'channels')}
                  {SEP}
                  {VAL(liveData.sessions?.length||0, 'sessions')}
                  {SEP}
                  {VAL(nodes.length, 'nodes')}
                  {runningCron > 0 && (
                    <>{SEP}<span style={{color:'#f59e0b'}}><span className="refresh-spin" style={{display:'inline-block'}}>⟳</span> {runningCron} running</span></>
                  )}
                </>
              );
            })()}

            {liveCollapsed && (
              <span style={{color:'#555'}}>collapsed · click ⊞ Expand to open diagram</span>
            )}

            {/* Refresh info — pushed to right */}
            <div style={{marginLeft:'auto',display:'flex',alignItems:'center',gap:10}}>
              <span style={{color:'#444'}}>
                {liveRefreshTick < 5
                  ? <span style={{color:'#4ade80'}}>just refreshed</span>
                  : liveRefreshTick < 60
                    ? `refreshed ${liveRefreshTick}s ago`
                    : `refreshed ${Math.floor(liveRefreshTick/60)}m ago`}
              </span>
              <span style={{color:'#2a2a2a'}}>│</span>
              <span style={{color:'#3a6b47'}}>↺ {Math.max(0, 30 - liveRefreshTick)}s</span>
            </div>

          </div>
        )}
        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={liveMode ? undefined : onNodesChange}
          onEdgesChange={liveMode ? undefined : onEdgesChange}
          onConnect={onConnect}
          onNodeClick={onNodeClick}
          onPaneClick={onPaneClick}
          onInit={inst => rfInstance.current = inst}
          nodeTypes={nodeTypes}
          defaultEdgeOptions={{ type:'smoothstep', style:{stroke:'#ff5c5c',strokeWidth:1.5,opacity:0.65} }}
          nodesDraggable={!liveMode}
          nodesConnectable={!liveMode}
          minZoom={0.05}
          maxZoom={4}
          zoomOnScroll={true}
          zoomOnPinch={true}
          zoomOnDoubleClick={false}
          panOnDrag={true}
          panOnScroll={false}
          style={{ background:'#0a0a0a', paddingTop: liveMode ? 34 : 0 }}
          proOptions={{ hideAttribution: true }}
        >
          <Background variant="dots" gap={28} size={1} color="#252525" />
          <Controls position="bottom-left" showInteractive={false} style={{
            background:'#111', border:'1px solid #2a2a2a', borderRadius:8,
            overflow:'hidden', boxShadow:'0 4px 16px rgba(0,0,0,0.6)',
          }}/>
          <Panel position="top-right" style={{display:'flex',gap:6,marginTop: liveMode ? 42 : 8,marginRight:8,alignItems:'center'}}>
            {!liveCollapsed && <>
              {Object.entries(LAYOUT_OPTS).map(([key, preset]) => (
                <NavBtn key={key} title={preset.label}
                  style={layoutKey === key ? {background:'#ff5c5c',color:'#000',borderColor:'#ff5c5c'} : {}}
                  onClick={() => {
                    setLayoutKey(key);
                    treeElkRef.current = preset.elk;
                    applyFamilyTree(ftExpandedIdsRef.current);
                  }}>{preset.icon}</NavBtn>
              ))}
              <div style={{width:1,height:18,background:'#333',margin:'0 2px'}}/>
              <NavBtn onClick={handleCollapseToServer}>⊟</NavBtn>
            </>}
            {liveCollapsed && <NavBtn onClick={handleExpandServer} primary>⊞ Expand</NavBtn>}
            <NavBtn onClick={liveLoading ? undefined : loadLive} primary>{liveLoading ? '↻…' : '↺ Refresh'}</NavBtn>
          </Panel>

        </ReactFlow>
      </div>

      {/* ── Side panel ── */}
      {liveMode && (
        <div style={{
          display:'flex', flexShrink:0,
          width: sidePanelOpen ? TAB_W + PANEL_W : TAB_W,
          transition:'width 0.25s cubic-bezier(0.4,0,0.2,1)',
          overflow:'hidden',
          borderLeft:'1px solid #141414',
          background:'#0a0a0a',
          position:'relative',
        }}>

          {/* Collapse tab — always visible */}
          <button
            onClick={() => setSidePanelOpen(p => !p)}
            title={sidePanelOpen ? 'Collapse panel' : 'Open panel'}
            style={{
              width: TAB_W, flexShrink:0, height:'100%',
              background:'transparent', border:'none', borderRight:'1px solid #141414',
              cursor:'pointer', display:'flex', flexDirection:'column',
              alignItems:'center', justifyContent:'center', gap:12,
              color:'#2a2a2a', transition:'color 0.15s, background 0.15s',
              padding:0,
            }}
            onMouseEnter={e => { e.currentTarget.style.background='#111'; e.currentTarget.style.color='#555'; }}
            onMouseLeave={e => { e.currentTarget.style.background='transparent'; e.currentTarget.style.color='#2a2a2a'; }}
          >
            {/* Chevron */}
            <span style={{
              fontSize:'0.65rem', lineHeight:1,
              transform: sidePanelOpen ? 'rotate(0deg)' : 'rotate(180deg)',
              transition:'transform 0.25s',
              display:'inline-block',
            }}>‹</span>

            {/* Vertical label when collapsed */}
            {!sidePanelOpen && liveSelectedAgent && (
              <span style={{
                fontFamily:"'JetBrains Mono',monospace", fontSize:'0.5rem', color:'#333',
                writingMode:'vertical-rl', textOrientation:'mixed',
                transform:'rotate(180deg)', maxHeight:120,
                overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap',
                letterSpacing:'0.05em',
              }}>
                {liveSelectedAgent.label || liveSelectedAgent._nodeType || 'node'}
              </span>
            )}
          </button>

          {/* Panel content — fixed width inside the expanding container */}
          <div style={{
            width: PANEL_W, flexShrink:0, height:'100%',
            display:'flex', flexDirection:'column', overflow:'hidden',
          }}>
            {liveSelectedAgent ? (
              <LiveNodePanel
                node={liveSelectedAgent}
                skills={liveSkills}
                models={liveData?.models || []}
                onClose={() => setLiveSelectedAgent(null)}
                onToggleSkill={handleToggleSkill}
                onNodeUpdate={handleNodeUpdate}
                onCronCreated={(job) => {
                  if (liveDataRef.current) {
                    liveDataRef.current = { ...liveDataRef.current, cronJobs: [...(liveDataRef.current.cronJobs||[]), job] };
                    setLiveData(liveDataRef.current);
                  }
                  setLiveSelectedAgent(null);
                  setTimeout(() => applyFamilyTree(ftExpandedIdsRef.current, false), 50);
                }}
                onChannelCreated={(ch) => {
                  if (liveDataRef.current) {
                    liveDataRef.current = { ...liveDataRef.current, channels: [...(liveDataRef.current.channels||[]), ch] };
                    setLiveData(liveDataRef.current);
                  }
                  setLiveSelectedAgent(null);
                  setTimeout(() => applyFamilyTree(ftExpandedIdsRef.current, false), 50);
                }}
              />
            ) : (
              /* Empty state — panel open but nothing selected */
              <div style={{
                height:'100%', display:'flex', flexDirection:'column',
                alignItems:'center', justifyContent:'center', gap:14,
                padding:24, textAlign:'center',
              }}>
                <div style={{fontSize:'2.5rem', opacity:0.35}}>⌥</div>
                <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.9rem',color:'#777',lineHeight:1.7}}>
                  click any node<br/>to inspect &amp; edit
                </div>
                <div style={{fontFamily:"'JetBrains Mono',monospace",fontSize:'0.75rem',color:'#444',marginTop:4,lineHeight:1.9}}>
                  ESC · clear selection<br/>R · refresh
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {!liveMode && (
        <ConfigPanel node={selectedNode} onClose={() => setSelectedNode(null)} onUpdate={updateNode} />
      )}

      {showAiModal && (
        <AiBuildModal
          onClose={() => setShowAiModal(false)}
          onResult={result => { applyAiResult(result, setNodes, setEdges); setShowAiModal(false); }}
        />
      )}
      {showExportModal && (
        <ExportModal nodes={nodes} edges={edges} onClose={() => setShowExportModal(false)} />
      )}
    </div>
  );
}

const root = createRoot(document.getElementById('forge-root'));
root.render(<ForgeApp />);
  </script>

  <script src="/auth.js"></script>
    <script src="/features.js"></script>
  <script>
    VibeclawAuth.init().then(() => {
      VibeclawAuth.renderButton('auth-container');
      VibeclawFeatures.renderUpgradeButton('upgrade-container');
      VibeclawFeatures.checkPro();
    });
    // Show Pro models in preview mode
    if (VibeclawFeatures && VibeclawFeatures.isPreview()) {
      document.querySelectorAll('.pro-model').forEach(el => el.style.display = '');
    }
  </script>

  <script src="/clawdio.js"></script>
</body>
</html>
