<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/favicon.ico" sizes="32x32">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat â€” vibeclaw | AI Agent Chat Interface</title>
  <meta name="description" content="Chat with your OpenClaw AI agents in the browser. Session management, live streaming responses, and full message history." />
  <meta name="keywords" content="openclaw, chat, ai agent, conversation, vibeclaw">
  <meta name="author" content="vibeclaw">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://vibeclaw.dev/chat.html">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://vibeclaw.dev/chat.html">
  <meta property="og:title" content="Chat â€” vibeclaw">
  <meta property="og:description" content="Chat interface for OpenClaw AI agents. Session management and live streaming.">
  <meta property="og:image" content="https://vibeclaw.dev/og-image.png">
  <meta property="og:site_name" content="vibeclaw.dev">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@vibeclaw">
  <meta name="twitter:creator" content="@jasonkneen">
  <meta name="twitter:title" content="Chat â€” vibeclaw">
  <meta name="twitter:description" content="Chat with OpenClaw AI agents in your browser.">
  <meta name="twitter:image" content="https://vibeclaw.dev/og-image.png">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff5c5c' stroke-width='1.5'><path d='M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z'/></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fragment+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap&font-display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #0a0a0a;
      --surface: #141414;
      --surface-2: #1a1a1a;
      --border: #2a2a2a;
      --border-active: #3a3a3a;
      --text: #999;
      --text-dim: #666;
      --text-bright: #e0e0e0;
      --accent: #ff5c5c;
      --accent-bg: rgba(255,92,92,0.06);
      --green: #4ade80;
      --blue: #60a5fa;
      --sans: 'DM Sans', system-ui, sans-serif; --code: 'JetBrains Mono', 'SF Mono', 'Menlo', monospace;
      --mono: 'Fragment Mono', 'JetBrains Mono', 'Menlo', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; scroll-behavior: smooth; }
    body {
      font-family: var(--sans);
      background: var(--black);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }
    /* â”€â”€ Nav â€” canonical â”€â”€ */
    nav { background: rgba(0,0,0,0.85); border-bottom: 1px solid #1a1a1a; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 500; flex-shrink: 0; }
    .nav-inner { width: 100%; padding: 0 32px; height: 52px; display: flex; align-items: center; justify-content: space-between; box-sizing: border-box; }
    .nav-logo { font-family: var(--mono,'Courier New',monospace); font-size: 0.9rem; font-weight: 600; color: var(--accent,#ff5c5c); text-decoration: none; }
    .nav-links { display: flex; gap: 32px; list-style: none; align-items: center; margin: 0; padding: 0; }
    .nav-links a { font-family: var(--mono,'Courier New',monospace); font-size: 0.78rem; color: var(--text-dim,#666); text-decoration: none; text-transform: uppercase; letter-spacing: 0.06em; transition: color 0.15s; }
    .nav-links a:hover, .nav-links a.nav-active { color: var(--text-bright,#fff); }
    @media (max-width: 600px) { .nav-inner { padding: 0 12px; height: 48px; } .nav-links { gap: 8px; } .nav-links a { font-size: 0.6rem; } .nav-hide-mobile { display: none; } }
    /* â”€â”€ Footer â”€â”€ */
    .chat-footer {
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-dim);
      background: var(--black);
    }
    .chat-footer a { color: var(--text-dim); text-decoration: none; transition: color 0.15s; }
    .chat-footer a:hover { color: var(--text-bright); }
    a { color: var(--accent); text-decoration: none; }

    /* â”€â”€ Layout â”€â”€ */
    .chat-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* â”€â”€ Nav â”€â”€ */
    .chat-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(10,10,10,0.9);
      backdrop-filter: blur(12px);
    }
    .chat-nav-brand {
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-bright);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-nav-links {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .chat-nav-links a {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .chat-nav-links a:hover { color: var(--text-bright); }

    /* â”€â”€ Sidebar â”€â”€ */
    .chat-sidebar {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
    }
    .btn-new-chat {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 0.65rem;
      transition: all 0.15s;
    }
    .btn-new-chat:hover { border-color: var(--accent); color: var(--accent); }

    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .session-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      border: 1px solid transparent;
    }
    .session-item:hover {
      background: var(--surface-2);
      border-color: var(--border-active);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .session-item.active {
      background: var(--accent-bg);
      border-color: var(--accent);
    }
    .session-name {
      font-size: 0.8rem;
      color: var(--text-bright);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .session-preview {
      font-size: 0.7rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .session-meta {
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-top: 4px;
    }
    .session-delete {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 2px;
      margin-left: auto;
      transition: opacity 0.15s;
    }
    .session-item:hover .session-delete { opacity: 1; }
    .session-delete:hover { color: var(--accent); }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
    }
    .status-dot.online { background: var(--green); }

    .sidebar-empty {
      padding: 32px 16px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* â”€â”€ Main chat â”€â”€ */
    .chat-main {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      box-shadow: 0 0 16px rgba(0,0,0,0.2);
    }

    /* â”€â”€ Chat header â”€â”€ */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--black);
    }
    .chat-peer-name {
      font-family: var(--sans);
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-bright);
    }
    .chat-peer-model {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .chat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 0.7rem;
      margin-left: auto;
    }
    .chat-status.connected { color: var(--green); }
    .chat-status.connecting { color: var(--text-dim); }
    .chat-status.offline { color: var(--text-dim); }

    /* â”€â”€ Messages â”€â”€ */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .msg {
      display: flex;
      gap: 12px;
      max-width: 80%;
    }
    .msg.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .msg.user .msg-avatar {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.15);
    }
    .msg.assistant .msg-avatar {
      background: var(--surface-2);
      border: 1px solid var(--border);
    }
    .msg-avatar svg {
      width: 12px;
      height: 12px;
      color: var(--text-dim);
    }
    .msg.user .msg-avatar svg { color: var(--accent); }

    .msg-body { min-width: 0; }
    .msg-bubble {
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.85rem;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .msg.user .msg-bubble {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.12);
      color: var(--text-bright);
      border-top-right-radius: 4px;
    }
    .msg.assistant .msg-bubble {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-top-left-radius: 4px;
    }
    .msg.error .msg-bubble {
      background: rgba(244,67,54,0.06);
      border: 1px solid rgba(244,67,54,0.15);
      color: #f87171;
    }

    .msg-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      padding: 0 4px;
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-dim);
    }
    .msg.user .msg-meta { justify-content: flex-end; }

    .msg-action {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .msg:hover .msg-action { opacity: 1; }
    .msg-action:hover { color: var(--accent); background: var(--accent-bg); }

    /* Code blocks in messages */
    .msg-bubble pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-family: var(--code);
      font-size: 0.78rem;
      line-height: 1.5;
    }
    .msg-bubble code {
      font-family: var(--code);
      font-size: 0.8rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1px 5px;
    }
    .msg-bubble pre code {
      background: none;
      border: none;
      padding: 0;
    }

    /* Streaming cursor */
    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 14px;
      background: var(--accent);
      opacity: 0.6;
      margin-left: 2px;
      animation: blink 1s step-end infinite;
      vertical-align: text-bottom;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Loading dots */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }
    .loading-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--text-dim);
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* â”€â”€ Chat empty state â”€â”€ */
    .chat-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      color: var(--text-dim);
    }
    .chat-empty svg { width: 40px; height: 40px; color: var(--border-active); }
    .chat-empty p { font-size: 0.85rem; }

    /* â”€â”€ Input bar â”€â”€ */
    .chat-input-bar {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .chat-input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .chat-input {
      flex: 1;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      font-family: var(--sans);
      font-size: 0.85rem;
      color: var(--text-bright);
      outline: none;
      resize: none;
      max-height: 120px;
      line-height: 1.5;
    }
    .chat-input:focus { border-color: var(--accent); }
    .chat-input::placeholder { color: var(--text-dim); }
    .chat-input:disabled { opacity: 0.5; }
    .chat-send {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 14px 20px;
      min-width: 44px;
      min-height: 44px;
      cursor: pointer;
      color: #000;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-send:hover { background: #ff7070; }
    .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .chat-send svg { width: 16px; height: 16px; }

    /* â”€â”€ Endpoint config bar â”€â”€ */
    .endpoint-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      font-family: var(--mono);
      font-size: 0.7rem;
    }
    .endpoint-bar label { color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; white-space: nowrap; }
    .endpoint-bar input, .endpoint-bar select {
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--text-bright);
      outline: none;
    }
    .endpoint-bar input:focus, .endpoint-bar select:focus { border-color: var(--accent); }
    .endpoint-bar input { flex: 1; }
    .endpoint-connect {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s;
    }
    .endpoint-connect:hover { background: #ff7070; }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 768px) {
      .chat-layout { grid-template-columns: 1fr; }
      .chat-sidebar { display: none; }
    }

    @media (max-width: 600px) {
      #auth-container { margin-left: 2px !important; }
      .auth-login-btn { padding: 3px 6px !important; font-size: 0.55rem !important; }
      .auth-login-btn svg { width: 9px !important; height: 9px !important; }
      .auth-user { gap: 4px !important; }
      .auth-avatar { width: 18px !important; height: 18px !important; }
      .auth-name { max-width: 50px !important; font-size: 0.55rem !important; }
      .auth-logout-btn { padding: 2px 4px !important; font-size: 0.5rem !important; }
    }

    @media (max-width: 380px) {
      .auth-text { display: none; }
      .auth-login-btn { padding: 3px 5px !important; }
      .auth-name { display: none; }
      .auth-logout-btn { font-size: 0.45rem !important; padding: 2px 3px !important; }
    }
  </style>
</head>
<body>

  <nav role="navigation" aria-label="Main navigation">
    <div class="nav-inner">
      <a href="/" class="nav-logo" aria-label="vibeclaw.dev home"><img src="/logo.png" alt="VibeClaw" style="height:44px;vertical-align:middle;"></a>
      <ul class="nav-links" role="list">
        <li><a href="/explore.html">Explore</a></li>
        <li><a href="/create.html">Create</a></li>
        <li class="nav-hide-mobile"><a href="/forge.html">Forge</a></li>
        <li class="nav-hide-mobile"><a href="/news.html">News</a></li>
        <li class="nav-hide-mobile"><a href="/docs/">Docs</a></li>
        <li class="nav-more-wrap" style="position:relative;">
          <button id="nav-more-btn" style="background:none;border:1px solid #1a1a1a;border-radius:6px;padding:3px 8px;font-family:var(--mono,'Courier New',monospace);font-size:0.62rem;color:#666;cursor:pointer;display:inline-flex;align-items:center;gap:4px;transition:all 0.15s;white-space:nowrap;">More <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:10px;height:10px;"><polyline points="6 9 12 15 18 9"/></svg></button>
          <div id="nav-more-menu" style="display:none;position:absolute;top:calc(100% + 6px);right:0;background:#111;border:1px solid #222;border-radius:8px;padding:6px 0;min-width:180px;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,0.4);">
            <a href="/library.html" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;">My Library</a>
            <a href="/gallery.html" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;">Wallpapers</a>
            <div style="height:1px;background:#222;margin:4px 0;"></div>
            <a href="https://openclaw.ai" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;">OpenClaw</a>
            <a href="https://github.com/jasonkneen/vibeclaw" style="display:block;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;">GitHub</a>
            <a href="https://x.com/i/communities/2023680827435978937" style="display:flex;align-items:center;gap:6px;padding:8px 16px;font-family:var(--mono,'Courier New',monospace);font-size:0.75rem;color:#ccc;text-decoration:none;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:12px;height:12px;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>Community</a>
          </div>
        </li>
        <li id="auth-container" style="margin-left:4px;"></li>
      </ul>
    </div>
  </nav>
  <script>
  (function(){
    var btn=document.getElementById('nav-more-btn'),menu=document.getElementById('nav-more-menu');
    if(!btn||!menu)return;
    btn.addEventListener('click',function(e){e.stopPropagation();var o=menu.style.display!=='none';menu.style.display=o?'none':'block';btn.style.borderColor=o?'#1a1a1a':'#ff5c5c';btn.style.color=o?'#666':'#ff5c5c';});
    document.addEventListener('click',function(){menu.style.display='none';btn.style.borderColor='#1a1a1a';btn.style.color='#666';});
    menu.querySelectorAll('a').forEach(function(a){a.addEventListener('mouseenter',function(){a.style.background='#1a1a1a';});a.addEventListener('mouseleave',function(){a.style.background='transparent';});});
    var path=location.pathname.replace(/\/$/,'')||'/';
    document.querySelectorAll('.nav-links a').forEach(function(a){var h=(a.getAttribute('href')||'').replace(/\/$/,'');if(h&&path.endsWith(h))a.classList.add('nav-active');});
  })();
  </script>

  <div style="display:flex;flex-direction:column;height:100vh;overflow:hidden;">
    <div class="chat-layout">
      <!-- Sidebar -->
      <div class="chat-sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">Sessions</span>
          <button class="btn-new-chat" id="new-chat-btn">+ New</button>
        </div>
        <div class="session-list" id="session-list">
          <div class="sidebar-empty" id="sidebar-empty">No sessions yet</div>
        </div>
      </div>

      <!-- Main -->
      <div class="chat-main">
      <!-- Hidden fields for compatibility -->
      <input type="hidden" id="endpoint-url" value="/api/chat" />
      <select id="endpoint-model" style="display:none;">
        <option value="upstage/solar-pro-3:free" selected>Solar Pro 3</option>
      </select>
      <button id="connect-btn" style="display:none;"></button>

      <!-- Header -->
      <div class="chat-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="chat-peer-name" id="peer-name">VibeClaw Chat</div>
          <select id="chat-flavour-select" style="padding:4px 8px;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;color:var(--text-bright);font-family:var(--mono);font-size:0.7rem;outline:none;cursor:pointer;">
            <option value="default">OpenClaw</option>
          </select>
        </div>
        <div class="chat-status connected" id="chat-status" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/></svg>
          <span>Ready</span>
        </div>
      </div>

      <!-- Messages -->
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty" id="chat-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          <p>Pick a server above and start typing</p>
        </div>
      </div>

      <!-- Input -->
      <div class="chat-input-bar">
        <div class="chat-input-row">
          <textarea id="chat-input" class="chat-input" placeholder="Type a message..." rows="1"></textarea>
          <button id="chat-send" class="chat-send" aria-label="Send message">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="chat-footer">
      <a href="https://vibeclaw.dev">vibeclaw</a>
      <a href="https://openclaw.ai">OpenClaw</a>
      <a href="https://github.com/jasonkneen/vibeclaw">GitHub</a>
      <span>MIT License</span>
    </div>
  </div>

  <script>
    // â”€â”€ State â”€â”€
    const state = {
      endpoint: '',
      model: 'default',
      connected: false,
      sessions: [],
      currentSessionId: null,
      messages: [],
      generating: false,
      abortController: null,
    };

    const $ = id => document.getElementById(id);
    const STORAGE_KEY = 'vibeclaw_chat_sessions';

    // â”€â”€ Load flavours + user servers into dropdown â”€â”€
    (async () => {
      const sel = $('chat-flavour-select');
      try {
        const resp = await fetch('/flavours.json');
        if (resp.ok) {
          chatAllFlavours = await resp.json();
          sel.innerHTML = '';
          for (const f of chatAllFlavours) {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = `${f.emoji} ${f.name}`;
            sel.appendChild(opt);
          }
        }
      } catch {}
      // Add user's saved servers
      try {
        const lib = JSON.parse(localStorage.getItem('clawforge-library') || '[]');
        if (lib.length > 0) {
          const sep = document.createElement('option');
          sep.disabled = true;
          sep.textContent = 'â”€â”€ My Servers â”€â”€';
          sel.appendChild(sep);
          for (const srv of lib) {
            const spec = srv.spec || srv;
            const opt = document.createElement('option');
            opt.value = 'lib:' + (srv.id || spec.id || spec.name);
            opt.textContent = `${spec.emoji || 'ðŸ”§'} ${spec.name || 'Custom'}`;
            opt.dataset.libSpec = JSON.stringify(spec);
            sel.appendChild(opt);
          }
        }
      } catch {}
    })();

    // â”€â”€ Persistence â”€â”€
    function loadSessions() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    }
    function saveSessions() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.sessions.slice(0, 50)));
    }

    // â”€â”€ Time formatting â”€â”€
    function relTime(ts) {
      const d = Date.now() - ts;
      if (d < 10000) return 'now';
      if (d < 60000) return Math.floor(d/1000) + 's';
      if (d < 3600000) return Math.floor(d/60000) + 'm';
      if (d < 86400000) return Math.floor(d/3600000) + 'h';
      return Math.floor(d/86400000) + 'd';
    }

    // â”€â”€ Escape HTML â”€â”€
    function esc(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // â”€â”€ Simple markdown-ish rendering â”€â”€
    function renderContent(text) {
      let h = esc(text);
      // Code blocks
      h = h.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) =>
        `<pre><code>${code}</code></pre>`);
      // Inline code
      h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold
      h = h.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text-bright);">$1</strong>');
      return h;
    }

    // â”€â”€ Render messages â”€â”€
    function renderMessages() {
      const container = $('chat-messages');
      const empty = $('chat-empty');

      if (state.messages.length === 0 && !state.generating) {
        empty.style.display = '';
        container.innerHTML = '';
        container.appendChild(empty);
        return;
      }

      empty.style.display = 'none';
      let html = '';

      for (const msg of state.messages) {
        const isUser = msg.role === 'user';
        const isError = msg.error;
        const cls = isUser ? 'user' : isError ? 'assistant error' : 'assistant';
        const avatarIcon = isUser
          ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0113 0"/></svg>'
          : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';

        const meta = [];
        if (msg.timestamp) meta.push(relTime(msg.timestamp));
        if (msg.tokens) meta.push(msg.tokens + ' tok');
        if (msg.model) meta.push(msg.model.split('/').pop().split(':')[0]);

        html += `<div class="msg ${cls}">
          <div class="msg-avatar">${avatarIcon}</div>
          <div class="msg-body">
            <div class="msg-bubble">${renderContent(msg.content)}</div>
            <div class="msg-meta">
              ${meta.join(' Â· ')}
              <button class="msg-action" onclick="copyMsg('${msg.id}')" title="Copy">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:10px;height:10px;"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              </button>
            </div>
          </div>
        </div>`;
      }

      // Streaming indicator
      if (state.generating) {
        html += `<div class="msg assistant">
          <div class="msg-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <div class="msg-body">
            <div class="msg-bubble"><div class="loading-dots"><span></span><span></span><span></span></div></div>
          </div>
        </div>`;
      }

      container.innerHTML = html;
      container.scrollTop = container.scrollHeight;
    }

    // â”€â”€ Copy message â”€â”€
    window.copyMsg = function(id) {
      const msg = state.messages.find(m => m.id === id);
      if (msg) navigator.clipboard.writeText(msg.content);
    };

    // â”€â”€ Render sessions â”€â”€
    function renderSessions() {
      const list = $('session-list');
      const empty = $('sidebar-empty');

      if (state.sessions.length === 0) {
        list.innerHTML = '';
        list.appendChild(empty);
        empty.style.display = '';
        return;
      }

      empty.style.display = 'none';
      list.innerHTML = state.sessions.map((s, i) => {
        const lastUser = [...s.messages].reverse().find(m => m.role === 'user');
        const active = s.id === state.currentSessionId;
        const count = s.messages.filter(m => m.role !== 'system').length;
        return `<div class="session-item ${active ? 'active' : ''}" onclick="loadSession('${s.id}')">
          <div class="session-name">
            <span class="status-dot ${state.connected ? 'online' : ''}"></span>
            <span>${esc(s.name || 'Chat')}</span>
            <button class="session-delete" onclick="event.stopPropagation();deleteSession('${s.id}')" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:10px;height:10px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
          </div>
          ${lastUser ? `<div class="session-preview">"${esc(lastUser.content.slice(0,50))}"</div>` : ''}
          <div class="session-meta">${count} msg Â· ${relTime(s.updatedAt)}</div>
        </div>`;
      }).join('');
    }

    // â”€â”€ Session management â”€â”€
    window.loadSession = function(id) {
      const session = state.sessions.find(s => s.id === id);
      if (!session) return;
      state.currentSessionId = id;
      state.messages = session.messages;
      renderMessages();
      renderSessions();
    };

    window.deleteSession = function(id) {
      state.sessions = state.sessions.filter(s => s.id !== id);
      saveSessions();
      if (state.currentSessionId === id) {
        state.currentSessionId = null;
        state.messages = [];
        renderMessages();
      }
      renderSessions();
    };

    function newSession() {
      const session = {
        id: crypto.randomUUID(),
        name: chatFlavour ? `${chatFlavour.emoji} ${chatFlavour.name}` : 'Chat',
        messages: [],
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      state.sessions.unshift(session);
      state.currentSessionId = session.id;
      state.messages = [];
      saveSessions();
      renderSessions();
      renderMessages();
    }

    function saveCurrentSession() {
      if (!state.currentSessionId) return;
      const session = state.sessions.find(s => s.id === state.currentSessionId);
      if (session) {
        session.messages = state.messages;
        session.updatedAt = Date.now();
        saveSessions();
        renderSessions();
      }
    }

    // â”€â”€ Active flavour state â”€â”€
    let chatFlavour = null;
    let chatAllFlavours = [];

    // â”€â”€ Connect â”€â”€
    function connect() {
      const sel = $('chat-flavour-select');
      const val = sel ? sel.value : '';

      // Resolve flavour
      if (val.startsWith('lib:')) {
        const opt = sel.querySelector(`option[value="${CSS.escape(val)}"]`);
        if (opt && opt.dataset.libSpec) {
          const spec = JSON.parse(opt.dataset.libSpec);
          chatFlavour = {
            name: spec.name || 'Custom Server',
            emoji: spec.emoji || 'ðŸ”§',
            systemPrompt: (spec.agents && spec.agents[0] && spec.agents[0].systemPrompt) || '',
          };
        }
      } else {
        chatFlavour = chatAllFlavours.find(f => f.id === val) || null;
      }

      state.endpoint = '/api/chat';
      state.model = 'upstage/solar-pro-3:free';
      state.connected = true;

      // Update header name quietly â€” no status toasts
      const label = chatFlavour ? `${chatFlavour.emoji} ${chatFlavour.name}` : 'VibeClaw Chat';
      $('peer-name').textContent = label;

      // Start a new session if none
      if (!state.currentSessionId) newSession();
    }

    // â”€â”€ Send message â”€â”€
    async function sendMessage() {
      const input = $('chat-input');
      const text = input.value.trim();
      if (!text || state.generating || !state.connected) return;

      input.value = '';
      input.style.height = 'auto';

      const userMsg = {
        id: crypto.randomUUID(),
        role: 'user',
        content: text,
        timestamp: Date.now(),
      };
      state.messages.push(userMsg);
      state.generating = true;
      renderMessages();

      // Cancel previous
      if (state.abortController) state.abortController.abort();
      state.abortController = new AbortController();

      try {
        const sysPrompt = (chatFlavour && chatFlavour.systemPrompt)
          ? chatFlavour.systemPrompt
          : 'You are a helpful coding assistant running in a browser sandbox. Be concise and helpful.';
        const chatMessages = [
          { role: 'system', content: sysPrompt },
          ...state.messages
            .filter(m => !m.error)
            .map(m => ({ role: m.role, content: m.content })),
        ];
        const body = {
          model: 'upstage/solar-pro-3:free',
          messages: chatMessages,
          max_tokens: 2048,
        };

        const resp = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: state.abortController.signal,
        });

        if (!resp.ok) {
          let errMsg = `Error ${resp.status}`;
          try { const e = await resp.json(); errMsg = e.error?.message || e.message || errMsg; } catch {}
          throw new Error(errMsg);
        }

        const data = await resp.json();
        const content = data.choices?.[0]?.message?.content || 'No response';
        const tokens = data.usage?.completion_tokens;

        state.messages.push({
          id: crypto.randomUUID(),
          role: 'assistant',
          content,
          timestamp: Date.now(),
          tokens,
          model: data.model,
        });

      } catch (err) {
        if (err.name === 'AbortError') return;
        state.messages.push({
          id: crypto.randomUUID(),
          role: 'assistant',
          content: err.message || 'Request failed',
          timestamp: Date.now(),
          error: true,
        });
      } finally {
        state.generating = false;
        state.abortController = null;
        renderMessages();
        saveCurrentSession();
      }
    }

    // â”€â”€ Event handlers â”€â”€
    $('connect-btn').addEventListener('click', connect);
    $('new-chat-btn').addEventListener('click', newSession);
    $('chat-send').addEventListener('click', sendMessage);

    $('chat-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-resize textarea
    $('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    $('endpoint-url').addEventListener('keydown', e => {
      if (e.key === 'Enter') connect();
    });

    // Auto-switch server when flavour changes
    $('chat-flavour-select').addEventListener('change', () => {
      connect();
      newSession();
    });

    // â”€â”€ Init â”€â”€
    state.sessions = loadSessions();
    renderSessions();
    renderMessages();

    // Auto-connect on page load
    setTimeout(() => connect(), 100);
  </script>

  <script src="/auth.js"></script>
  <script src="/features.js"></script>
  <script>
    VibeclawAuth.init().then(() => {
      VibeclawAuth.renderButton('auth-container');
      VibeclawFeatures.checkPro();
    });
  </script>
  <script src="/clawdio.js"></script>

</body>
</html>
