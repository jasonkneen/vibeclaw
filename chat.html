<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat — VibeClaw</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff5c5c' stroke-width='1.5'><path d='M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z'/></svg>" />
  <style>
    :root {
      --black: #0a0a0a;
      --surface: #141414;
      --surface-2: #1a1a1a;
      --border: #2a2a2a;
      --border-active: #3a3a3a;
      --text: #999;
      --text-dim: #666;
      --text-bright: #e0e0e0;
      --accent: #ff5c5c;
      --accent-bg: rgba(255,92,92,0.06);
      --green: #4ade80;
      --blue: #60a5fa;
      --sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --mono: 'IBM Plex Mono', 'JetBrains Mono', 'Fira Code', monospace;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: var(--black);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--accent); text-decoration: none; }

    /* ── Layout ── */
    .chat-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100vh;
    }

    /* ── Nav ── */
    .chat-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(10,10,10,0.9);
      backdrop-filter: blur(12px);
    }
    .chat-nav-brand {
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-bright);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chat-nav-links {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .chat-nav-links a {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .chat-nav-links a:hover { color: var(--text-bright); }

    /* ── Sidebar ── */
    .chat-sidebar {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      background: var(--surface);
      overflow: hidden;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-title {
      font-family: var(--mono);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
    }
    .btn-new-chat {
      background: none;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--mono);
      font-size: 0.65rem;
      transition: all 0.15s;
    }
    .btn-new-chat:hover { border-color: var(--accent); color: var(--accent); }

    .session-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .session-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 4px;
      border: 1px solid transparent;
    }
    .session-item:hover { background: var(--surface-2); }
    .session-item.active {
      background: var(--accent-bg);
      border-color: var(--accent);
    }
    .session-name {
      font-size: 0.8rem;
      color: var(--text-bright);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .session-preview {
      font-size: 0.7rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .session-meta {
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-top: 4px;
    }
    .session-delete {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 2px;
      margin-left: auto;
      transition: opacity 0.15s;
    }
    .session-item:hover .session-delete { opacity: 1; }
    .session-delete:hover { color: var(--accent); }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-dim);
      flex-shrink: 0;
    }
    .status-dot.online { background: var(--green); }

    .sidebar-empty {
      padding: 32px 16px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    /* ── Main chat ── */
    .chat-main {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Chat header ── */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--black);
    }
    .chat-peer-name {
      font-family: var(--sans);
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-bright);
    }
    .chat-peer-model {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .chat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--mono);
      font-size: 0.7rem;
      margin-left: auto;
    }
    .chat-status.connected { color: var(--green); }
    .chat-status.connecting { color: var(--text-dim); }
    .chat-status.offline { color: var(--text-dim); }

    /* ── Messages ── */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .msg {
      display: flex;
      gap: 12px;
      max-width: 80%;
    }
    .msg.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .msg.user .msg-avatar {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.15);
    }
    .msg.assistant .msg-avatar {
      background: var(--surface-2);
      border: 1px solid var(--border);
    }
    .msg-avatar svg {
      width: 12px;
      height: 12px;
      color: var(--text-dim);
    }
    .msg.user .msg-avatar svg { color: var(--accent); }

    .msg-body { min-width: 0; }
    .msg-bubble {
      border-radius: 14px;
      padding: 12px 16px;
      font-size: 0.85rem;
      line-height: 1.6;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .msg.user .msg-bubble {
      background: var(--accent-bg);
      border: 1px solid rgba(255,92,92,0.12);
      color: var(--text-bright);
      border-top-right-radius: 4px;
    }
    .msg.assistant .msg-bubble {
      background: transparent;
      color: var(--text);
      border-top-left-radius: 4px;
    }
    .msg.error .msg-bubble {
      background: rgba(244,67,54,0.06);
      border: 1px solid rgba(244,67,54,0.15);
      color: #f87171;
    }

    .msg-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      padding: 0 4px;
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-dim);
    }
    .msg.user .msg-meta { justify-content: flex-end; }

    .msg-action {
      opacity: 0;
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .msg:hover .msg-action { opacity: 1; }
    .msg-action:hover { color: var(--accent); background: var(--accent-bg); }

    /* Code blocks in messages */
    .msg-bubble pre {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 0.78rem;
      line-height: 1.5;
    }
    .msg-bubble code {
      font-family: var(--mono);
      font-size: 0.8rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1px 5px;
    }
    .msg-bubble pre code {
      background: none;
      border: none;
      padding: 0;
    }

    /* Streaming cursor */
    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 14px;
      background: var(--accent);
      opacity: 0.6;
      margin-left: 2px;
      animation: blink 1s step-end infinite;
      vertical-align: text-bottom;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Loading dots */
    .loading-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      padding: 4px 0;
    }
    .loading-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--text-dim);
      animation: dotPulse 1.4s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotPulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    /* ── Chat empty state ── */
    .chat-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      color: var(--text-dim);
    }
    .chat-empty svg { width: 40px; height: 40px; color: var(--border-active); }
    .chat-empty p { font-size: 0.85rem; }

    /* ── Input bar ── */
    .chat-input-bar {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .chat-input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .chat-input {
      flex: 1;
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-family: var(--sans);
      font-size: 0.85rem;
      color: var(--text-bright);
      outline: none;
      resize: none;
      max-height: 120px;
      line-height: 1.5;
    }
    .chat-input:focus { border-color: var(--accent); }
    .chat-input::placeholder { color: var(--text-dim); }
    .chat-input:disabled { opacity: 0.5; }
    .chat-send {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      cursor: pointer;
      color: #000;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-send:hover { background: #ff7070; }
    .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
    .chat-send svg { width: 16px; height: 16px; }

    /* ── Endpoint config bar ── */
    .endpoint-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      font-family: var(--mono);
      font-size: 0.7rem;
    }
    .endpoint-bar label { color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; white-space: nowrap; }
    .endpoint-bar input, .endpoint-bar select {
      background: var(--black);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--text-bright);
      outline: none;
    }
    .endpoint-bar input:focus, .endpoint-bar select:focus { border-color: var(--accent); }
    .endpoint-bar input { flex: 1; }
    .endpoint-connect {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s;
    }
    .endpoint-connect:hover { background: #ff7070; }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .chat-layout { grid-template-columns: 1fr; }
      .chat-sidebar { display: none; }
    }
  </style>
</head>
<body>

  <div class="chat-layout">
    <!-- Sidebar -->
    <div class="chat-sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">Sessions</span>
        <button class="btn-new-chat" id="new-chat-btn">+ New</button>
      </div>
      <div class="session-list" id="session-list">
        <div class="sidebar-empty" id="sidebar-empty">No sessions yet</div>
      </div>
    </div>

    <!-- Main -->
    <div class="chat-main">
      <!-- Endpoint config -->
      <div class="endpoint-bar">
        <label>Endpoint</label>
        <input type="text" id="endpoint-url" placeholder="http://localhost:18789 or mesh URL" value="" />
        <label>Model</label>
        <select id="endpoint-model">
          <option value="default">Default</option>
          <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek V3 (free)</option>
          <option value="qwen/qwen3-8b:free">Qwen3 8B (free)</option>
          <option value="google/gemma-3-4b-it:free">Gemma 3 4B (free)</option>
        </select>
        <button class="endpoint-connect" id="connect-btn">Connect</button>
      </div>

      <!-- Header -->
      <div class="chat-header">
        <div>
          <div class="chat-peer-name" id="peer-name">VibeClaw Chat</div>
          <div class="chat-peer-model" id="peer-model"></div>
        </div>
        <span id="auth-container" style="margin-left:auto;margin-right:16px;"></span>
        <div class="chat-status connecting" id="chat-status">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:14px;height:14px;"><circle cx="12" cy="12" r="10"/></svg>
          <span>Not connected</span>
        </div>
      </div>

      <!-- Messages -->
      <div class="chat-messages" id="chat-messages">
        <div class="chat-empty" id="chat-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
          <p>Connect to an endpoint to start chatting</p>
        </div>
      </div>

      <!-- Input -->
      <div class="chat-input-bar">
        <div class="chat-input-row">
          <textarea id="chat-input" class="chat-input" placeholder="Type a message..." rows="1" disabled></textarea>
          <button id="chat-send" class="chat-send" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ── State ──
    const state = {
      endpoint: '',
      model: 'default',
      connected: false,
      sessions: [],
      currentSessionId: null,
      messages: [],
      generating: false,
      abortController: null,
    };

    const $ = id => document.getElementById(id);
    const STORAGE_KEY = 'vibeclaw_chat_sessions';

    // ── Persistence ──
    function loadSessions() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    }
    function saveSessions() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.sessions.slice(0, 50)));
    }

    // ── Time formatting ──
    function relTime(ts) {
      const d = Date.now() - ts;
      if (d < 10000) return 'now';
      if (d < 60000) return Math.floor(d/1000) + 's';
      if (d < 3600000) return Math.floor(d/60000) + 'm';
      if (d < 86400000) return Math.floor(d/3600000) + 'h';
      return Math.floor(d/86400000) + 'd';
    }

    // ── Escape HTML ──
    function esc(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Simple markdown-ish rendering ──
    function renderContent(text) {
      let h = esc(text);
      // Code blocks
      h = h.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) =>
        `<pre><code>${code}</code></pre>`);
      // Inline code
      h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold
      h = h.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text-bright);">$1</strong>');
      return h;
    }

    // ── Render messages ──
    function renderMessages() {
      const container = $('chat-messages');
      const empty = $('chat-empty');

      if (state.messages.length === 0 && !state.generating) {
        empty.style.display = '';
        container.innerHTML = '';
        container.appendChild(empty);
        return;
      }

      empty.style.display = 'none';
      let html = '';

      for (const msg of state.messages) {
        const isUser = msg.role === 'user';
        const isError = msg.error;
        const cls = isUser ? 'user' : isError ? 'assistant error' : 'assistant';
        const avatarIcon = isUser
          ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0113 0"/></svg>'
          : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';

        const meta = [];
        if (msg.timestamp) meta.push(relTime(msg.timestamp));
        if (msg.tokens) meta.push(msg.tokens + ' tok');
        if (msg.model) meta.push(msg.model.split('/').pop().split(':')[0]);

        html += `<div class="msg ${cls}">
          <div class="msg-avatar">${avatarIcon}</div>
          <div class="msg-body">
            <div class="msg-bubble">${renderContent(msg.content)}</div>
            <div class="msg-meta">
              ${meta.join(' · ')}
              <button class="msg-action" onclick="copyMsg('${msg.id}')" title="Copy">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:10px;height:10px;"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              </button>
            </div>
          </div>
        </div>`;
      }

      // Streaming indicator
      if (state.generating) {
        html += `<div class="msg assistant">
          <div class="msg-avatar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <div class="msg-body">
            <div class="msg-bubble"><div class="loading-dots"><span></span><span></span><span></span></div></div>
          </div>
        </div>`;
      }

      container.innerHTML = html;
      container.scrollTop = container.scrollHeight;
    }

    // ── Copy message ──
    window.copyMsg = function(id) {
      const msg = state.messages.find(m => m.id === id);
      if (msg) navigator.clipboard.writeText(msg.content);
    };

    // ── Render sessions ──
    function renderSessions() {
      const list = $('session-list');
      const empty = $('sidebar-empty');

      if (state.sessions.length === 0) {
        list.innerHTML = '';
        list.appendChild(empty);
        empty.style.display = '';
        return;
      }

      empty.style.display = 'none';
      list.innerHTML = state.sessions.map((s, i) => {
        const lastUser = [...s.messages].reverse().find(m => m.role === 'user');
        const active = s.id === state.currentSessionId;
        const count = s.messages.filter(m => m.role !== 'system').length;
        return `<div class="session-item ${active ? 'active' : ''}" onclick="loadSession('${s.id}')">
          <div class="session-name">
            <span class="status-dot ${state.connected ? 'online' : ''}"></span>
            <span>${esc(s.name || 'Chat')}</span>
            <button class="session-delete" onclick="event.stopPropagation();deleteSession('${s.id}')" title="Delete">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:10px;height:10px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            </button>
          </div>
          ${lastUser ? `<div class="session-preview">"${esc(lastUser.content.slice(0,50))}"</div>` : ''}
          <div class="session-meta">${count} msg · ${relTime(s.updatedAt)}</div>
        </div>`;
      }).join('');
    }

    // ── Session management ──
    window.loadSession = function(id) {
      const session = state.sessions.find(s => s.id === id);
      if (!session) return;
      state.currentSessionId = id;
      state.messages = session.messages;
      renderMessages();
      renderSessions();
    };

    window.deleteSession = function(id) {
      state.sessions = state.sessions.filter(s => s.id !== id);
      saveSessions();
      if (state.currentSessionId === id) {
        state.currentSessionId = null;
        state.messages = [];
        renderMessages();
      }
      renderSessions();
    };

    function newSession() {
      const session = {
        id: crypto.randomUUID(),
        name: state.endpoint ? new URL(state.endpoint).host : 'Chat',
        messages: [],
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };
      state.sessions.unshift(session);
      state.currentSessionId = session.id;
      state.messages = [];
      saveSessions();
      renderSessions();
      renderMessages();
    }

    function saveCurrentSession() {
      if (!state.currentSessionId) return;
      const session = state.sessions.find(s => s.id === state.currentSessionId);
      if (session) {
        session.messages = state.messages;
        session.updatedAt = Date.now();
        saveSessions();
        renderSessions();
      }
    }

    // ── Connect ──
    function connect() {
      const url = $('endpoint-url').value.trim();
      if (!url) return;
      state.endpoint = url.replace(/\/$/, '');
      state.model = $('endpoint-model').value;
      state.connected = true;

      // Update UI
      const statusEl = $('chat-status');
      statusEl.className = 'chat-status connected';
      statusEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:14px;height:14px;"><path d="M5 12.55a11 11 0 0114.08 0"/><path d="M1.42 9a16 16 0 0121.16 0"/><path d="M8.53 16.11a6 6 0 016.95 0"/><circle cx="12" cy="20" r="1"/></svg>
      <span>Connected</span>`;

      $('peer-name').textContent = new URL(url).host;
      $('peer-model').textContent = state.model === 'default' ? '' : state.model;
      $('chat-input').disabled = false;
      $('chat-send').disabled = false;
      $('chat-input').focus();

      // Start a new session if none
      if (!state.currentSessionId) newSession();
    }

    // ── Send message ──
    async function sendMessage() {
      const input = $('chat-input');
      const text = input.value.trim();
      if (!text || state.generating || !state.connected) return;

      input.value = '';
      input.style.height = 'auto';

      const userMsg = {
        id: crypto.randomUUID(),
        role: 'user',
        content: text,
        timestamp: Date.now(),
      };
      state.messages.push(userMsg);
      state.generating = true;
      renderMessages();

      // Cancel previous
      if (state.abortController) state.abortController.abort();
      state.abortController = new AbortController();

      try {
        const endpoint = state.endpoint + '/v1/chat/completions';
        const body = {
          model: state.model === 'default' ? undefined : state.model,
          messages: state.messages
            .filter(m => !m.error)
            .map(m => ({ role: m.role, content: m.content })),
          max_tokens: 2048,
        };

        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: state.abortController.signal,
        });

        if (!resp.ok) {
          let errMsg = `Error ${resp.status}`;
          try { const e = await resp.json(); errMsg = e.error?.message || e.message || errMsg; } catch {}
          throw new Error(errMsg);
        }

        const data = await resp.json();
        const content = data.choices?.[0]?.message?.content || 'No response';
        const tokens = data.usage?.completion_tokens;

        state.messages.push({
          id: crypto.randomUUID(),
          role: 'assistant',
          content,
          timestamp: Date.now(),
          tokens,
          model: data.model,
        });

      } catch (err) {
        if (err.name === 'AbortError') return;
        state.messages.push({
          id: crypto.randomUUID(),
          role: 'assistant',
          content: err.message || 'Request failed',
          timestamp: Date.now(),
          error: true,
        });
      } finally {
        state.generating = false;
        state.abortController = null;
        renderMessages();
        saveCurrentSession();
      }
    }

    // ── Event handlers ──
    $('connect-btn').addEventListener('click', connect);
    $('new-chat-btn').addEventListener('click', newSession);
    $('chat-send').addEventListener('click', sendMessage);

    $('chat-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-resize textarea
    $('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    $('endpoint-url').addEventListener('keydown', e => {
      if (e.key === 'Enter') connect();
    });

    // ── Init ──
    state.sessions = loadSessions();
    renderSessions();
    renderMessages();

    // Check for server spec from forge
    const params = new URLSearchParams(location.search);
    if (params.has('endpoint')) {
      $('endpoint-url').value = params.get('endpoint');
      if (params.has('model')) {
        $('endpoint-model').value = params.get('model');
      }
      connect();
    }
  </script>

  <script src="/auth.js"></script>
  <script>
    VibeclawAuth.init().then(() => {
      VibeclawAuth.renderButton('auth-container');
    });
  </script>

</body>
</html>
